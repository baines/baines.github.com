var unitTesting=!1,curlevel=0,curlevelTarget=null,levelEditorOpened=!1;try{if(window.localStorage&&void 0!==localStorage[document.URL]){if(void 0!==localStorage[document.URL+"_checkpoint"]){var curlevelTarget=JSON.parse(localStorage[document.URL+"_checkpoint"]),arr=[],p;for(p in Object.getOwnPropertyNames(curlevelTarget.dat))arr[p]=curlevelTarget.dat[p];curlevelTarget.dat=new Int32Array(arr)}curlevel=localStorage[document.URL]}}catch(ex){}
var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,
2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]},level=initLevel;var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1;function stripTags(a){var b=document.createElement("div");b.innerHTML=a;return b.textContent||b.innerText||""}function consolePrint(a){}function consoleCacheDump(a){}function consoleError(a,b){var c=document.getElementById("errormessage");a=stripTags(a);c.innerHTML+=a+"<br>"}function logErrorNoLine(a){var b=document.getElementById("errormessage");a=stripTags(a);b.innerHTML+=a+"<br>"}
function logBetaMessage(a){var b=document.getElementById("errormessage");a=stripTags(a);b.innerHTML+=a+"<br>"}function clearInputHistory(){}function pushInput(a){};var font={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,
0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,
1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,
0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],
[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,
0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,
1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],
[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"\u00a3":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,
1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],
[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],
[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,
0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]]};/*
 Public Domain

 @example
 var rng = new RNG('Example');
 rng.random(40, 50);  // =>  42
 rng.uniform();       // =>  0.7972798995050903
 rng.normal();        // => -0.6698504543216376
 rng.exponential();   // =>  1.0547367609131555
 rng.poisson(4);      // =>  2
 rng.gamma(4);        // =>  2.781724687386858
*/
String.prototype.getBytes=function(){for(var a=[],b=0;b<this.length;b++){var c=this.charCodeAt(b),d=[];do d.push(c&255),c>>=8;while(0<c);a=a.concat(d.reverse())}return a};function RC4(a){this.s=Array(256);for(var b=this.j=this.i=0;256>b;b++)this.s[b]=b;a&&this.mix(a)}RC4.prototype._swap=function(a,b){var c=this.s[a];this.s[a]=this.s[b];this.s[b]=c};RC4.prototype.mix=function(a){a=a.getBytes();for(var b=0,c=0;c<this.s.length;c++)b+=this.s[c]+a[c%a.length],b%=256,this._swap(c,b)};
RC4.prototype.next=function(){this.i=(this.i+1)%256;this.j=(this.j+this.s[this.i])%256;this._swap(this.i,this.j);return this.s[(this.s[this.i]+this.s[this.j])%256]};function print_call_stack(){console.log(Error().stack)}
function RNG(a){this.seed=a;null==a?a=(Math.random()+Date.now()).toString():"function"===typeof a?(this.uniform=a,this.nextByte=function(){return~~(256*this.uniform())},a=null):"[object String]"!==Object.prototype.toString.call(a)&&(a=JSON.stringify(a));this._normal=null;this._state=a?new RC4(a):null}RNG.prototype.nextByte=function(){return this._state.next()};RNG.prototype.uniform=function(){for(var a=0,b=0;7>b;b++)a*=256,a+=this.nextByte();return a/(Math.pow(2,56)-1)};
RNG.prototype.random=function(a,b){if(null==a)return this.uniform();null==b&&(b=a,a=0);return a+Math.floor(this.uniform()*(b-a))};RNG.prototype.normal=function(){if(null!==this._normal){var a=this._normal;this._normal=null;return a}var a=this.uniform()||Math.pow(2,-53),b=this.uniform();this._normal=Math.sqrt(-2*Math.log(a))*Math.sin(2*Math.PI*b);return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*b)};RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))};
RNG.prototype.poisson=function(a){a=Math.exp(-(a||1));var b=0,c=1;do b++,c*=this.uniform();while(c>a);return b-1};RNG.prototype.gamma=function(a){var b=(1>a?1+a:a)-1/3,c=1/Math.sqrt(9*b);do{do var d=this.normal(),f=Math.pow(c*d+1,3);while(0>=f);var g=this.uniform(),d=Math.pow(d,2)}while(g>=1-0.0331*d*d&&Math.log(g)>=0.5*d+b*(1-f+Math.log(f)));return 1>a?b*f*Math.exp(this.exponential()/-a):b*f};
RNG.roller=function(a,b){var c=a.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),d=parseFloat(c[0])||1,f=parseFloat(c[1]),g=parseFloat(c[2])||0;b=b||new RNG;return function(){for(var a=d+g,c=0;c<d;c++)a+=b.random(f);return a}};var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];function FastBase64_Init(){for(var a=0;4096>a;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[a&63]}
function FastBase64_Encode(a){for(var b=a.length,c="",d=0;2<b;)n=a[d]<<16|a[d+1]<<8|a[d+2],c+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[n&4095],b-=3,d+=3;if(0<b){var f=(a[d]&252)>>2,g=(a[d]&3)<<4;1<b&&(g|=(a[++d]&240)>>4);c+=FastBase64_chars[f];c+=FastBase64_chars[g];2==b&&(f=(a[d++]&15)<<2,f|=(a[d]&192)>>6,c+=FastBase64_chars[f]);1==b&&(c+="=");c+="="}return c}FastBase64_Init();function u32ToArray(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}
function u16ToArray(a){return[a&255,a>>8&255]}
function MakeRiff(a,b,c){var d=[],f=[];a={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:b,subChunk2Id:[100,97,116,97],subChunk2Size:0};a.byteRate=a.sampleRate*a.numChannels*a.bitsPerSample>>3;a.blockAlign=a.numChannels*a.bitsPerSample>>3;a.subChunk2Size=c.length;a.chunkSize=36+a.subChunk2Size;d=a.chunkId.concat(u32ToArray(a.chunkSize),a.format,a.subChunk1Id,u32ToArray(a.subChunk1Size),
u16ToArray(a.audioFormat),u16ToArray(a.numChannels),u32ToArray(a.sampleRate),u32ToArray(a.byteRate),u16ToArray(a.blockAlign),u16ToArray(a.bitsPerSample),a.subChunk2Id,u32ToArray(a.subChunk2Size),c);f="data:audio/wav;base64,"+FastBase64_Encode(d);return{dat:[],wav:d,header:a,dataURI:f}}"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);var SOUND_VOL=0.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES="square sawtooth sine noise triangle breaker".split(" "),AUDIO_CONTEXT;"undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext);var masterVolume=1;
function Params(){var a={};a.wave_type=SQUARE;a.p_env_attack=0;a.p_env_sustain=0.3;a.p_env_punch=0;a.p_env_decay=0.4;a.p_base_freq=0.3;a.p_freq_limit=0;a.p_freq_ramp=0;a.p_freq_dramp=0;a.p_vib_strength=0;a.p_vib_speed=0;a.p_arp_mod=0;a.p_arp_speed=0;a.p_duty=0;a.p_duty_ramp=0;a.p_repeat_speed=0;a.p_pha_offset=0;a.p_pha_ramp=0;a.p_lpf_freq=1;a.p_lpf_ramp=0;a.p_lpf_resonance=0;a.p_hpf_freq=0;a.p_hpf_ramp=0;a.sound_vol=0.5;a.sample_rate=44100;a.bit_depth=8;return a}var rng,seeded=!1;
function frnd(a){return seeded?rng.uniform()*a:Math.random()*a}function rnd(a){return seeded?Math.floor(rng.uniform()*(a+1)):Math.floor(Math.random()*(a+1))}pickupCoin=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length));3===a.wave_type&&(a.wave_type=0);a.p_base_freq=0.4+frnd(0.5);a.p_env_attack=0;a.p_env_sustain=frnd(0.1);a.p_env_decay=0.1+frnd(0.4);a.p_env_punch=0.3+frnd(0.3);if(rnd(1)){a.p_arp_speed=0.5+frnd(0.2);var b=(frnd(7)|1)+1,c=b+(frnd(7)|1)+2;a.p_arp_mod=+b/+c}return a};
laserShoot=function(){var a=Params();a.wave_type=rnd(2);a.wave_type===SINE&&rnd(1)&&(a.wave_type=rnd(1));a.wave_type=Math.floor(frnd(SHAPES.length));3===a.wave_type&&(a.wave_type=SQUARE);a.p_base_freq=0.5+frnd(0.5);a.p_freq_limit=a.p_base_freq-0.2-frnd(0.6);0.2>a.p_freq_limit&&(a.p_freq_limit=0.2);a.p_freq_ramp=-0.15-frnd(0.2);0===rnd(2)&&(a.p_base_freq=0.3+frnd(0.6),a.p_freq_limit=frnd(0.1),a.p_freq_ramp=-0.35-frnd(0.3));rnd(1)?(a.p_duty=frnd(0.5),a.p_duty_ramp=frnd(0.2)):(a.p_duty=0.4+frnd(0.5),
a.p_duty_ramp=-frnd(0.7));a.p_env_attack=0;a.p_env_sustain=0.1+frnd(0.2);a.p_env_decay=frnd(0.4);rnd(1)&&(a.p_env_punch=frnd(0.3));0===rnd(2)&&(a.p_pha_offset=frnd(0.2),a.p_pha_ramp=-frnd(0.2));rnd(1)&&(a.p_hpf_freq=frnd(0.3));return a};
explosion=function(){var a=Params();rnd(1)?(a.p_base_freq=0.1+frnd(0.4),a.p_freq_ramp=-0.1+frnd(0.4)):(a.p_base_freq=0.2+frnd(0.7),a.p_freq_ramp=-0.2-frnd(0.2));a.p_base_freq*=a.p_base_freq;0===rnd(4)&&(a.p_freq_ramp=0);0===rnd(2)&&(a.p_repeat_speed=0.3+frnd(0.5));a.p_env_attack=0;a.p_env_sustain=0.1+frnd(0.3);a.p_env_decay=frnd(0.5);0===rnd(1)&&(a.p_pha_offset=-0.3+frnd(0.9),a.p_pha_ramp=-frnd(0.3));a.p_env_punch=0.2+frnd(0.6);rnd(1)&&(a.p_vib_strength=frnd(0.7),a.p_vib_speed=frnd(0.6));0===rnd(2)&&
(a.p_arp_speed=0.6+frnd(0.3),a.p_arp_mod=0.8-frnd(1.6));return a};
birdSound=function(){var a=Params();if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3===a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.4304400932967592+frnd(0.2)-0.1,a.p_env_sustain=0.15739346034252394+frnd(0.2)-0.1,a.p_env_punch=0.004488201744871758+frnd(0.2)-0.1,a.p_env_decay=0.07478075528212291+frnd(0.2)-0.1,a.p_base_freq=0.9865265720147687+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.2995018224359539+frnd(0.2)-0.1,0.5>frnd(1)&&(a.p_freq_ramp=0.1+frnd(0.15)),
a.p_freq_dramp=0.004598608156964473+frnd(0.1)-0.05,a.p_vib_strength=-0.2202799497929496+frnd(0.2)-0.1,a.p_vib_speed=0.8084998703158364+frnd(0.2)-0.1,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=-0.9031808754347107+frnd(0.2)-0.1,a.p_duty_ramp=-0.8128699999808343+frnd(0.2)-0.1,a.p_repeat_speed=0.601486018931999+frnd(0.2)-0.1,a.p_pha_offset=-0.9424902314367765+frnd(0.2)-0.1,a.p_pha_ramp=-0.1055482222272056+frnd(0.2)-0.1,a.p_lpf_freq=0.9989765717851521+frnd(0.2)-0.1,a.p_lpf_ramp=-0.25051720626043017+frnd(0.2)-
0.1,a.p_lpf_resonance=0.32777871505494693+frnd(0.2)-0.1,a.p_hpf_freq=0.0023548750981756753+frnd(0.2)-0.1,a.p_hpf_ramp=-0.002375673204842568+frnd(0.2)-0.1,a;if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3===a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.5277795946672003+frnd(0.2)-0.1,a.p_env_sustain=0.18243733568468432+frnd(0.2)-0.1,a.p_env_punch=-0.020159754546840117+frnd(0.2)-0.1,a.p_env_decay=0.1561353422051903+frnd(0.2)-0.1,a.p_base_freq=0.9028855606533718+frnd(0.2)-0.1,
a.p_freq_limit=-0.008842787837148716,a.p_freq_ramp=-0.1,a.p_freq_dramp=-0.012891241489551925,a.p_vib_strength=-0.17923136138403065+frnd(0.2)-0.1,a.p_vib_speed=0.908263385610142+frnd(0.2)-0.1,a.p_arp_mod=0.41690153355414894+frnd(0.2)-0.1,a.p_arp_speed=0.0010766233195860704+frnd(0.2)-0.1,a.p_duty=-0.8735363011184684+frnd(0.2)-0.1,a.p_duty_ramp=-0.7397985366747507+frnd(0.2)-0.1,a.p_repeat_speed=0.0591789344172107+frnd(0.2)-0.1,a.p_pha_offset=-0.9961184222777699+frnd(0.2)-0.1,a.p_pha_ramp=-0.08234769395850523+
frnd(0.2)-0.1,a.p_lpf_freq=0.9412475115697335+frnd(0.2)-0.1,a.p_lpf_ramp=-0.18261358925834958+frnd(0.2)-0.1,a.p_lpf_resonance=0.24541438107389477+frnd(0.2)-0.1,a.p_hpf_freq=-0.01831940280978611+frnd(0.2)-0.1,a.p_hpf_ramp=-0.03857383633171346+frnd(0.2)-0.1,a;if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3===a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.4304400932967592+frnd(0.2)-0.1,a.p_env_sustain=0.15739346034252394+frnd(0.2)-0.1,a.p_env_punch=0.004488201744871758+frnd(0.2)-
0.1,a.p_env_decay=0.07478075528212291+frnd(0.2)-0.1,a.p_base_freq=0.9865265720147687+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.2995018224359539+frnd(0.2)-0.1,a.p_freq_dramp=0.004598608156964473+frnd(0.2)-0.1,a.p_vib_strength=-0.2202799497929496+frnd(0.2)-0.1,a.p_vib_speed=0.8084998703158364+frnd(0.2)-0.1,a.p_arp_mod=-0.46410459213693644+frnd(0.2)-0.1,a.p_arp_speed=-0.10955361249587248+frnd(0.2)-0.1,a.p_duty=-0.9031808754347107+frnd(0.2)-0.1,a.p_duty_ramp=-0.8128699999808343+frnd(0.2)-
0.1,a.p_repeat_speed=0.7014860189319991+frnd(0.2)-0.1,a.p_pha_offset=-0.9424902314367765+frnd(0.2)-0.1,a.p_pha_ramp=-0.1055482222272056+frnd(0.2)-0.1,a.p_lpf_freq=0.9989765717851521+frnd(0.2)-0.1,a.p_lpf_ramp=-0.25051720626043017+frnd(0.2)-0.1,a.p_lpf_resonance=0.32777871505494693+frnd(0.2)-0.1,a.p_hpf_freq=0.0023548750981756753+frnd(0.2)-0.1,a.p_hpf_ramp=-0.002375673204842568+frnd(0.2)-0.1,a;if(1<frnd(5))return a.wave_type=Math.floor(frnd(SHAPES.length)),3===a.wave_type&&(a.wave_type=SQUARE),rnd(1)?
(a.p_arp_mod=0.2697849293151393+frnd(0.2)-0.1,a.p_arp_speed=-0.3131172257760948+frnd(0.2)-0.1,a.p_base_freq=0.8090588299313949+frnd(0.2)-0.1,a.p_duty=-0.6210022920964955+frnd(0.2)-0.1,a.p_duty_ramp=-4.3441813553182567E-4+frnd(0.2)-0.1,a.p_env_attack=0.004321877246874195+frnd(0.2)-0.1,a.p_env_decay=0.1+frnd(0.2)-0.1,a.p_env_punch=0.061737781504416146+frnd(0.2)-0.1,a.p_env_sustain=0.4987252564798832+frnd(0.2)-0.1,a.p_freq_dramp=0.31700340314222614+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=
-0.163380391341416+frnd(0.2)-0.1,a.p_hpf_freq=0.4709005021145149+frnd(0.2)-0.1,a.p_hpf_ramp=0.6924667290539194+frnd(0.2)-0.1,a.p_lpf_freq=0.8351398631384511+frnd(0.2)-0.1,a.p_lpf_ramp=0.36616557192873134+frnd(0.2)-0.1,a.p_lpf_resonance=-0.08685777111664439+frnd(0.2)-0.1,a.p_pha_offset=-0.036084571580025544+frnd(0.2)-0.1,a.p_pha_ramp=-0.014806445085568108+frnd(0.2)-0.1,a.p_repeat_speed=-0.8094368475518489+frnd(0.2)-0.1,a.p_vib_speed=0.4496665457171294+frnd(0.2)-0.1,a.p_vib_strength=0.23413762515532424+
frnd(0.2)-0.1):(a.p_arp_mod=-0.35697118026766184+frnd(0.2)-0.1,a.p_arp_speed=0.3581140690559588+frnd(0.2)-0.1,a.p_base_freq=1.3260897696157528+frnd(0.2)-0.1,a.p_duty=-0.30984900436710694+frnd(0.2)-0.1,a.p_duty_ramp=-0.0014374759133411626+frnd(0.2)-0.1,a.p_env_attack=0.3160357835682254+frnd(0.2)-0.1,a.p_env_decay=0.1+frnd(0.2)-0.1,a.p_env_punch=0.24323114016870148+frnd(0.2)-0.1,a.p_env_sustain=0.4+frnd(0.2)-0.1,a.p_freq_dramp=0.2866475886237244+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=
-0.10956352368742976+frnd(0.2)-0.1,a.p_hpf_freq=0.20772718017889846+frnd(0.2)-0.1,a.p_hpf_ramp=0.1564090637378835+frnd(0.2)-0.1,a.p_lpf_freq=0.6021372770637031+frnd(0.2)-0.1,a.p_lpf_ramp=0.24016227139979027+frnd(0.2)-0.1,a.p_lpf_resonance=-0.08787383821160144+frnd(0.2)-0.1,a.p_pha_offset=-0.381597686151701+frnd(0.2)-0.1,a.p_pha_ramp=-2.481687661373495E-4+frnd(0.2)-0.1,a.p_repeat_speed=0.07812112809425686+frnd(0.2)-0.1,a.p_vib_speed=-0.13648848579133943+frnd(0.2)-0.1,a.p_vib_strength=0.0018874158972302657+
frnd(0.2)-0.1),a;a.wave_type=Math.floor(frnd(SHAPES.length));if(1===a.wave_type||3===a.wave_type)a.wave_type=2;a.p_base_freq=0.85+frnd(0.15);a.p_freq_ramp=0.3+frnd(0.15);a.p_env_attack=0+frnd(0.09);a.p_env_sustain=0.2+frnd(0.3);a.p_env_decay=0+frnd(0.1);a.p_duty=frnd(2)-1;a.p_duty_ramp=Math.pow(frnd(2)-1,3);a.p_repeat_speed=0.5+frnd(0.1);a.p_pha_offset=-0.3+frnd(0.9);a.p_pha_ramp=-frnd(0.3);a.p_arp_speed=0.4+frnd(0.6);a.p_arp_mod=0.8+frnd(0.1);a.p_lpf_resonance=frnd(2)-1;a.p_lpf_freq=1-Math.pow(frnd(1),
3);a.p_lpf_ramp=Math.pow(frnd(2)-1,3);0.1>a.p_lpf_freq&&-0.05>a.p_lpf_ramp&&(a.p_lpf_ramp=-a.p_lpf_ramp);a.p_hpf_freq=Math.pow(frnd(1),5);a.p_hpf_ramp=Math.pow(frnd(2)-1,5);return a};
pushSound=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length));2===a.wave_type&&a.wave_type++;0===a.wave_type&&(a.wave_type=NOISE);a.p_base_freq=0.1+frnd(0.4);a.p_freq_ramp=0.05+frnd(0.2);a.p_env_attack=0.01+frnd(0.09);a.p_env_sustain=0.01+frnd(0.09);a.p_env_decay=0.01+frnd(0.09);a.p_repeat_speed=0.3+frnd(0.5);a.p_pha_offset=-0.3+frnd(0.9);a.p_pha_ramp=-frnd(0.3);a.p_arp_speed=0.6+frnd(0.3);a.p_arp_mod=0.8-frnd(1.6);return a};
powerUp=function(){var a=Params();rnd(1)?a.wave_type=SAWTOOTH:a.p_duty=frnd(0.6);a.wave_type=Math.floor(frnd(SHAPES.length));3===a.wave_type&&(a.wave_type=SQUARE);rnd(1)?(a.p_base_freq=0.2+frnd(0.3),a.p_freq_ramp=0.1+frnd(0.4),a.p_repeat_speed=0.4+frnd(0.4)):(a.p_base_freq=0.2+frnd(0.3),a.p_freq_ramp=0.05+frnd(0.2),rnd(1)&&(a.p_vib_strength=frnd(0.7),a.p_vib_speed=frnd(0.6)));a.p_env_attack=0;a.p_env_sustain=frnd(0.4);a.p_env_decay=0.1+frnd(0.4);return a};
hitHurt=function(){result=Params();result.wave_type=rnd(2);result.wave_type===SINE&&(result.wave_type=NOISE);result.wave_type===SQUARE&&(result.p_duty=frnd(0.6));result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=0.2+frnd(0.6);result.p_freq_ramp=-0.3-frnd(0.4);result.p_env_attack=0;result.p_env_sustain=frnd(0.1);result.p_env_decay=0.1+frnd(0.2);rnd(1)&&(result.p_hpf_freq=frnd(0.3));return result};
jump=function(){result=Params();result.wave_type=SQUARE;result.wave_type=Math.floor(frnd(SHAPES.length));3===result.wave_type&&(result.wave_type=SQUARE);result.p_duty=frnd(0.6);result.p_base_freq=0.3+frnd(0.3);result.p_freq_ramp=0.1+frnd(0.2);result.p_env_attack=0;result.p_env_sustain=0.1+frnd(0.3);result.p_env_decay=0.1+frnd(0.2);rnd(1)&&(result.p_hpf_freq=frnd(0.3));rnd(1)&&(result.p_lpf_freq=1-frnd(0.6));return result};
blipSelect=function(){result=Params();result.wave_type=rnd(1);result.wave_type=Math.floor(frnd(SHAPES.length));3===result.wave_type&&(result.wave_type=rnd(1));result.wave_type===SQUARE&&(result.p_duty=frnd(0.6));result.p_base_freq=0.2+frnd(0.4);result.p_env_attack=0;result.p_env_sustain=0.1+frnd(0.1);result.p_env_decay=frnd(0.2);result.p_hpf_freq=0.1;return result};
random=function(){result=Params();result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=Math.pow(frnd(2)-1,2);rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+0.5);result.p_freq_limit=0;result.p_freq_ramp=Math.pow(frnd(2)-1,5);0.7<result.p_base_freq&&0.2<result.p_freq_ramp&&(result.p_freq_ramp=-result.p_freq_ramp);0.2>result.p_base_freq&&-0.05>result.p_freq_ramp&&(result.p_freq_ramp=-result.p_freq_ramp);result.p_freq_dramp=Math.pow(frnd(2)-1,3);result.p_duty=frnd(2)-1;result.p_duty_ramp=
Math.pow(frnd(2)-1,3);result.p_vib_strength=Math.pow(frnd(2)-1,3);result.p_vib_speed=frnd(2)-1;result.p_env_attack=Math.pow(frnd(2)-1,3);result.p_env_sustain=Math.pow(frnd(2)-1,2);result.p_env_decay=frnd(2)-1;result.p_env_punch=Math.pow(frnd(0.8),2);0.2>result.p_env_attack+result.p_env_sustain+result.p_env_decay&&(result.p_env_sustain+=0.2+frnd(0.3),result.p_env_decay+=0.2+frnd(0.3));result.p_lpf_resonance=frnd(2)-1;result.p_lpf_freq=1-Math.pow(frnd(1),3);result.p_lpf_ramp=Math.pow(frnd(2)-1,3);0.1>
result.p_lpf_freq&&-0.05>result.p_lpf_ramp&&(result.p_lpf_ramp=-result.p_lpf_ramp);result.p_hpf_freq=Math.pow(frnd(1),5);result.p_hpf_ramp=Math.pow(frnd(2)-1,5);result.p_pha_offset=Math.pow(frnd(2)-1,3);result.p_pha_ramp=Math.pow(frnd(2)-1,3);result.p_repeat_speed=frnd(2)-1;result.p_arp_speed=frnd(2)-1;result.p_arp_mod=frnd(2)-1;return result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames="pickupCoin laserShoot explosion powerUp hitHurt jump blipSelect pushSound random birdSound".split(" ");
generateFromSeed=function(a){rng=new RNG(a/100|0);var b=generators[a%100%generators.length];seeded=!0;b=b();b.seed=a;seeded=!1;return b};function SoundEffect(a,b){this._buffer=AUDIO_CONTEXT.createBuffer(1,a,b)}SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)};
SoundEffect.prototype.play=function(){var a=AUDIO_CONTEXT.createBufferSource(),b=AUDIO_CONTEXT.createBiquadFilter(),c=AUDIO_CONTEXT.createBiquadFilter(),d=AUDIO_CONTEXT.createBiquadFilter();a.buffer=this._buffer;a.connect(b);b.frequency.value=1600;c.frequency.value=1600;d.frequency.value=1600;b.connect(c);c.connect(d);d.connect(AUDIO_CONTEXT.destination);b=AUDIO_CONTEXT.currentTime;"undefined"!=typeof a.start?a.start(b):a.noteOn(b)};SoundEffect.MIN_SAMPLE_RATE=22050;
"undefined"==typeof AUDIO_CONTEXT&&(SoundEffect=function(a,b){this._sample_rate=b;this._buffer=Array(a);this._audioElement=null},SoundEffect.prototype.getBuffer=function(){this._audioElement=null;return this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var a=0;a<this._buffer.length;a++)this._buffer[a]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[a]+1,2)));a=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=
new Audio;this._audioElement.src=a.dataURI;this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1);
SoundEffect.generate=function(a){function b(){c=0;d=100/(a.p_base_freq*a.p_base_freq+0.001);f=Math.floor(d);g=100/(a.p_freq_limit*a.p_freq_limit+0.001);h=1-0.01*Math.pow(a.p_freq_ramp,3);k=1E-6*-Math.pow(a.p_freq_dramp,3);q=0.5-0.5*a.p_duty;m=5E-5*-a.p_duty_ramp;v=0<=a.p_arp_mod?1-0.9*Math.pow(a.p_arp_mod,2):1+10*Math.pow(a.p_arp_mod,2);A=Math.floor(2E4*Math.pow(1-a.p_arp_speed,2)+32);1==a.p_arp_speed&&(A=0)}var c,d,f,g,h,k,q,m,v,A;b();var B=0,F=0,J=0.1*Math.pow(a.p_lpf_freq,3),C=1+1E-4*a.p_lpf_ramp,
w=5/(1+20*Math.pow(a.p_lpf_resonance,2))*(0.01+J);0.8<w&&(w=0.8);var l=0,r=0.1*Math.pow(a.p_hpf_freq,2),H=1+3E-4*a.p_hpf_ramp,s=0,K=0.01*Math.pow(a.p_vib_speed,2),W=0.5*a.p_vib_strength,X=0,P=0,Y=0,R=[Math.floor(a.p_env_attack*a.p_env_attack*1E5),Math.floor(a.p_env_sustain*a.p_env_sustain*1E5),Math.floor(a.p_env_decay*a.p_env_decay*1E5)],ea=R[0]+R[1]+R[2],ja=0,sa=1020*Math.pow(a.p_pha_offset,2);0>a.p_pha_offset&&(sa=-sa);var nb=1*Math.pow(a.p_pha_ramp,2);0>a.p_pha_ramp&&(nb=-nb);for(var ua=Math.abs(Math.floor(sa)),
Pa=0,Xa=[],L=0;1024>L;++L)Xa[L]=0;for(var T=[],L=0;32>L;++L)T[L]=2*Math.random()-1;var ka=Math.floor(2E4*Math.pow(1-a.p_repeat_speed,2)+32);0==a.p_repeat_speed&&(ka=0);var va=2*a.sound_vol,va=Math.exp(a.sound_vol)-1,G=0,Qa=0,Ka=Math.floor(44100/a.sample_rate),ga=0,ea=Math.ceil(ea/Ka),ob=!1,pb;pb=a.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*ea,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(ea,a.sample_rate);for(var Aa=pb.getBuffer(),Cb=0;;++Cb){0!=ka&&++c>=ka&&b();0!=A&&Cb>=A&&(A=0,d*=
v);h+=k;d*=h;d>g&&(d=g,0<a.p_freq_limit&&(ob=!0));ua=d;0<W&&(s+=K,ua=d*(1+Math.sin(s)*W));f=Math.floor(ua);8>f&&(f=8);q+=m;0>q&&(q=0);0.5<q&&(q=0.5);Y++;Y>R[P]&&(Y=0,P++,3===P&&(ob=!0));X=0===P?Y/R[0]:1===P?1+2*Math.pow(1-Y/R[1],1)*a.p_env_punch:1-Y/R[2];sa+=nb;ua=Math.abs(Math.floor(sa));1023<ua&&(ua=1023);0!=H&&(r*=H,1E-5>r&&(r=1E-5),0.1<r&&(r=0.1));for(var S=0,Ya=0;8>Ya;++Ya){L=0;ja++;if(ja>=f&&(ja%=f,a.wave_type===NOISE))for(L=0;32>L;++L)T[L]=2*Math.random()-1;L=ja/f;if(a.wave_type===SQUARE)L=
L<q?0.5:-0.5;else if(a.wave_type===SAWTOOTH)L=1-2*L;else if(a.wave_type===SINE)L=Math.sin(2*L*Math.PI);else if(a.wave_type===NOISE)L=T[Math.floor(32*ja/f)];else if(a.wave_type===TRIANGLE)L=Math.abs(1-2*L)-1;else if(a.wave_type===BREAKER)L=Math.abs(1-L*L*2)-1;else throw new Exception("bad wave type! "+a.wave_type);var cc=B,J=J*C;0>J&&(J=0);0.1<J&&(J=0.1);1!=a.p_lpf_freq?(F+=(L-B)*J,F-=F*w):(B=L,F=0);B+=F;l+=B-cc;L=l-=l*r;Xa[Pa&1023]=L;L+=Xa[Pa-ua+1024&1023];Pa=Pa+1&1023;S+=L*X}G+=S;if(++Qa>=Ka&&(Qa=
0,S=G/Ka,G=0,S=S/8*masterVolume,S*=va,Aa[ga++]=S,a.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(Aa[ga++]=S,Aa[ga++]=S,Aa[ga++]=S),ob)){for(;ga<ea;ga++)a.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(Aa[ga++]=0,Aa[ga++]=0,Aa[ga++]=0),Aa[ga]=0;break}}return pb};if("undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params;exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;
function cacheSeed(a){if(a in sfxCache)return sfxCache[a];var b=generateFromSeed(a);b.sound_vol=SOUND_VOL;b.sample_rate=SAMPLE_RATE;b.bit_depth=BIT_DEPTH;b=SoundEffect.generate(b);sfxCache[a]=b;for(cachedSeeds.push(a);cachedSeeds.length>CACHE_MAX;)a=cachedSeeds[0],cachedSeeds=cachedSeeds.slice(1),delete sfxCache[a];return b}function playSound(a){unitTesting||cacheSeed(a).play()};(function(a){if("object"==typeof exports&&"object"==typeof module)module.exports=a();else{if("function"==typeof define&&define.amd)return define([],a);this.CodeMirror=a()}})(function(){function a(e,t){if(!(this instanceof a))return new a(e,t);this.options=t=t||{};for(var u in zd)t.hasOwnProperty(u)||(t[u]=zd[u]);B(t);var z=t.value;"string"==typeof z&&(z=new la(z,t.mode));this.doc=z;var Z=this.display=new b(e,z);Z.wrapper.CodeMirror=this;m(this);k(this);t.lineWrapping&&(this.display.wrapper.className+=
" CodeMirror-wrap");t.autofocus&&!Pc&&oa(this);this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,draggingText:!1,highlight:new Qc};wa&&setTimeout(Ba(Ca,this,!0),20);Le(this);var c=this;La(this,function(){c.curOp.forceUpdate=!0;Ad(c,z);t.autofocus&&!Pc||Ra()==Z.input?setTimeout(Ba(Rc,c),20):Sc(c);for(var e in qb)if(qb.hasOwnProperty(e))qb[e](c,t[e],Bd);for(e=0;e<Tc.length;++e)Tc[e](c)})}function b(e,t){var a=this.input=I("textarea",
null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none");qa?a.style.width="1000px":a.setAttribute("wrap","off");Db&&(a.style.border="1px solid black");a.setAttribute("autocorrect","off");a.setAttribute("autocapitalize","off");a.setAttribute("spellcheck","false");this.inputDiv=I("div",[a],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");this.scrollbarH=I("div",[I("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");this.scrollbarV=
I("div",[I("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar");this.scrollbarFiller=I("div",null,"CodeMirror-scrollbar-filler");this.gutterFiller=I("div",null,"CodeMirror-gutter-filler");this.lineDiv=I("div",null,"CodeMirror-code");this.selectionDiv=I("div",null,null,"position: relative; z-index: 1");this.cursorDiv=I("div",null,"CodeMirror-cursors");this.measure=I("div",null,"CodeMirror-measure");this.lineMeasure=I("div",null,"CodeMirror-measure");this.lineSpace=I("div",[this.measure,this.lineMeasure,
this.selectionDiv,this.cursorDiv,this.lineDiv],null,"position: relative; outline: none");this.mover=I("div",[I("div",[this.lineSpace],"CodeMirror-lines")],null,"position: relative");this.sizer=I("div",[this.mover],"CodeMirror-sizer");this.heightForcer=I("div",null,null,"position: absolute; height: "+Ma+"px; width: 1px;");this.gutters=I("div",null,"CodeMirror-gutters");this.lineGutter=null;this.scroller=I("div",[this.sizer,this.heightForcer,this.gutters],"CodeMirror-scroll");this.scroller.setAttribute("tabIndex",
"-1");this.wrapper=I("div",[this.inputDiv,this.scrollbarH,this.scrollbarV,this.scrollbarFiller,this.gutterFiller,this.scroller],"CodeMirror");Eb&&(this.gutters.style.zIndex=-1,this.scroller.style.paddingRight=0);Db&&(a.style.width="0px");qa||(this.scroller.draggable=!0);Uc&&(this.inputDiv.style.height="1px",this.inputDiv.style.position="absolute");Eb&&(this.scrollbarH.style.minHeight=this.scrollbarV.style.minWidth="18px");e.appendChild?e.appendChild(this.wrapper):e(this.wrapper);this.viewFrom=this.viewTo=
t.first;this.view=[];this.externalMeasured=null;this.lastSizeC=this.viewOffset=0;this.lineNumWidth=this.lineNumInnerWidth=this.lineNumChars=this.updateLineNumbers=null;this.prevInput="";this.pollingFast=this.alignWidgets=!1;this.poll=new Qc;this.cachedCharWidth=this.cachedTextHeight=this.cachedPaddingH=null;this.inaccurateSelection=!1;this.maxLine=null;this.maxLineLength=0;this.maxLineChanged=!1;this.wheelDX=this.wheelDY=this.wheelStartX=this.wheelStartY=null;this.shift=!1}function c(e){e.doc.mode=
a.getMode(e.options,e.doc.modeOption);d(e)}function d(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null);e.styles&&(e.styles=null)});e.doc.frontier=e.doc.first;Fb(e,100);e.state.modeGen++;e.curOp&&ta(e)}function f(e){var t=Za(e.display),a=e.options.lineWrapping,z=a&&Math.max(5,e.display.scroller.clientWidth/Gb(e.display)-3);return function(Z){if($a(e.doc,Z))return 0;var b=0;if(Z.widgets)for(var c=0;c<Z.widgets.length;c++)Z.widgets[c].height&&(b+=Z.widgets[c].height);return a?b+(Math.ceil(Z.text.length/
z)||1)*t:b+t}}function g(e){var t=e.doc,a=f(e);t.iter(function(e){var t=a(e);t!=e.height&&Da(e,t)})}function h(e){var t=Na[e.options.keyMap].style;e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(t?" cm-keymap-"+t:"")}function k(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-");Hb(e)}function q(e){m(e);ta(e);setTimeout(function(){w(e)},20)}function m(e){var t=e.display.gutters,
a=e.options.gutters;ab(t);for(var z=0;z<a.length;++z){var b=a[z],c=t.appendChild(I("div",null,"CodeMirror-gutter "+b));"CodeMirror-linenumbers"==b&&(e.display.lineGutter=c,c.style.width=(e.display.lineNumWidth||1)+"px")}t.style.display=z?"":"none";t=t.offsetWidth;e.display.sizer.style.marginLeft=t+"px";z&&(e.display.scrollbarH.style.left=e.options.fixedGutter?t+"px":0)}function v(e){if(0==e.height)return 0;for(var t=e.text.length,a,z=e;a=bb(z,!0);)a=a.find(0,!0),z=a.from.line,t+=a.from.ch-a.to.ch;
for(z=e;a=bb(z,!1);)a=a.find(0,!0),t-=z.text.length-a.from.ch,z=a.to.line,t+=z.text.length-a.to.ch;return t}function A(e){var t=e.display;e=e.doc;t.maxLine=E(e,e.first);t.maxLineLength=v(t.maxLine);t.maxLineChanged=!0;e.iter(function(e){var a=v(e);a>t.maxLineLength&&(t.maxLineLength=a,t.maxLine=e)})}function B(e){var t=ha(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):-1<t&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,
1))}function F(e){var t=e.display.scroller;return{clientHeight:t.clientHeight,barHeight:e.display.scrollbarV.clientHeight,scrollWidth:t.scrollWidth,clientWidth:t.clientWidth,barWidth:e.display.scrollbarH.clientWidth,docHeight:Math.round(e.doc.height+Cd(e.display))}}function J(e,t){t||(t=F(e));var a=e.display,z=t.docHeight+Ma,b=t.scrollWidth>t.clientWidth,c=z>t.clientHeight;c?(a.scrollbarV.style.display="block",a.scrollbarV.style.bottom=b?Ib(a.measure)+"px":"0",a.scrollbarV.firstChild.style.height=
Math.max(0,z-t.clientHeight+(t.barHeight||a.scrollbarV.clientHeight))+"px"):(a.scrollbarV.style.display="",a.scrollbarV.firstChild.style.height="0");b?(a.scrollbarH.style.display="block",a.scrollbarH.style.right=c?Ib(a.measure)+"px":"0",a.scrollbarH.firstChild.style.width=t.scrollWidth-t.clientWidth+(t.barWidth||a.scrollbarH.clientWidth)+"px"):(a.scrollbarH.style.display="",a.scrollbarH.firstChild.style.width="0");b&&c?(a.scrollbarFiller.style.display="block",a.scrollbarFiller.style.height=a.scrollbarFiller.style.width=
Ib(a.measure)+"px"):a.scrollbarFiller.style.display="";b&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(a.gutterFiller.style.display="block",a.gutterFiller.style.height=Ib(a.measure)+"px",a.gutterFiller.style.width=a.gutters.offsetWidth+"px"):a.gutterFiller.style.display="";Me&&0===Ib(a.measure)&&(a.scrollbarV.style.minWidth=a.scrollbarH.style.minHeight=Ne?"18px":"12px",z=function(t){(t.target||t.srcElement)!=a.scrollbarV&&(t.target||t.srcElement)!=a.scrollbarH&&ca(e,Dd)(t)},N(a.scrollbarV,
"mousedown",z),N(a.scrollbarH,"mousedown",z))}function C(e,t,a){var z=a&&null!=a.top?a.top:e.scroller.scrollTop,z=Math.floor(z-e.lineSpace.offsetTop),b=a&&null!=a.bottom?a.bottom:z+e.wrapper.clientHeight,z=cb(t,z),b=cb(t,b);if(a&&a.ensure){var c=a.ensure.from.line;a=a.ensure.to.line;if(c<z)return{from:c,to:cb(t,Ea(E(t,c))+e.wrapper.clientHeight)};if(Math.min(a,t.lastLine())>=b)return{from:cb(t,Ea(E(t,a))-e.wrapper.clientHeight),to:a}}return{from:z,to:b}}function w(e){var t=e.display,a=t.view;if(t.alignWidgets||
t.gutters.firstChild&&e.options.fixedGutter){for(var z=r(t)-t.scroller.scrollLeft+e.doc.scrollLeft,b=t.gutters.offsetWidth,c=z+"px",d=0;d<a.length;d++)if(!a[d].hidden){e.options.fixedGutter&&a[d].gutter&&(a[d].gutter.style.left=c);var f=a[d].alignable;if(f)for(var g=0;g<f.length;g++)f[g].style.left=c}e.options.fixedGutter&&(t.gutters.style.left=z+b+"px")}}function l(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function r(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}
function H(e,t,a){for(var z=e.display.viewFrom,b=e.display.viewTo,c,d=C(e.display,e.doc,t),f=!0;;f=!1){var g=e.display.scroller.clientWidth,O;O=e;var h=d,k=a;a=O.display;var U=O.doc;if(a.wrapper.offsetWidth)if(!k&&h.from>=a.viewFrom&&h.to<=a.viewTo&&0==Ed(O))O=void 0;else{var q;q=O;if(q.options.lineNumbers){var m=q.doc,r=l(q.options,m.first+m.size-1),m=q.display;if(r.length!=m.lineNumChars){var w=m.measure.appendChild(I("div",[I("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),v=w.firstChild.offsetWidth,
w=w.offsetWidth-v;m.lineGutter.style.width="";m.lineNumInnerWidth=Math.max(v,m.lineGutter.offsetWidth-w);m.lineNumWidth=m.lineNumInnerWidth+w;m.lineNumChars=m.lineNumInnerWidth?r.length:-1;m.lineGutter.style.width=m.lineNumWidth+"px";r=m.gutters.offsetWidth;m.scrollbarH.style.left=q.options.fixedGutter?r+"px":0;m.sizer.style.marginLeft=r+"px";q=!0}else q=!1}else q=!1;q&&Sa(O);q=K(O);v=U.first+U.size;m=Math.max(h.from-O.options.viewportMargin,U.first);r=Math.min(v,h.to+O.options.viewportMargin);a.viewFrom<
m&&20>m-a.viewFrom&&(m=Math.max(U.first,a.viewFrom));a.viewTo>r&&20>a.viewTo-r&&(r=Math.min(v,a.viewTo));Ta&&(m=Vc(O.doc,m),r=Fd(O.doc,r));h=m!=a.viewFrom||r!=a.viewTo||a.lastSizeC!=a.wrapper.clientHeight;U=O;v=U.display;0==v.view.length||m>=v.viewTo||r<=v.viewFrom?(v.view=ec(U,m,r),v.viewFrom=m):(v.viewFrom>m?v.view=ec(U,m,v.viewFrom).concat(v.view):v.viewFrom<m&&(v.view=v.view.slice(Jb(U,m))),v.viewFrom=m,v.viewTo<r?v.view=v.view.concat(ec(U,v.viewTo,r)):v.viewTo>r&&(v.view=v.view.slice(0,Jb(U,
r))));v.viewTo=r;a.viewOffset=Ea(E(O.doc,a.viewFrom));O.display.mover.style.top=a.viewOffset+"px";U=Ed(O);if(h||0!=U||k){k=Ra();4<U&&(a.lineDiv.style.display="none");W(O,a.updateLineNumbers,q);4<U&&(a.lineDiv.style.display="");k&&Ra()!=k&&k.offsetHeight&&k.focus();ab(a.cursorDiv);ab(a.selectionDiv);h&&(a.lastSizeC=a.wrapper.clientHeight,Fb(O,400));O=O.display;a=O.lineDiv.offsetTop;for(k=0;k<O.view.length;k++)if(h=O.view[k],!h.hidden&&(Eb?(q=h.node.offsetTop+h.node.offsetHeight,U=q-a,a=q):(U=h.node.getBoundingClientRect(),
U=U.bottom-U.top),q=h.line.height-U,2>U&&(U=Za(O)),0.001<q||-0.001>q))if(Da(h.line,U),s(h.line),h.rest)for(U=0;U<h.rest.length;U++)s(h.rest[U]);O=!0}else O=void 0}else Sa(O),O=void 0;if(!O)break;c=!0;e.display.maxLineChanged&&!e.options.lineWrapping&&(O=e,a=O.display,k=a.maxLine.text.length,k=Wc(O,fc(O,a.maxLine),k,void 0).left,a.maxLineChanged=!1,k=Math.max(0,k+3),h=Math.max(0,a.sizer.offsetLeft+k+Ma-a.scroller.clientWidth),a.sizer.style.minWidth=k+"px",h<O.doc.scrollLeft&&rb(O,Math.min(a.scroller.scrollLeft,
h),!0));O=F(e);Xc(e);a=e;k=O;a.display.sizer.style.minHeight=a.display.heightForcer.style.top=k.docHeight+"px";a.display.gutters.style.height=Math.max(k.docHeight,k.clientHeight-Ma)+"px";J(e,O);if(f&&e.options.lineWrapping&&g!=e.display.scroller.clientWidth)a=!0;else if(a=!1,t&&null!=t.top&&(t={top:Math.min(O.docHeight-Ma-O.clientHeight,t.top)}),d=C(e.display,e.doc,t),d.from>=e.display.viewFrom&&d.to<=e.display.viewTo)break}e.display.updateLineNumbers=null;c&&(da(e,"update",e),e.display.viewFrom==
z&&e.display.viewTo==b||da(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo));return c}function s(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.offsetHeight}function K(e){for(var t=e.display,a={},z={},b=t.gutters.firstChild,c=0;b;b=b.nextSibling,++c)a[e.options.gutters[c]]=b.offsetLeft,z[e.options.gutters[c]]=b.offsetWidth;return{fixedPos:r(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:a,gutterWidth:z,wrapperWidth:t.wrapper.clientWidth}}function W(e,
t,a){function z(t){var a=t.nextSibling;qa&&sb&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t);return a}for(var b=e.display,c=e.options.lineNumbers,d=b.lineDiv,f=d.firstChild,g=b.view,b=b.viewFrom,h=0;h<g.length;h++){var k=g[h];if(!k.hidden)if(k.node){for(;f!=k.node;)f=z(f);f=c&&null!=t&&t<=b&&k.lineNumber;k.changes&&(-1<ha(k.changes,"gutter")&&(f=!1),X(e,k,b,a));f&&(ab(k.lineNumber),k.lineNumber.appendChild(document.createTextNode(l(e.options,b))));f=k.node.nextSibling}else{var q=
ja(e,k,b,a);d.insertBefore(q,f)}b+=k.size}for(;f;)f=z(f)}function X(e,t,a,z){for(var b=0;b<t.changes.length;b++){var c=t.changes[b];if("text"==c){var c=t,d=c.text.className,f=Y(e,c);c.text==c.node&&(c.node=f.pre);c.text.parentNode.replaceChild(f.pre,c.text);c.text=f.pre;f.bgClass!=c.bgClass||f.textClass!=c.textClass?(c.bgClass=f.bgClass,c.textClass=f.textClass,R(c)):d&&(c.text.className=d)}else if("gutter"==c)ea(e,t,a,z);else if("class"==c)R(t);else if("widget"==c){c=t;d=z;c.alignable&&(c.alignable=
null);for(var f=c.node.firstChild,g=void 0;f;f=g)g=f.nextSibling,"CodeMirror-linewidget"==f.className&&c.node.removeChild(f);sa(c,d)}}t.changes=null}function P(e){e.node==e.text&&(e.node=I("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),Eb&&(e.node.style.zIndex=2));return e.node}function Y(e,t){var a=e.display.externalMeasured;return a&&a.line==t.line?(e.display.externalMeasured=null,t.measure=a.measure,a.built):Gd(e,
t)}function R(e){var t=e.bgClass?e.bgClass+" "+(e.line.bgClass||""):e.line.bgClass;t&&(t+=" CodeMirror-linebackground");if(e.background)t?e.background.className=t:(e.background.parentNode.removeChild(e.background),e.background=null);else if(t){var a=P(e);e.background=a.insertBefore(I("div",null,t),a.firstChild)}e.line.wrapClass?P(e).className=e.line.wrapClass:e.node!=e.text&&(e.node.className="");e.text.className=(e.textClass?e.textClass+" "+(e.line.textClass||""):e.line.textClass)||""}function ea(e,
t,a,z){t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null);var b=t.line.gutterMarkers;if(e.options.lineNumbers||b){var c=P(t),c=t.gutter=c.insertBefore(I("div",null,"CodeMirror-gutter-wrapper","position: absolute; left: "+(e.options.fixedGutter?z.fixedPos:-z.gutterTotalWidth)+"px"),t.text);!e.options.lineNumbers||b&&b["CodeMirror-linenumbers"]||(t.lineNumber=c.appendChild(I("div",l(e.options,a),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+z.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+
e.display.lineNumInnerWidth+"px")));if(b)for(t=0;t<e.options.gutters.length;++t){a=e.options.gutters[t];var d=b.hasOwnProperty(a)&&b[a];d&&c.appendChild(I("div",[d],"CodeMirror-gutter-elt","left: "+z.gutterLeft[a]+"px; width: "+z.gutterWidth[a]+"px"))}}}function ja(e,t,a,z){var b=Y(e,t);t.text=t.node=b.pre;b.bgClass&&(t.bgClass=b.bgClass);b.textClass&&(t.textClass=b.textClass);R(t);ea(e,t,a,z);sa(t,z);return t.node}function sa(e,t){nb(e.line,e,t,!0);if(e.rest)for(var a=0;a<e.rest.length;a++)nb(e.rest[a],
e,t,!1)}function nb(e,t,a,z){if(e.widgets){var b=P(t),c=0;for(e=e.widgets;c<e.length;++c){var d=e[c],f=I("div",[d.node],"CodeMirror-linewidget");d.handleMouseEvents||(f.ignoreEvents=!0);var g=d,k=f,h=a;if(g.noHScroll){(t.alignable||(t.alignable=[])).push(k);var l=h.wrapperWidth;k.style.left=h.fixedPos+"px";g.coverGutter||(l-=h.gutterTotalWidth,k.style.paddingLeft=h.gutterTotalWidth+"px");k.style.width=l+"px"}g.coverGutter&&(k.style.zIndex=5,k.style.position="relative",g.noHScroll||(k.style.marginLeft=
-h.gutterTotalWidth+"px"));z&&d.above?b.insertBefore(f,t.gutter||t.text):b.appendChild(f);da(d,"redraw")}}}function ua(e){return D(e.line,e.ch)}function Pa(e,t){return 0>Q(e,t)?t:e}function Xa(e,t){return 0>Q(e,t)?e:t}function L(e,t){this.ranges=e;this.primIndex=t}function T(e,t){this.anchor=e;this.head=t}function ka(e,t){var a=e[t];e.sort(function(e,a){return Q(e.from(),a.from())});t=ha(e,a);for(a=1;a<e.length;a++){var z=e[a],b=e[a-1];if(0<=Q(b.to(),z.from())){var c=Xa(b.from(),z.from()),d=Pa(b.to(),
z.to()),z=b.empty()?z.from()==z.head:b.from()==b.head;a<=t&&--t;e.splice(--a,2,new T(z?d:c,z?c:d))}}return new L(e,t)}function va(e,a){return new L([new T(e,a||e)],0)}function G(e,a){if(a.line<e.first)return D(e.first,0);var u=e.first+e.size-1;if(a.line>u)return D(u,E(e,u).text.length);var u=E(e,a.line).text.length,z=a.ch,u=null==z||z>u?D(a.line,u):0>z?D(a.line,0):a;return u}function Qa(e,a){return a>=e.first&&a<e.first+e.size}function Ka(e,a,u,z){return e.cm&&e.cm.display.shift||e.extend?(e=a.anchor,
z&&(a=0>Q(u,e),a!=0>Q(z,e)?(e=u,u=z):a!=0>Q(u,z)&&(u=z)),new T(e,u)):new T(z||u,u)}function ga(e,a,u,z){S(e,new L([Ka(e,e.sel.primary(),a,u)],0),z)}function ob(e,a,u){for(var z=[],b=0;b<e.sel.ranges.length;b++)z[b]=Ka(e,e.sel.ranges[b],a[b],null);a=ka(z,e.sel.primIndex);S(e,a,u)}function pb(e,a,u,z){var b=e.sel.ranges.slice(0);b[a]=u;S(e,ka(b,e.sel.primIndex),z)}function Aa(e,a){var u={ranges:a.ranges,update:function(a){this.ranges=[];for(var t=0;t<a.length;t++)this.ranges[t]=new T(G(e,a[t].anchor),
G(e,a[t].head))}};aa(e,"beforeSelectionChange",e,u);e.cm&&aa(e.cm,"beforeSelectionChange",e.cm,u);return u.ranges!=a.ranges?ka(u.ranges,u.ranges.length-1):a}function Cb(e,a,u){var z=e.history.done,b=V(z);b&&b.ranges?(z[z.length-1]=a,Ya(e,a,u)):S(e,a,u)}function S(e,a,u){Ya(e,a,u);a=e.sel;var z=e.cm?e.cm.curOp.id:NaN,b=e.history,c=u&&u.origin,d;if(!(d=z==b.lastOp)&&(d=c)&&(d=b.lastSelOrigin==c)&&!(d=b.lastModTime==b.lastSelTime&&b.lastOrigin==c)){d=V(b.done);var f=c.charAt(0);d="*"==f||"+"==f&&d.ranges.length==
a.ranges.length&&d.somethingSelected()==a.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}d?b.done[b.done.length-1]=a:gc(a,b.done);b.lastSelTime=+new Date;b.lastSelOrigin=c;b.lastOp=z;u&&!1!==u.clearRedo&&Hd(b.undone)}function Ya(e,a,u){if(xa(e,"beforeSelectionChange")||e.cm&&xa(e.cm,"beforeSelectionChange"))a=Aa(e,a);var z=0>Q(a.primary().head,e.sel.primary().head)?-1:1;cc(e,Id(e,a,z,!0));u&&!1===u.scroll||!e.cm||db(e.cm)}function cc(e,a){a.equals(e.sel)||
(e.sel=a,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=e.cm.curOp.cursorActivity=!0),da(e,"cursorActivity",e))}function Jd(e){cc(e,Id(e,e.sel,null,!1),tb)}function Id(e,a,u,z){for(var b,c=0;c<a.ranges.length;c++){var d=a.ranges[c],f=hc(e,d.anchor,u,z),g=hc(e,d.head,u,z);if(b||f!=d.anchor||g!=d.head)b||(b=a.ranges.slice(0,c)),b[c]=new T(f,g)}return b?ka(b,a.primIndex):a}function hc(e,a,u,z){var b=!1,c=a,d=u||1;e.cantEdit=!1;a:for(;;){var f=E(e,c.line);if(f.markedSpans)for(var g=0;g<f.markedSpans.length;++g){var k=
f.markedSpans[g],h=k.marker;if((null==k.from||(h.inclusiveLeft?k.from<=c.ch:k.from<c.ch))&&(null==k.to||(h.inclusiveRight?k.to>=c.ch:k.to>c.ch))){if(z&&(aa(h,"beforeCursorEnter"),h.explicitlyCleared))if(f.markedSpans){--g;continue}else break;if(h.atomic){g=h.find(0>d?-1:1);if(0==Q(g,c)&&(g.ch+=d,0>g.ch?g=g.line>e.first?G(e,D(g.line-1)):null:g.ch>f.text.length&&(g=g.line<e.first+e.size-1?D(g.line+1,0):null),!g)){if(b){if(!z)return hc(e,a,u,!0);e.cantEdit=!0;return D(e.first,0)}b=!0;g=a;d=-d}c=g;continue a}}}return c}}
function Xc(e){for(var a=e.display,u=e.doc,z=document.createDocumentFragment(),b=document.createDocumentFragment(),c=0;c<u.sel.ranges.length;c++){var d=u.sel.ranges[c],f=d.empty();if(f||e.options.showCursorWhenSelecting){var g=e,k=z,h=Oa(g,d.head,"div"),l=k.appendChild(I("div","\u00a0","CodeMirror-cursor"));l.style.left=h.left+"px";l.style.top=h.top+"px";l.style.height=Math.max(0,h.bottom-h.top)*g.options.cursorHeight+"px";h.other&&(g=k.appendChild(I("div","\u00a0","CodeMirror-cursor CodeMirror-secondarycursor")),
g.style.display="",g.style.left=h.other.left+"px",g.style.top=h.other.top+"px",g.style.height=0.85*(h.other.bottom-h.other.top)+"px")}f||Oe(e,d,b)}e.options.moveInputWithCursor&&(u=Oa(e,u.sel.primary().head,"div"),c=a.wrapper.getBoundingClientRect(),d=a.lineDiv.getBoundingClientRect(),e=Math.max(0,Math.min(a.wrapper.clientHeight-10,u.top+d.top-c.top)),u=Math.max(0,Math.min(a.wrapper.clientWidth-10,u.left+d.left-c.left)),a.inputDiv.style.top=e+"px",a.inputDiv.style.left=u+"px");Fa(a.cursorDiv,z);Fa(a.selectionDiv,
b)}function Oe(e,a,u){function z(e,a,t,u){0>a&&(a=0);f.appendChild(I("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px; top: "+a+"px; width: "+(null==t?k-e:t)+"px; height: "+(u-a)+"px"))}function b(a,t,u){var c=E(d,a),Z=c.text.length,f,pa;Pe(Ga(c),t||0,null==u?Z:u,function(b,d,g){var ma=ic(e,D(a,b),"div",c,"left"),l,dc;b==d?(l=ma,g=dc=ma.left):(l=ic(e,D(a,d-1),"div",c,"right"),"rtl"==g&&(g=ma,ma=l,l=g),g=ma.left,dc=l.right);null==t&&0==b&&(g=h);3<l.top-ma.top&&(z(g,ma.top,null,ma.bottom),
g=h,ma.bottom<l.top&&z(g,ma.bottom,null,l.top));null==u&&d==Z&&(dc=k);if(!f||ma.top<f.top||ma.top==f.top&&ma.left<f.left)f=ma;if(!pa||l.bottom>pa.bottom||l.bottom==pa.bottom&&l.right>pa.right)pa=l;g<h+1&&(g=h);z(g,l.top,dc-g,l.bottom)});return{start:f,end:pa}}var c=e.display,d=e.doc,f=document.createDocumentFragment(),g=Kd(e.display),h=g.left,k=c.lineSpace.offsetWidth-g.right,c=a.from();a=a.to();if(c.line==a.line)b(c.line,c.ch,a.ch);else{var l=E(d,c.line),g=E(d,a.line),g=Ha(l)==Ha(g),c=b(c.line,c.ch,
g?l.text.length+1:null).end;a=b(a.line,g?0:null,a.ch).start;g&&(c.top<a.top-2?(z(c.right,c.top,null,c.bottom),z(h,a.top,a.left,a.bottom)):z(c.right,c.top,a.left-c.right,c.bottom));c.bottom<a.top&&z(h,c.bottom,null,a.top)}u.appendChild(f)}function jc(e){if(e.state.focused){var a=e.display;clearInterval(a.blinker);var u=!0;a.cursorDiv.style.visibility="";0<e.options.cursorBlinkRate&&(a.blinker=setInterval(function(){a.cursorDiv.style.visibility=(u=!u)?"":"hidden"},e.options.cursorBlinkRate))}}function Fb(e,
a){e.doc.mode.startState&&e.doc.frontier<e.display.viewTo&&e.state.highlight.set(a,Ba(Qe,e))}function Qe(e){var a=e.doc;a.frontier<a.first&&(a.frontier=a.first);if(!(a.frontier>=e.display.viewTo)){var u=+new Date+e.options.workTime,z=Kb(a.mode,Lb(e,a.frontier));La(e,function(){a.iter(a.frontier,Math.min(a.first+a.size,e.display.viewTo+500),function(b){if(a.frontier>=e.display.viewFrom){var c=b.styles;b.styles=Ld(e,b,z,!0);for(var d=!c||c.length!=b.styles.length,f=0;!d&&f<c.length;++f)d=c[f]!=b.styles[f];
d&&eb(e,a.frontier,"text");b.stateAfter=Kb(a.mode,z)}else Yc(e,b.text,z),b.stateAfter=0==a.frontier%5?Kb(a.mode,z):null;++a.frontier;if(+new Date>u)return Fb(e,e.options.workDelay),!0})})}}function Re(e,a,u){for(var b,c,d=e.doc,f=u?-1:a-(e.doc.mode.innerMode?1E3:100);a>f;--a){if(a<=d.first)return d.first;var g=E(d,a-1);if(g.stateAfter&&(!u||a<=d.frontier))return a;g=Ia(g.text,null,e.options.tabSize);if(null==c||b>g)c=a-1,b=g}return c}function Lb(e,a,u){var b=e.doc,c=e.display;if(!b.mode.startState)return!0;
var d=Re(e,a,u),f=d>b.first&&E(b,d-1).stateAfter,f=f?Kb(b.mode,f):Se(b.mode);b.iter(d,a,function(u){Yc(e,u.text,f);u.stateAfter=d==a-1||0==d%5||d>=c.viewFrom&&d<c.viewTo?Kb(b.mode,f):null;++d});u&&(b.frontier=d);return f}function Cd(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function Kd(e){if(e.cachedPaddingH)return e.cachedPaddingH;var a=Fa(e.measure,I("pre","x")),a=window.getComputedStyle?window.getComputedStyle(a):a.currentStyle;return e.cachedPaddingH={left:parseInt(a.paddingLeft),
right:parseInt(a.paddingRight)}}function Md(e,a){if(a>=e.display.viewFrom&&a<e.display.viewTo)return e.display.view[Jb(e,a)];var u=e.display.externalMeasured;if(u&&a>=u.lineN&&a<u.lineN+u.size)return u}function fc(e,a){var u=$(a),b=Md(e,u);b&&!b.text?b=null:b&&b.changes&&X(e,b,u,K(e));if(!b){var c;c=Ha(a);b=$(c);c=e.display.externalMeasured=new Nd(e.doc,c,b);c.lineN=b;b=c.built=Gd(e,c);c.text=b.pre;Fa(e.display.lineMeasure,b.pre);b=c}a:if(c=b,c.line==a)u={map:c.measure.map,cache:c.measure.cache};
else{for(var d=0;d<c.rest.length;d++)if(c.rest[d]==a){u={map:c.measure.maps[d],cache:c.measure.caches[d]};break a}for(d=0;d<c.rest.length;d++)if($(c.rest[d])>u){u={map:c.measure.maps[d],cache:c.measure.caches[d],before:!0};break a}u=void 0}return{line:a,view:b,rect:null,map:u.map,cache:u.cache,before:u.before,hasHeights:!1}}function Wc(e,a,u,b){a.before&&(u=-1);var c=u+(b||""),d;if(a.cache.hasOwnProperty(c))d=a.cache[c];else{a.rect||(a.rect=a.view.text.getBoundingClientRect());if(!a.hasHeights){var f=
a.view,g=a.rect,h=e.options.lineWrapping,k=h&&e.display.scroller.clientWidth;if(!f.measure.heights||h&&f.measure.width!=k){var l=f.measure.heights=[];if(h)for(f.measure.width=k,f=f.text.firstChild.getClientRects(),h=0;h<f.length-1;h++){var k=f[h],q=f[h+1];2<Math.abs(k.bottom-q.bottom)&&l.push((k.bottom+q.top)/2-g.top)}l.push(g.bottom-g.top)}a.hasHeights=!0}var g=b,l=a.map,m,r,w;for(b=0;b<l.length;b+=3){var s=l[b],v=l[b+1];if(u<s)r=0,w=1,d="left";else if(u<v)r=u-s,w=r+1;else if(b==l.length-3||u==v&&
l[b+3]>u)w=v-s,r=w-1,u>=v&&(d="right");if(null!=r){m=l[b+2];s==v&&g==(m.insertLeft?"left":"right")&&(d=g);if("left"==g&&0==r)for(;b&&l[b-2]==l[b-3]&&l[b-1].insertLeft;)m=l[(b-=3)+2],d="left";if("right"==g&&r==v-s)for(;b<l.length-3&&l[b+3]==l[b+4]&&!l[b+5].insertLeft;)m=l[(b+=3)+2],d="right";break}}if(3==m.nodeType){for(;r&&Mb(a.line.text.charAt(s+r));)--r;for(;s+w<v&&Mb(a.line.text.charAt(s+w));)++w;if(fa&&0==r&&w==v-s)u=m.parentNode.getBoundingClientRect();else if(na&&e.options.lineWrapping){var A=
Nb(m,r,w).getClientRects();u=A.length?A["right"==g?A.length-1:0]:Od}else u=Nb(m,r,w).getBoundingClientRect()}else 0<r&&(d=g="right"),u=e.options.lineWrapping&&1<(A=m.getClientRects()).length?A["right"==g?A.length-1:0]:m.getBoundingClientRect();!fa||r||u&&(u.left||u.right)||(u=(m=m.parentNode.getClientRects()[0])?{left:m.left,right:m.left+Gb(e.display),top:m.top,bottom:m.bottom}:Od);m=(u.bottom+u.top)/2-a.rect.top;r=a.view.measure.heights;for(b=0;b<r.length-1&&!(m<r[b]);b++);e=b?r[b-1]:0;m=r[b];d=
{left:("right"==d?u.right:u.left)-a.rect.left,right:("left"==d?u.left:u.right)-a.rect.left,top:e,bottom:m};u.left||u.right||(d.bogus=!0);d.bogus||(a.cache[c]=d)}return{left:d.left,right:d.right,top:d.top,bottom:d.bottom}}function Pd(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var a=0;a<e.rest.length;a++)e.measure.caches[a]={}}function Qd(e){e.display.externalMeasure=null;ab(e.display.lineMeasure);for(var a=0;a<e.display.view.length;a++)Pd(e.display.view[a])}function Hb(e){Qd(e);
e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null;e.options.lineWrapping||(e.display.maxLineChanged=!0);e.display.lineNumChars=null}function Zc(e,a,u,b){if(a.widgets)for(var c=0;c<a.widgets.length;++c)if(a.widgets[c].above){var d=Ob(a.widgets[c]);u.top+=d;u.bottom+=d}if("line"==b)return u;b||(b="local");a=Ea(a);a="local"==b?a+e.display.lineSpace.offsetTop:a-e.display.viewOffset;if("page"==b||"window"==b)e=e.display.lineSpace.getBoundingClientRect(),a+=e.top+("window"==
b?0:window.pageYOffset||(document.documentElement||document.body).scrollTop),b=e.left+("window"==b?0:window.pageXOffset||(document.documentElement||document.body).scrollLeft),u.left+=b,u.right+=b;u.top+=a;u.bottom+=a;return u}function Rd(e,a,u){if("div"==u)return a;var b=a.left;a=a.top;"page"==u?(b-=window.pageXOffset||(document.documentElement||document.body).scrollLeft,a-=window.pageYOffset||(document.documentElement||document.body).scrollTop):"local"!=u&&u||(u=e.display.sizer.getBoundingClientRect(),
b+=u.left,a+=u.top);e=e.display.lineSpace.getBoundingClientRect();return{left:b-e.left,top:a-e.top}}function ic(e,a,u,b,c){b||(b=E(e.doc,a.line));var d=b;a=a.ch;b=Wc(e,fc(e,b),a,c);return Zc(e,d,b,u)}function Oa(e,a,u,b,c){function d(a,t){var f=Wc(e,c,a,t?"right":"left");t?f.left=f.right:f.right=f.left;return Zc(e,b,f,u)}function f(e,a){var t=g[a],u=t.level%2;e==$c(t)&&a&&t.level<g[a-1].level?(t=g[--a],e=ad(t)-(t.level%2?0:1),u=!0):e==ad(t)&&a<g.length-1&&t.level<g[a+1].level&&(t=g[++a],e=$c(t)-t.level%
2,u=!1);return u&&e==t.to&&e>t.from?d(e-1):d(e,u)}b=b||E(e.doc,a.line);c||(c=fc(e,b));var g=Ga(b);a=a.ch;if(!g)return d(a);var h=bd(g,a),h=f(a,h);null!=Pb&&(h.other=f(a,Pb));return h}function Sd(e,a){var u=0;a=G(e.doc,a);e.options.lineWrapping||(u=Gb(e.display)*a.ch);var b=E(e.doc,a.line),c=Ea(b)+e.display.lineSpace.offsetTop;return{left:u,right:u,top:c,bottom:c+b.height}}function kc(e,a,u,b){e=D(e,a);e.xRel=b;u&&(e.outside=!0);return e}function cd(e,a,u){var b=e.doc;u+=e.display.viewOffset;if(0>
u)return kc(b.first,0,!0,-1);var c=cb(b,u),d=b.first+b.size-1;if(c>d)return kc(b.first+b.size-1,E(b,d).text.length,!0,1);0>a&&(a=0);for(b=E(b,c);;)if(c=Te(e,b,c,a,u),d=(b=bb(b,!1))&&b.find(0,!0),b&&(c.ch>d.from.ch||c.ch==d.from.ch&&0<c.xRel))c=$(b=d.to.line);else return c}function Te(e,a,u,b,c){function d(b){b=Oa(e,D(u,b),"line",a,l);g=!0;if(f>b.bottom)return b.left-h;if(f<b.top)return b.left+h;g=!1;return b.left}var f=c-Ea(a),g=!1,h=2*e.display.wrapper.clientWidth,l=fc(e,a),k=Ga(a),m=a.text.length;
c=lc(a);var q=mc(a),r=d(c),w=g,s=d(q),v=g;if(b>s)return kc(u,q,v,1);for(;;){if(k?q==c||q==dd(a,c,1):1>=q-c){k=b<r||b-r<=s-b?c:q;for(b-=k==c?r:s;Mb(a.text.charAt(k));)++k;return kc(u,k,k==c?w:v,-1>b?-1:1<b?1:0)}var A=Math.ceil(m/2),R=c+A;if(k)for(var R=c,B=0;B<A;++B)R=dd(a,R,1);B=d(R);if(B>b){q=R;s=B;if(v=g)s+=1E3;m=A}else c=R,r=B,w=g,m-=A}}function Za(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==fb){fb=I("pre");for(var a=0;49>a;++a)fb.appendChild(document.createTextNode("x")),
fb.appendChild(I("br"));fb.appendChild(document.createTextNode("x"))}Fa(e.measure,fb);a=fb.offsetHeight/50;3<a&&(e.cachedTextHeight=a);ab(e.measure);return a||1}function Gb(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var a=I("span","xxxxxxxxxx"),u=I("pre",[a]);Fa(e.measure,u);a=a.getBoundingClientRect();a=(a.right-a.left)/10;2<a&&(e.cachedCharWidth=a);return a||10}function ub(e){e.curOp={viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivity:!1,
selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,id:++Ue};nc++||(Ua=[])}function vb(e){var a=e.curOp,u=e.doc,b=e.display;e.curOp=null;a.updateMaxLine&&A(e);if(a.viewChanged||a.forceUpdate||null!=a.scrollTop||a.scrollToPos&&(a.scrollToPos.from.line<b.viewFrom||a.scrollToPos.to.line>=b.viewTo)||b.maxLineChanged&&e.options.lineWrapping){var c=H(e,{top:a.scrollTop,ensure:a.scrollToPos},a.forceUpdate);e.display.scroller.offsetHeight&&(e.doc.scrollTop=e.display.scroller.scrollTop)}!c&&
a.selectionChanged&&Xc(e);c||a.startHeight==e.doc.height||J(e);null!=a.scrollTop&&b.scroller.scrollTop!=a.scrollTop&&(c=Math.max(0,Math.min(b.scroller.scrollHeight-b.scroller.clientHeight,a.scrollTop)),b.scroller.scrollTop=b.scrollbarV.scrollTop=u.scrollTop=c);null!=a.scrollLeft&&b.scroller.scrollLeft!=a.scrollLeft&&(c=Math.max(0,Math.min(b.scroller.scrollWidth-b.scroller.clientWidth,a.scrollLeft)),b.scroller.scrollLeft=b.scrollbarH.scrollLeft=u.scrollLeft=c,w(e));if(a.scrollToPos){a:{u=G(e.doc,a.scrollToPos.from);
b=G(e.doc,a.scrollToPos.to);c=a.scrollToPos.margin;for(null==c&&(c=0);;){var d=!1,f=Oa(e,u),g=b&&b!=u?Oa(e,b):f,g=oc(e,Math.min(f.left,g.left),Math.min(f.top,g.top)-c,Math.max(f.left,g.left),Math.max(f.bottom,g.bottom)+c),h=e.doc.scrollTop,k=e.doc.scrollLeft;null!=g.scrollTop&&(Qb(e,g.scrollTop),1<Math.abs(e.doc.scrollTop-h)&&(d=!0));null!=g.scrollLeft&&(rb(e,g.scrollLeft),1<Math.abs(e.doc.scrollLeft-k)&&(d=!0));if(!d){u=f;break a}}u=void 0}a.scrollToPos.isCursor&&e.state.focused&&(b=u,c=e.display,
d=c.sizer.getBoundingClientRect(),u=null,0>b.top+d.top?u=!0:b.bottom+d.top>(window.innerHeight||document.documentElement.clientHeight)&&(u=!1),null==u||Ve||(b=I("div","\u200b",null,"position: absolute; top: "+(b.top-c.viewOffset-e.display.lineSpace.offsetTop)+"px; height: "+(b.bottom-b.top+Ma)+"px; left: "+b.left+"px; width: 2px;"),e.display.lineSpace.appendChild(b),b.scrollIntoView(u),e.display.lineSpace.removeChild(b)))}a.selectionChanged&&jc(e);e.state.focused&&a.updateInput&&Ca(e,a.typing);u=
a.maybeHiddenMarkers;b=a.maybeUnhiddenMarkers;if(u)for(c=0;c<u.length;++c)u[c].lines.length||aa(u[c],"hide");if(b)for(c=0;c<b.length;++c)b[c].lines.length&&aa(b[c],"unhide");var l;--nc||(l=Ua,Ua=null);if(a.changeObjs){for(c=0;c<a.changeObjs.length;c++)aa(e,"change",e,a.changeObjs[c]);aa(e,"changes",e,a.changeObjs)}a.cursorActivity&&aa(e,"cursorActivity",e);if(l)for(c=0;c<l.length;++c)l[c]()}function La(e,a){if(e.curOp)return a();ub(e);try{return a()}finally{vb(e)}}function ca(e,a){return function(){if(e.curOp)return a.apply(e,
arguments);ub(e);try{return a.apply(e,arguments)}finally{vb(e)}}}function ba(e){return function(){if(this.curOp)return e.apply(this,arguments);ub(this);try{return e.apply(this,arguments)}finally{vb(this)}}}function ra(e){return function(){var a=this.cm;if(!a||a.curOp)return e.apply(this,arguments);ub(a);try{return e.apply(this,arguments)}finally{vb(a)}}}function Nd(e,a,b){for(var c=this.line=a,d;c=bb(c,!1);)c=c.find(1,!0).line,(d||(d=[])).push(c);this.size=(this.rest=d)?$(V(this.rest))-b+1:1;this.node=
this.text=null;this.hidden=$a(e,a)}function ec(e,a,b){var c=[],d;for(d=a;d<b;)a=new Nd(e.doc,E(e.doc,d),d),d+=a.size,c.push(a);return c}function ta(e,a,b,c){null==a&&(a=e.doc.first);null==b&&(b=e.doc.first+e.doc.size);c||(c=0);var d=e.display;c&&b<d.viewTo&&(null==d.updateLineNumbers||d.updateLineNumbers>a)&&(d.updateLineNumbers=a);e.curOp.viewChanged=!0;if(a>=d.viewTo)Ta&&Vc(e.doc,a)<d.viewTo&&Sa(e);else if(b<=d.viewFrom)Ta&&Fd(e.doc,b+c)>d.viewFrom?Sa(e):(d.viewFrom+=c,d.viewTo+=c);else if(a<=d.viewFrom&&
b>=d.viewTo)Sa(e);else if(a<=d.viewFrom){var f=pc(e,b,b+c,1);f?(d.view=d.view.slice(f.index),d.viewFrom=f.lineN,d.viewTo+=c):Sa(e)}else if(b>=d.viewTo)(f=pc(e,a,a,-1))?(d.view=d.view.slice(0,f.index),d.viewTo=f.lineN):Sa(e);else{var f=pc(e,a,a,-1),g=pc(e,b,b+c,1);f&&g?(d.view=d.view.slice(0,f.index).concat(ec(e,f.lineN,g.lineN)).concat(d.view.slice(g.index)),d.viewTo+=c):Sa(e)}if(e=d.externalMeasured)b<e.lineN?e.lineN+=c:a<e.lineN+e.size&&(d.externalMeasured=null)}function eb(e,a,b){e.curOp.viewChanged=
!0;var c=e.display,d=e.display.externalMeasured;d&&a>=d.lineN&&a<d.lineN+d.size&&(c.externalMeasured=null);a<c.viewFrom||a>=c.viewTo||(e=c.view[Jb(e,a)],null!=e.node&&(e=e.changes||(e.changes=[]),-1==ha(e,b)&&e.push(b)))}function Sa(e){e.display.viewFrom=e.display.viewTo=e.doc.first;e.display.view=[];e.display.viewOffset=0}function Jb(e,a){if(a>=e.display.viewTo)return null;a-=e.display.viewFrom;if(0>a)return null;for(var b=e.display.view,c=0;c<b.length;c++)if(a-=b[c].size,0>a)return c}function pc(e,
a,b,c){var d=Jb(e,a),f=e.display.view;if(!Ta)return{index:d,lineN:b};for(var g=0,h=e.display.viewFrom;g<d;g++)h+=f[g].size;if(h!=a){if(0<c){if(d==f.length-1)return null;a=h+f[d].size-a;d++}else a=h-a;b+=a}for(;Vc(e.doc,b)!=b;){if(d==(0>c?0:f.length-1))return null;b+=c*f[d-(0>c?1:0)].size;d+=c}return{index:d,lineN:b}}function Ed(e){e=e.display.view;for(var a=0,b=0;b<e.length;b++){var c=e[b];c.hidden||c.node&&!c.changes||++a}return a}function qc(e){e.display.pollingFast||e.display.poll.set(e.options.pollInterval,
function(){ed(e);e.state.focused&&qc(e)})}function Rb(e){function a(){ed(e)||b?(e.display.pollingFast=!1,qc(e)):(b=!0,e.display.poll.set(60,a))}var b=!1;e.display.pollingFast=!0;e.display.poll.set(20,a)}function ed(e){var a=e.display.input,b=e.display.prevInput,c=e.doc;if(!e.state.focused||We(a)||rc(e)||e.options.disableInput)return!1;var d=a.value;if(d==b&&!e.somethingSelected())return!1;if(na&&!fa&&e.display.inputHasSelection===d)return Ca(e),!1;var f=!e.curOp;f&&ub(e);e.display.shift=!1;for(var g=
0,h=Math.min(b.length,d.length);g<h&&b.charCodeAt(g)==d.charCodeAt(g);)++g;for(var h=d.slice(g),l=wb(h),k=e.state.pasteIncoming&&1<l.length&&c.sel.ranges.length==l.length,m=c.sel.ranges.length-1;0<=m;m--){var q=c.sel.ranges[m],r=q.from(),s=q.to();g<b.length?r=D(r.line,r.ch-(b.length-g)):e.state.overwrite&&q.empty()&&!e.state.pasteIncoming&&(s=D(s.line,Math.min(E(c,s.line).text.length,s.ch+V(l).length)));var w=e.curOp.updateInput,r={from:r,to:s,text:k?[l[m]]:l,origin:e.state.pasteIncoming?"paste":
e.state.cutIncoming?"cut":"+input"};xb(e.doc,r);da(e,"inputRead",e,r);if(h&&!e.state.pasteIncoming&&e.options.electricChars&&e.options.smartIndent&&100>q.head.ch&&(!m||c.sel.ranges[m-1].head.line!=q.head.line)&&(r=e.getModeAt(q.head).electricChars))for(s=0;s<r.length;s++)if(-1<h.indexOf(r.charAt(s))){sc(e,q.head.line,"smart");break}}db(e);e.curOp.updateInput=w;e.curOp.typing=!0;1E3<d.length||-1<d.indexOf("\n")?a.value=e.display.prevInput="":e.display.prevInput=d;f&&vb(e);e.state.pasteIncoming=e.state.cutIncoming=
!1;return!0}function Ca(e,a){var b,c,d=e.doc;e.somethingSelected()?(e.display.prevInput="",b=d.sel.primary(),c=(b=Td&&(100<b.to().line-b.from().line||1E3<(c=e.getSelection()).length))?"-":c||e.getSelection(),e.display.input.value=c,e.state.focused&&tc(e.display.input),na&&!fa&&(e.display.inputHasSelection=c)):a||(e.display.prevInput=e.display.input.value="",na&&!fa&&(e.display.inputHasSelection=null));e.display.inaccurateSelection=b}function oa(e){"nocursor"==e.options.readOnly||Pc&&Ra()==e.display.input||
e.display.input.focus()}function fd(e){e.state.focused||(oa(e),Rc(e))}function rc(e){return e.options.readOnly||e.doc.cantEdit}function Le(e){function a(){e.state.focused&&setTimeout(Ba(oa,e),0)}function b(){null==h&&(h=setTimeout(function(){h=null;g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=Sb=null;e.setSize()},100))}function c(){Ud(document.body,g.wrapper)?setTimeout(c,5E3):Va(window,"resize",b)}function d(a){Ja(e,a)||gd(a)}function f(a){g.inaccurateSelection&&(g.prevInput="",g.inaccurateSelection=
!1,g.input.value=e.getSelection(),tc(g.input));"cut"==a.type&&(e.state.cutIncoming=!0)}var g=e.display;N(g.scroller,"mousedown",ca(e,Dd));wa?N(g.scroller,"dblclick",ca(e,function(a){if(!Ja(e,a)){var t=gb(e,a);!t||hd(e,a,"gutterClick",!0,da)||hb(e.display,a)||(ia(a),a=id(e.doc,t),ga(e.doc,a.anchor,a.head))}})):N(g.scroller,"dblclick",function(a){Ja(e,a)||ia(a)});N(g.lineSpace,"selectstart",function(e){hb(g,e)||ia(e)});jd||N(g.scroller,"contextmenu",function(a){Vd(e,a)});N(g.scroller,"scroll",function(){g.scroller.clientHeight&&
(Qb(e,g.scroller.scrollTop),rb(e,g.scroller.scrollLeft,!0),aa(e,"scroll",e))});N(g.scrollbarV,"scroll",function(){g.scroller.clientHeight&&Qb(e,g.scrollbarV.scrollTop)});N(g.scrollbarH,"scroll",function(){g.scroller.clientHeight&&rb(e,g.scrollbarH.scrollLeft)});N(g.scroller,"mousewheel",function(a){Wd(e,a)});N(g.scroller,"DOMMouseScroll",function(a){Wd(e,a)});N(g.scrollbarH,"mousedown",a);N(g.scrollbarV,"mousedown",a);N(g.wrapper,"scroll",function(){g.wrapper.scrollTop=g.wrapper.scrollLeft=0});var h;
N(window,"resize",b);setTimeout(c,5E3);N(g.input,"keyup",ca(e,Xd));N(g.input,"input",function(){na&&!fa&&e.display.inputHasSelection&&(e.display.inputHasSelection=null);Rb(e)});N(g.input,"keydown",ca(e,Yd));N(g.input,"keypress",ca(e,Zd));N(g.input,"focus",Ba(Rc,e));N(g.input,"blur",Ba(Sc,e));e.options.dragDrop&&(N(g.scroller,"dragstart",function(a){if(wa&&(!e.state.draggingText||100>+new Date-$d))gd(a);else if(!Ja(e,a)&&!hb(e.display,a)&&(a.dataTransfer.setData("Text",e.getSelection()),a.dataTransfer.setDragImage&&
!ae)){var t=I("img",null,null,"position: fixed; left: 0; top: 0;");t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";ya&&(t.width=t.height=1,e.display.wrapper.appendChild(t),t._top=t.offsetTop);a.dataTransfer.setDragImage(t,0,0);ya&&t.parentNode.removeChild(t)}}),N(g.scroller,"dragenter",d),N(g.scroller,"dragover",d),N(g.scroller,"drop",ca(e,Xe)));N(g.scroller,"paste",function(a){hb(g,a)||(e.state.pasteIncoming=!0,oa(e),Rb(e))});N(g.input,"paste",function(){e.state.pasteIncoming=
!0;Rb(e)});N(g.input,"cut",f);N(g.input,"copy",f);Uc&&N(g.sizer,"mouseup",function(){Ra()==g.input&&g.input.blur();oa(e)})}function hb(e,a){for(var b=a.target||a.srcElement;b!=e.wrapper;b=b.parentNode)if(!b||b.ignoreEvents||b.parentNode==e.sizer&&b!=e.mover)return!0}function gb(e,a,b,c){var d=e.display;if(!b&&(b=a.target||a.srcElement,b==d.scrollbarH||b==d.scrollbarV||b==d.scrollbarFiller||b==d.gutterFiller))return null;var f,g,d=d.lineSpace.getBoundingClientRect();try{f=a.clientX-d.left,g=a.clientY-
d.top}catch(h){return null}a=cd(e,f,g);var l;c&&1==a.xRel&&(l=E(e.doc,a.line).text).length==a.ch&&(c=Ia(l,l.length,e.options.tabSize)-l.length,a=D(a.line,Math.round((f-Kd(e.display).left)/Gb(e.display))-c));return a}function Dd(e){if(!Ja(this,e)){var a=this.display;a.shift=e.shiftKey;if(hb(a,e))qa||(a.scroller.draggable=!1,setTimeout(function(){a.scroller.draggable=!0},100));else if(!hd(this,e,"gutterClick",!0,da)){var b=gb(this,e);window.focus();switch(be(e)){case 1:b?Ye(this,e,b):(e.target||e.srcElement)==
a.scroller&&ia(e);break;case 2:qa&&(this.state.lastMiddleDown=+new Date);b&&ga(this.doc,b);setTimeout(Ba(oa,this),20);ia(e);break;case 3:jd&&Vd(this,e)}}}}function Ye(e,a,b){setTimeout(Ba(fd,e),0);var c=+new Date,d;uc&&uc.time>c-400&&0==Q(uc.pos,b)?d="triple":vc&&vc.time>c-400&&0==Q(vc.pos,b)?(d="double",uc={time:c,pos:b}):(d="single",vc={time:c,pos:b});c=e.doc.sel;e.options.dragDrop&&Ze&&!rc(e)&&"single"==d&&-1<c.contains(b)&&c.somethingSelected()?$e(e,a,b):af(e,a,b,d,!1)}function $e(e,a,b){var c=
e.display,d=ca(e,function(f){qa&&(c.scroller.draggable=!1);e.state.draggingText=!1;Va(document,"mouseup",d);Va(c.scroller,"drop",d);10>Math.abs(a.clientX-f.clientX)+Math.abs(a.clientY-f.clientY)&&(ia(f),ga(e.doc,b),oa(e),wa&&!fa&&setTimeout(function(){document.body.focus();oa(e)},20))});qa&&(c.scroller.draggable=!0);e.state.draggingText=d;c.scroller.dragDrop&&c.scroller.dragDrop();N(document,"mouseup",d);N(c.scroller,"drop",d)}function af(e,a,b,c,d){function f(a){if(0!=Q(s,a))if(s=a,"rect"==c){var t=
[],d=e.options.tabSize,g=Ia(E(k,b.line).text,b.ch,d),Z=Ia(E(k,a.line).text,a.ch,d),pa=Math.min(g,Z),g=Math.max(g,Z),Z=Math.min(b.line,a.line);for(a=Math.min(e.lastLine(),Math.max(b.line,a.line));Z<=a;Z++){var h=E(k,Z).text,l=ce(h,pa,d);pa==g?t.push(new T(D(Z,l),D(Z,l))):h.length>l&&t.push(new T(D(Z,l),D(Z,ce(h,g,d))))}t.length||t.push(new T(b,b));S(k,ka(r.ranges.slice(0,q).concat(t),q),wc)}else t=m,d=t.anchor,pa=a,"single"!=c&&(a="double"==c?id(k,a):new T(D(a.line,0),G(k,D(a.line+1,0))),0<Q(a.anchor,
d)?(pa=a.head,d=Xa(t.from(),a.anchor)):(pa=a.anchor,d=Pa(t.to(),a.head))),t=r.ranges.slice(0),t[q]=new T(G(k,d),pa),S(k,ka(t,q),wc)}function g(a){var t=++v,b=gb(e,a,!0,"rect"==c);if(b)if(0!=Q(b,s)){fd(e);f(b);var u=C(l,k);(b.line>=u.to||b.line<u.from)&&setTimeout(ca(e,function(){v==t&&g(a)}),150)}else{var d=a.clientY<w.top?-20:a.clientY>w.bottom?20:0;d&&setTimeout(ca(e,function(){v==t&&(l.scroller.scrollTop+=d,g(a))}),50)}}function h(a){v=Infinity;ia(a);oa(e);Va(document,"mousemove",A);Va(document,
"mouseup",R);k.history.lastSelOrigin=null}var l=e.display,k=e.doc;ia(a);var m,q,r=k.sel;d?(q=k.sel.contains(b),m=-1<q?k.sel.ranges[q]:new T(b,b)):m=k.sel.primary();a.altKey?(c="rect",d||(m=new T(b,b)),b=gb(e,a,!0,!0),q=-1):"double"==c?(a=id(k,b),m=e.display.shift||k.extend?Ka(k,m,a.anchor,a.head):a):"triple"==c?(a=new T(D(b.line,0),G(k,D(b.line+1,0))),m=e.display.shift||k.extend?Ka(k,m,a.anchor,a.head):a):m=Ka(k,m,b);d?-1<q?pb(k,q,m,wc):(q=k.sel.ranges.length,S(k,ka(k.sel.ranges.concat([m]),q),{scroll:!1,
origin:"*mouse"})):(q=0,S(k,new L([m],0),wc));var s=b,w=l.wrapper.getBoundingClientRect(),v=0,A=ca(e,function(e){(na&&!bf?e.buttons:be(e))?g(e):h(e)}),R=ca(e,h);N(document,"mousemove",A);N(document,"mouseup",R)}function hd(e,a,b,c,d){try{var f=a.clientX,g=a.clientY}catch(h){return!1}if(f>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;c&&ia(a);c=e.display;var k=c.lineDiv.getBoundingClientRect();if(g>k.bottom||!xa(e,b))return kd(a);g-=k.top-c.viewOffset;for(k=0;k<e.options.gutters.length;++k){var l=
c.gutters.childNodes[k];if(l&&l.getBoundingClientRect().right>=f)return f=cb(e.doc,g),d(e,b,e,f,e.options.gutters[k],a),kd(a)}}function Xe(e){var a=this;if(!Ja(a,e)&&!hb(a.display,e)){ia(e);wa&&($d=+new Date);var b=gb(a,e,!0),c=e.dataTransfer.files;if(b&&!rc(a))if(c&&c.length&&window.FileReader&&window.File){var d=c.length,f=Array(d),g=0;e=function(e,c){var z=new FileReader;z.onload=function(){f[c]=z.result;if(++g==d){b=G(a.doc,b);var e={from:b,to:b,text:wb(f.join("\n")),origin:"paste"};xb(a.doc,
e);Cb(a.doc,va(b,yb(e)))}};z.readAsText(e)};for(var k=0;k<d;++k)e(c[k],k)}else if(a.state.draggingText&&-1<a.doc.sel.contains(b))a.state.draggingText(e),setTimeout(Ba(oa,a),20);else try{if(f=e.dataTransfer.getData("Text")){var h=a.state.draggingText&&a.listSelections();Ya(a.doc,va(b,b));if(h)for(k=0;k<h.length;++k)xc(a.doc,"",h[k].anchor,h[k].head,"drag");a.replaceSelection(f,"around","paste");oa(a)}}catch(l){}}}function Qb(e,a){2>Math.abs(e.doc.scrollTop-a)||(e.doc.scrollTop=a,Tb||H(e,{top:a}),e.display.scroller.scrollTop!=
a&&(e.display.scroller.scrollTop=a),e.display.scrollbarV.scrollTop!=a&&(e.display.scrollbarV.scrollTop=a),Tb&&H(e),Fb(e,100))}function rb(e,a,b){(b?a==e.doc.scrollLeft:2>Math.abs(e.doc.scrollLeft-a))||(a=Math.min(a,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),e.doc.scrollLeft=a,w(e),e.display.scroller.scrollLeft!=a&&(e.display.scroller.scrollLeft=a),e.display.scrollbarH.scrollLeft!=a&&(e.display.scrollbarH.scrollLeft=a))}function Wd(e,a){var b=a.wheelDeltaX,c=a.wheelDeltaY;null==
b&&a.detail&&a.axis==a.HORIZONTAL_AXIS&&(b=a.detail);null==c&&a.detail&&a.axis==a.VERTICAL_AXIS?c=a.detail:null==c&&(c=a.wheelDelta);var d=e.display,f=d.scroller;if(b&&f.scrollWidth>f.clientWidth||c&&f.scrollHeight>f.clientHeight){if(c&&sb&&qa){var g=a.target,k=d.view;a:for(;g!=f;g=g.parentNode)for(var h=0;h<k.length;h++)if(k[h].node==g){e.display.currentWheelTarget=g;break a}}!b||Tb||ya||null==za?(c&&null!=za&&(g=c*za,k=e.doc.scrollTop,h=k+d.wrapper.clientHeight,0>g?k=Math.max(0,k+g-50):h=Math.min(e.doc.height,
h+g+50),H(e,{top:k,bottom:h})),20>yc&&(null==d.wheelStartX?(d.wheelStartX=f.scrollLeft,d.wheelStartY=f.scrollTop,d.wheelDX=b,d.wheelDY=c,setTimeout(function(){if(null!=d.wheelStartX){var e=f.scrollLeft-d.wheelStartX,a=f.scrollTop-d.wheelStartY,e=a&&d.wheelDY&&a/d.wheelDY||e&&d.wheelDX&&e/d.wheelDX;d.wheelStartX=d.wheelStartY=null;e&&(za=(za*yc+e)/(yc+1),++yc)}},200)):(d.wheelDX+=b,d.wheelDY+=c))):(c&&Qb(e,Math.max(0,Math.min(f.scrollTop+c*za,f.scrollHeight-f.clientHeight))),rb(e,Math.max(0,Math.min(f.scrollLeft+
b*za,f.scrollWidth-f.clientWidth))),ia(a),d.wheelStartX=null)}}function zc(e,a,b){if("string"==typeof a&&(a=Ac[a],!a))return!1;e.display.pollingFast&&ed(e)&&(e.display.pollingFast=!1);var c=e.display.shift,d=!1;try{rc(e)&&(e.state.suppressEdits=!0),b&&(e.display.shift=!1),d=a(e)!=de}finally{e.display.shift=c,e.state.suppressEdits=!1}return d}function ee(e){var a=e.state.keyMaps.slice(0);e.options.extraKeys&&a.push(e.options.extraKeys);a.push(e.options.keyMap);return a}function fe(e,a){var b=ld(e.options.keyMap),
c=b.auto;clearTimeout(ge);c&&!cf(a)&&(ge=setTimeout(function(){ld(e.options.keyMap)==b&&(e.options.keyMap=c.call?c.call(null,e):c,h(e))},50));var d=df(a,!0),f=!1;if(!d)return!1;f=ee(e);if(f=a.shiftKey?Bc("Shift-"+d,f,function(a){return zc(e,a,!0)})||Bc(d,f,function(a){if("string"==typeof a?/^go[A-Z]/.test(a):a.motion)return zc(e,a)}):Bc(d,f,function(a){return zc(e,a)}))ia(a),jc(e),da(e,"keyHandled",e,d,a);return f}function ef(e,a,b){var c=Bc("'"+b+"'",ee(e),function(a){return zc(e,a,!0)});c&&(ia(a),
jc(e),da(e,"keyHandled",e,"'"+b+"'",a));return c}function Yd(e){fd(this);if(!Ja(this,e)){wa&&27==e.keyCode&&(e.returnValue=!1);var a=e.keyCode;this.display.shift=16==a||e.shiftKey;var b=fe(this,e);ya&&(md=b?a:null,!b&&88==a&&!Td&&(sb?e.metaKey:e.ctrlKey)&&this.replaceSelection("",null,"cut"))}}function Xd(e){Ja(this,e)||16!=e.keyCode||(this.doc.sel.shift=!1)}function Zd(e){if(!Ja(this,e)){var a=e.keyCode,b=e.charCode;ya&&a==md?(md=null,ia(e)):(ya&&(!e.which||10>e.which)||Uc)&&fe(this,e)||(a=String.fromCharCode(null==
b?a:b),ef(this,e,a)||(na&&!fa&&(this.display.inputHasSelection=null),Rb(this)))}}function Rc(e){"nocursor"!=e.options.readOnly&&(e.state.focused||(aa(e,"focus",e),e.state.focused=!0,-1==e.display.wrapper.className.search(/\bCodeMirror-focused\b/)&&(e.display.wrapper.className+=" CodeMirror-focused"),e.curOp||(Ca(e),qa&&setTimeout(Ba(Ca,e,!0),0))),qc(e),jc(e))}function Sc(e){e.state.focused&&(aa(e,"blur",e),e.state.focused=!1,e.display.wrapper.className=e.display.wrapper.className.replace(" CodeMirror-focused",
""));clearInterval(e.display.blinker);setTimeout(function(){e.state.focused||(e.display.shift=!1)},150)}function Vd(e,a){function b(){if(null!=d.input.selectionStart){var a=d.input.value="\u200b"+(e.somethingSelected()?d.input.value:"");d.prevInput="\u200b";d.input.selectionStart=1;d.input.selectionEnd=a.length}}function c(){d.inputDiv.style.position="relative";d.input.style.cssText=k;fa&&(d.scrollbarV.scrollTop=d.scroller.scrollTop=g);qc(e);if(null!=d.input.selectionStart){na&&!fa||b();clearTimeout(nd);
var a=0,t=function(){"\u200b"==d.prevInput&&0==d.input.selectionStart?ca(e,Ac.selectAll)(e):10>a++?nd=setTimeout(t,500):Ca(e)};nd=setTimeout(t,200)}}if(!Ja(e,a,"contextmenu")){var d=e.display;if(!hb(d,a)&&!ff(e,a)){var f=gb(e,a),g=d.scroller.scrollTop;if(f&&!ya){e.options.resetSelectionOnContextMenu&&-1==e.doc.sel.contains(f)&&ca(e,S)(e.doc,va(f),tb);var k=d.input.style.cssText;d.inputDiv.style.position="absolute";d.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(a.clientY-
5)+"px; left: "+(a.clientX-5)+"px; z-index: 1000; background: "+(na?"rgba(255, 255, 255, .05)":"transparent")+"; outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";oa(e);Ca(e);e.somethingSelected()||(d.input.value=d.prevInput=" ");na&&!fa&&b();if(jd){gd(a);var h=function(){Va(window,"mouseup",h);setTimeout(c,20)};N(window,"mouseup",h)}else setTimeout(c,50)}}}}function ff(e,a){return xa(e,"gutterContextMenu")?hd(e,a,"gutterContextMenu",!1,aa):
!1}function he(e,a){if(0>Q(e,a.from))return e;if(0>=Q(e,a.to))return yb(a);var b=e.line+a.text.length-(a.to.line-a.from.line)-1,c=e.ch;e.line==a.to.line&&(c+=yb(a).ch-a.to.ch);return D(b,c)}function od(e,a){for(var b=[],c=0;c<e.sel.ranges.length;c++){var d=e.sel.ranges[c];b.push(new T(he(d.anchor,a),he(d.head,a)))}return ka(b,e.sel.primIndex)}function ie(e,a,b){return e.line==a.line?D(b.line,e.ch-a.ch+b.ch):D(b.line+(e.line-a.line),e.ch)}function je(e,a,b){a={canceled:!1,from:a.from,to:a.to,text:a.text,
origin:a.origin,cancel:function(){this.canceled=!0}};b&&(a.update=function(a,b,t,c){a&&(this.from=G(e,a));b&&(this.to=G(e,b));t&&(this.text=t);void 0!==c&&(this.origin=c)});aa(e,"beforeChange",e,a);e.cm&&aa(e.cm,"beforeChange",e.cm,a);return a.canceled?null:{from:a.from,to:a.to,text:a.text,origin:a.origin}}function xb(e,a,b){if(e.cm){if(!e.cm.curOp)return ca(e.cm,xb)(e,a,b);if(e.cm.state.suppressEdits)return}if(xa(e,"beforeChange")||e.cm&&xa(e.cm,"beforeChange"))if(a=je(e,a,!0),!a)return;if(b=ke&&
!b&&gf(e,a.from,a.to))for(var c=b.length-1;0<=c;--c)le(e,{from:b[c].from,to:b[c].to,text:c?[""]:a.text});else le(e,a)}function le(e,a){if(1!=a.text.length||""!=a.text[0]||0!=Q(a.from,a.to)){var b=od(e,a);me(e,a,b,e.cm?e.cm.curOp.id:NaN);Ub(e,a,b,pd(e,a));var c=[];zb(e,function(e,b){b||-1!=ha(c,e.history)||(ne(e.history,a),c.push(e.history));Ub(e,a,null,pd(e,a))})}}function Cc(e,a,b){if(!e.cm||!e.cm.state.suppressEdits){for(var c=e.history,d,f=e.sel,g="undo"==a?c.done:c.undone,k="undo"==a?c.undone:
c.done,h=0;h<g.length&&(d=g[h],b?!d.ranges||d.equals(e.sel):d.ranges);h++);if(h!=g.length){for(c.lastOrigin=c.lastSelOrigin=null;;)if(d=g.pop(),d.ranges){gc(d,k);if(b&&!d.equals(e.sel)){S(e,d,{clearRedo:!1});return}f=d}else break;b=[];gc(f,k);k.push({changes:b,generation:c.generation});c.generation=d.generation||++c.maxGeneration;c=xa(e,"beforeChange")||e.cm&&xa(e.cm,"beforeChange");for(h=d.changes.length-1;0<=h;--h){var l=d.changes[h];l.origin=a;if(c&&!je(e,l,!1)){g.length=0;break}b.push(qd(e,l));
f=h?od(e,l,null):V(g);Ub(e,l,f,oe(e,l));e.cm&&db(e.cm);var m=[];zb(e,function(e,a){a||-1!=ha(m,e.history)||(ne(e.history,l),m.push(e.history));Ub(e,l,null,oe(e,l))})}}}}function pe(e,a){e.first+=a;e.sel=new L(rd(e.sel.ranges,function(e){return new T(D(e.anchor.line+a,e.anchor.ch),D(e.head.line+a,e.head.ch))}),e.sel.primIndex);e.cm&&ta(e.cm,e.first,e.first-a,a)}function Ub(e,a,b,c){if(e.cm&&!e.cm.curOp)return ca(e.cm,Ub)(e,a,b,c);if(a.to.line<e.first)pe(e,a.text.length-1-(a.to.line-a.from.line));else if(!(a.from.line>
e.lastLine())){if(a.from.line<e.first){var d=a.text.length-1-(e.first-a.from.line);pe(e,d);a={from:D(e.first,0),to:D(a.to.line+d,a.to.ch),text:[V(a.text)],origin:a.origin}}d=e.lastLine();a.to.line>d&&(a={from:a.from,to:D(d,E(e,d).text.length),text:[a.text[0]],origin:a.origin});a.removed=Vb(e,a.from,a.to);b||(b=od(e,a,null));e.cm?hf(e.cm,a,c):sd(e,a,c);Ya(e,b,tb)}}function hf(e,a,b){var c=e.doc,d=e.display,g=a.from,k=a.to,h=!1,l=g.line;e.options.lineWrapping||(l=$(Ha(E(c,g.line))),c.iter(l,k.line+
1,function(e){if(e==d.maxLine)return h=!0}));-1<c.sel.contains(a.from,a.to)&&(e.curOp.cursorActivity=!0);sd(c,a,b,f(e));e.options.lineWrapping||(c.iter(l,g.line+a.text.length,function(e){var a=v(e);a>d.maxLineLength&&(d.maxLine=e,d.maxLineLength=a,d.maxLineChanged=!0,h=!1)}),h&&(e.curOp.updateMaxLine=!0));c.frontier=Math.min(c.frontier,g.line);Fb(e,400);b=a.text.length-(k.line-g.line)-1;g.line!=k.line||1!=a.text.length||qe(e.doc,a)?ta(e,g.line,k.line+1,b):eb(e,g.line,"text");(xa(e,"change")||xa(e,
"changes"))&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push({from:g,to:k,text:a.text,removed:a.removed,origin:a.origin})}function xc(e,a,b,c,d){c||(c=b);if(0>Q(c,b)){var f=c;c=b;b=f}"string"==typeof a&&(a=wb(a));xb(e,{from:b,to:c,text:a,origin:d})}function oc(e,a,b,c,d){var f=e.display,g=Za(e.display);0>b&&(b=0);var k=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:f.scroller.scrollTop,h=f.scroller.clientHeight-Ma,l={},m=e.doc.height+Cd(f),q=b<g,g=d>m-g;b<k?l.scrollTop=q?0:b:d>k+h&&(b=Math.min(b,
(g?m:d)-h),b!=k&&(l.scrollTop=b));e=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:f.scroller.scrollLeft;k=f.scroller.clientWidth-Ma;a+=f.gutters.offsetWidth;c+=f.gutters.offsetWidth;f=f.gutters.offsetWidth;b=a<f+10;a<e+f||b?(b&&(a=0),l.scrollLeft=Math.max(0,a-10-f)):c>k+e-3&&(l.scrollLeft=c+10-k);return l}function Dc(e,a,b){null==a&&null==b||Ec(e);null!=a&&(e.curOp.scrollLeft=(null==e.curOp.scrollLeft?e.doc.scrollLeft:e.curOp.scrollLeft)+a);null!=b&&(e.curOp.scrollTop=(null==e.curOp.scrollTop?
e.doc.scrollTop:e.curOp.scrollTop)+b)}function db(e){Ec(e);var a=e.getCursor(),b=a,c=a;e.options.lineWrapping||(b=a.ch?D(a.line,a.ch-1):a,c=D(a.line,a.ch+1));e.curOp.scrollToPos={from:b,to:c,margin:e.options.cursorScrollMargin,isCursor:!0}}function Ec(e){var a=e.curOp.scrollToPos;if(a){e.curOp.scrollToPos=null;var b=Sd(e,a.from),c=Sd(e,a.to),a=oc(e,Math.min(b.left,c.left),Math.min(b.top,c.top)-a.margin,Math.max(b.right,c.right),Math.max(b.bottom,c.bottom)+a.margin);e.scrollTo(a.scrollLeft,a.scrollTop)}}
function sc(e,a,b,c){var d=e.doc,f;null==b&&(b="add");"smart"==b&&(e.doc.mode.indent?f=Lb(e,a):b="prev");var g=e.options.tabSize,k=E(d,a),h=Ia(k.text,null,g);k.stateAfter&&(k.stateAfter=null);var l=k.text.match(/^\s*/)[0],m;if(!c&&!/\S/.test(k.text))m=0,b="not";else if("smart"==b&&(m=e.doc.mode.indent(f,k.text.slice(l.length),k.text),m==de)){if(!c)return;b="prev"}"prev"==b?m=a>d.first?Ia(E(d,a-1).text,null,g):0:"add"==b?m=h+e.options.indentUnit:"subtract"==b?m=h-e.options.indentUnit:"number"==typeof b&&
(m=h+b);m=Math.max(0,m);c="";f=0;if(e.options.indentWithTabs)for(b=Math.floor(m/g);b;--b)f+=g,c+="\t";f<m&&(c+=re(m-f));if(c!=l)xc(e.doc,c,D(a,0),D(a,l.length),"+input");else for(b=0;b<d.sel.ranges.length;b++)if(e=d.sel.ranges[b],e.head.line==a&&e.head.ch<l.length){f=D(a,l.length);pb(d,b,new T(f,f));break}k.stateAfter=null}function Fc(e,a,b,c){var d=a,f=a,g=e.doc;"number"==typeof a?f=E(g,Math.max(g.first,Math.min(a,g.first+g.size-1))):d=$(a);if(null!=d&&c(f,d))eb(e,d,b);else return null;return f}
function Gc(e,a){for(var b=e.doc.sel.ranges,c=[],d=0;d<b.length;d++){for(var f=a(b[d]);c.length&&0>=Q(f.from,V(c).to);){var g=c.pop();if(0>Q(g.from,f.from)){f.from=g.from;break}}c.push(f)}La(e,function(){for(var a=c.length-1;0<=a;a--)xc(e.doc,"",c[a].from,c[a].to,"+delete");db(e)})}function td(e,a,b,c,d){function f(a){var c=(d?dd:se)(h,k,b,!0);if(null==c){if(a=!a)a=g+b,a<e.first||a>=e.first+e.size?a=l=!1:(g=a,a=h=E(e,a));if(a)k=d?(0>b?mc:lc)(h):0>b?h.text.length:0;else return l=!1}else k=c;return!0}
var g=a.line,k=a.ch;a=b;var h=E(e,g),l=!0;if("char"==c)f();else if("column"==c)f(!0);else if("word"==c||"group"==c){var m=null;c="group"==c;for(var q=!0;!(0>b)||f(!q);q=!1){var r=h.text.charAt(k)||"\n",r=Hc(r)?"w":c&&"\n"==r?"n":!c||/\s/.test(r)?null:"p";!c||q||r||(r="s");if(m&&m!=r){0>b&&(b=1,f());break}r&&(m=r);if(0<b&&!f(!q))break}}a=hc(e,D(g,k),a,!0);l||(a.hitSide=!0);return a}function te(a,b,c,d){var f=a.doc,g=b.left,k;"page"==d?(d=Math.min(a.display.wrapper.clientHeight,window.innerHeight||
document.documentElement.clientHeight),k=b.top+c*(d-(0>c?1.5:0.5)*Za(a.display))):"line"==d&&(k=0<c?b.bottom+3:b.top-3);for(;;){var h=cd(a,g,k);if(!h.outside)break;if(0>c?0>=k:k>=f.height){h.hitSide=!0;break}k+=5*c}return h}function id(a,b){var c=E(a,b.line).text,d=b.ch,f=b.ch;if(c){(0>b.xRel||f==c.length)&&d?--d:++f;for(var g=c.charAt(d),g=Hc(g)?Hc:/\s/.test(g)?function(a){return/\s/.test(a)}:function(a){return!/\s/.test(a)&&!Hc(a)};0<d&&g(c.charAt(d-1));)--d;for(;f<c.length&&g(c.charAt(f));)++f}return new T(D(b.line,
d),D(b.line,f))}function M(e,b,c,d){a.defaults[e]=b;c&&(qb[e]=d?function(a,e,b){b!=Bd&&c(a,e,b)}:c)}function ld(a){return"string"==typeof a?Na[a]:a}function Wb(a,b,c,d,f){if(d&&d.shared)return jf(a,b,c,d,f);if(a.cm&&!a.cm.curOp)return ca(a.cm,Wb)(a,b,c,d,f);var g=new ib(a,f);f=Q(b,c);d&&Ic(d,g);if(0<f||0==f&&!1!==g.clearWhenEmpty)return g;g.replacedWith&&(g.collapsed=!0,g.widgetNode=I("span",[g.replacedWith],"CodeMirror-widget"),d.handleMouseEvents||(g.widgetNode.ignoreEvents=!0),d.insertLeft&&(g.widgetNode.insertLeft=
!0));if(g.collapsed){if(ue(a,b.line,b,c,g)||b.line!=c.line&&ue(a,c.line,b,c,g))throw Error("Inserting collapsed marker partially overlapping an existing one");Ta=!0}g.addToHistory&&me(a,{from:b,to:c,origin:"markText"},a.sel,NaN);var k=b.line,h=a.cm,l;a.iter(k,c.line+1,function(a){h&&g.collapsed&&!h.options.lineWrapping&&Ha(a)==h.display.maxLine&&(l=!0);g.collapsed&&k!=b.line&&Da(a,0);var e=new Jc(g,k==b.line?b.ch:null,k==c.line?c.ch:null);a.markedSpans=a.markedSpans?a.markedSpans.concat([e]):[e];
e.marker.attachLine(a);++k});g.collapsed&&a.iter(b.line,c.line+1,function(b){$a(a,b)&&Da(b,0)});g.clearOnEnter&&N(g,"beforeCursorEnter",function(){g.clear()});g.readOnly&&(ke=!0,(a.history.done.length||a.history.undone.length)&&a.clearHistory());g.collapsed&&(g.id=++kf,g.atomic=!0);if(h){l&&(h.curOp.updateMaxLine=!0);if(g.collapsed)ta(h,b.line,c.line+1);else if(g.className||g.title||g.startStyle||g.endStyle)for(d=b.line;d<=c.line;d++)eb(h,d,"text");g.atomic&&Jd(h.doc);da(h,"markerAdded",h,g)}return g}
function jf(a,b,c,d,f){d=Ic(d);d.shared=!1;var g=[Wb(a,b,c,d,f)],k=g[0],h=d.widgetNode;zb(a,function(a){h&&(d.widgetNode=h.cloneNode(!0));g.push(Wb(a,G(a,b),G(a,c),d,f));for(var e=0;e<a.linked.length;++e)if(a.linked[e].isParent)return;k=V(g)});return new Kc(g,k)}function Jc(a,b,c){this.marker=a;this.from=b;this.to=c}function Xb(a,b){if(a)for(var c=0;c<a.length;++c){var d=a[c];if(d.marker==b)return d}}function pd(a,b){var c=Qa(a,b.from.line)&&E(a,b.from.line).markedSpans,d=Qa(a,b.to.line)&&E(a,b.to.line).markedSpans;
if(!c&&!d)return null;var f=b.from.ch,g=b.to.ch,k=0==Q(b.from,b.to);if(c)for(var h=0,l;h<c.length;++h){var m=c[h],q=m.marker;if(null==m.from||(q.inclusiveLeft?m.from<=f:m.from<f)||m.from==f&&!("bookmark"!=q.type||k&&m.marker.insertLeft)){var r=null==m.to||(q.inclusiveRight?m.to>=f:m.to>f);(l||(l=[])).push(new Jc(q,m.from,r?null:m.to))}}c=l;if(d)for(var h=0,s;h<d.length;++h)if(l=d[h],m=l.marker,null==l.to||(m.inclusiveRight?l.to>=g:l.to>g)||l.from==g&&"bookmark"==m.type&&(!k||l.marker.insertLeft))q=
null==l.from||(m.inclusiveLeft?l.from<=g:l.from<g),(s||(s=[])).push(new Jc(m,q?null:l.from-g,null==l.to?null:l.to-g));d=s;k=1==b.text.length;s=V(b.text).length+(k?f:0);if(c)for(g=0;g<c.length;++g)if(h=c[g],null==h.to)(l=Xb(d,h.marker),l)?k&&(h.to=null==l.to?null:l.to+s):h.to=f;if(d)for(g=0;g<d.length;++g)h=d[g],null!=h.to&&(h.to+=s),null==h.from?(l=Xb(c,h.marker),l||(h.from=s,k&&(c||(c=[])).push(h))):(h.from+=s,k&&(c||(c=[])).push(h));c&&(c=ve(c));d&&d!=c&&(d=ve(d));f=[c];if(!k){var k=b.text.length-
2,w;if(0<k&&c)for(g=0;g<c.length;++g)null==c[g].to&&(w||(w=[])).push(new Jc(c[g].marker,null,null));for(g=0;g<k;++g)f.push(w);f.push(d)}return f}function ve(a){for(var b=0;b<a.length;++b){var c=a[b];null!=c.from&&c.from==c.to&&!1!==c.marker.clearWhenEmpty&&a.splice(b--,1)}return a.length?a:null}function oe(a,b){var c;if(c=b["spans_"+a.id]){for(var d=0,f=[];d<b.text.length;++d)f.push(lf(c[d]));c=f}else c=null;d=pd(a,b);if(!c)return d;if(!d)return c;for(f=0;f<c.length;++f){var g=c[f],h=d[f];if(g&&h){var k=
0;a:for(;k<h.length;++k){for(var l=h[k],m=0;m<g.length;++m)if(g[m].marker==l.marker)continue a;g.push(l)}}else h&&(c[f]=h)}return c}function gf(a,b,c){var d=null;a.iter(b.line,c.line+1,function(a){if(a.markedSpans)for(var e=0;e<a.markedSpans.length;++e){var b=a.markedSpans[e].marker;!b.readOnly||d&&-1!=ha(d,b)||(d||(d=[])).push(b)}});if(!d)return null;a=[{from:b,to:c}];for(b=0;b<d.length;++b){c=d[b];for(var f=c.find(0),g=0;g<a.length;++g){var h=a[g];if(!(0>Q(h.to,f.from)||0<Q(h.from,f.to))){var k=
[g,1],l=Q(h.from,f.from),m=Q(h.to,f.to);(0>l||!c.inclusiveLeft&&!l)&&k.push({from:h.from,to:f.from});(0<m||!c.inclusiveRight&&!m)&&k.push({from:f.to,to:h.to});a.splice.apply(a,k);g+=k.length-1}}}return a}function we(a){var b=a.markedSpans;if(b){for(var c=0;c<b.length;++c)b[c].marker.detachLine(a);a.markedSpans=null}}function xe(a,b){if(b){for(var c=0;c<b.length;++c)b[c].marker.attachLine(a);a.markedSpans=b}}function ye(a,b){var c=a.lines.length-b.lines.length;if(0!=c)return c;var c=a.find(),d=b.find(),
f=Q(c.from,d.from)||(a.inclusiveLeft?-1:0)-(b.inclusiveLeft?-1:0);return f?-f:(c=Q(c.to,d.to)||(a.inclusiveRight?1:0)-(b.inclusiveRight?1:0))?c:b.id-a.id}function bb(a,b){var c=Ta&&a.markedSpans,d;if(c)for(var f,g=0;g<c.length;++g)f=c[g],f.marker.collapsed&&null==(b?f.from:f.to)&&(!d||0>ye(d,f.marker))&&(d=f.marker);return d}function ue(a,b,c,d,f){a=E(a,b);if(a=Ta&&a.markedSpans)for(b=0;b<a.length;++b){var g=a[b];if(g.marker.collapsed){var h=g.marker.find(0),k=Q(h.from,c)||(g.marker.inclusiveLeft?
-1:0)-(f.inclusiveLeft?-1:0),l=Q(h.to,d)||(g.marker.inclusiveRight?1:0)-(f.inclusiveRight?1:0);if(!(0<=k&&0>=l||0>=k&&0<=l)&&(0>=k&&0<(Q(h.to,c)||(g.marker.inclusiveRight?1:0)-(f.inclusiveLeft?-1:0))||0<=k&&0>(Q(h.from,d)||(g.marker.inclusiveLeft?-1:0)-(f.inclusiveRight?1:0))))return!0}}}function Ha(a){for(var b;b=bb(a,!0);)a=b.find(-1,!0).line;return a}function Vc(a,b){var c=E(a,b),d=Ha(c);return c==d?b:$(d)}function Fd(a,b){if(b>a.lastLine())return b;var c=E(a,b),d;if(!$a(a,c))return b;for(;d=bb(c,
!1);)c=d.find(1,!0).line;return $(c)+1}function $a(a,b){var c=Ta&&b.markedSpans;if(c)for(var d,f=0;f<c.length;++f)if(d=c[f],d.marker.collapsed&&(null==d.from||!d.marker.widgetNode&&0==d.from&&d.marker.inclusiveLeft&&ud(a,b,d)))return!0}function ud(a,b,c){if(null==c.to)return b=c.marker.find(1,!0),ud(a,b.line,Xb(b.line.markedSpans,c.marker));if(c.marker.inclusiveRight&&c.to==b.text.length)return!0;for(var d,f=0;f<b.markedSpans.length;++f)if(d=b.markedSpans[f],d.marker.collapsed&&!d.marker.widgetNode&&
d.from==c.to&&(null==d.to||d.to!=c.from)&&(d.marker.inclusiveLeft||c.marker.inclusiveRight)&&ud(a,b,d))return!0}function Ob(a){if(null!=a.height)return a.height;Ud(document.body,a.node)||Fa(a.cm.display.measure,I("div",[a.node],null,"position: relative"));return a.height=a.node.offsetHeight}function mf(a,b,c,d){var f=new Lc(a,c,d);f.noHScroll&&(a.display.alignWidgets=!0);Fc(a,b,"widget",function(b){var c=b.widgets||(b.widgets=[]);null==f.insertAt?c.push(f):c.splice(Math.min(c.length-1,Math.max(0,
f.insertAt)),0,f);f.line=b;$a(a.doc,b)||(c=Ea(b)<a.doc.scrollTop,Da(b,b.height+Ob(f)),c&&Dc(a,null,f.height),a.curOp.forceUpdate=!0);return!0});return f}function ze(e,b,c,d,f,g){var h=c.flattenSpans;null==h&&(h=e.options.flattenSpans);var k=0,l=null,m=new Mc(b,e.options.tabSize),q;for(""==b&&c.blankLine&&c.blankLine(d);!m.eol();){m.pos>e.options.maxHighlightLength?(h=!1,g&&Yc(e,b,d,m.pos),m.pos=b.length,q=null):q=c.token(m,d);if(e.options.addModeClass){var r=a.innerMode(c,d).mode.name;r&&(q="m-"+
(q?r+" "+q:r))}h&&l==q||(k<m.start&&f(m.start,l),k=m.start,l=q);m.start=m.pos}for(;k<m.pos;)e=Math.min(m.pos,k+5E4),f(e,l),k=e}function Ld(a,b,c,d){var f=[a.state.modeGen];ze(a,b.text,a.doc.mode,c,function(a,e){f.push(a,e)},d);for(c=0;c<a.state.overlays.length;++c){var g=a.state.overlays[c],h=1,k=0;ze(a,b.text,g.mode,!0,function(a,e){for(var b=h;k<a;){var c=f[h];c>a&&f.splice(h,1,a,f[h+1],c);h+=2;k=Math.min(a,c)}if(e)if(g.opaque)f.splice(b,h-b,a,e),h=b+2;else for(;b<h;b+=2)c=f[b+1],f[b+1]=c?c+" "+
e:e})}return f}function Ae(a,b){b.styles&&b.styles[0]==a.state.modeGen||(b.styles=Ld(a,b,b.stateAfter=Lb(a,$(b))));return b.styles}function Yc(a,b,c,d){var f=a.doc.mode,g=new Mc(b,a.options.tabSize);g.start=g.pos=d||0;for(""==b&&f.blankLine&&f.blankLine(c);!g.eol()&&g.pos<=a.options.maxHighlightLength;)f.token(g,c),g.start=g.pos}function Be(a,b){if(!a)return null;for(;;){var c=a.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!c)break;a=a.slice(0,c.index)+a.slice(c.index+c[0].length);var d=c[1]?"bgClass":
"textClass";null==b[d]?b[d]=c[2]:RegExp("(?:^|s)"+c[2]+"(?:$|s)").test(b[d])||(b[d]+=" "+c[2])}if(/^\s*$/.test(a))return null;c=b.cm.options.addModeClass?nf:of;return c[a]||(c[a]=a.replace(/\S+/g,"cm-$&"))}function Gd(a,b){var c=I("span",null,null,qa?"padding-right: .1px":null),c={pre:I("pre",[c]),content:c,col:0,pos:0,cm:a};b.measure={};for(var d=0;d<=(b.rest?b.rest.length:0);d++){var f=d?b.rest[d-1]:b.line,g;c.pos=0;c.addToken=pf;(na||qa)&&a.getOption("lineWrapping")&&(c.addToken=qf(c.addToken));
var h;if(null!=vd)h=vd;else{h=Fa(a.display.measure,document.createTextNode("A\u062eA"));var k=Nb(h,0,1).getBoundingClientRect();h=k.left==k.right?!1:vd=3>Nb(h,1,2).getBoundingClientRect().right-k.right}h&&(g=Ga(f))&&(c.addToken=rf(c.addToken,g));c.map=[];a:{h=c;var k=Ae(a,f),l=f.markedSpans,f=f.text,m=0;if(l)for(var q=f.length,r=0,s=1,w="",v=void 0,A=0,R=void 0,B=void 0,D=void 0,ea=void 0,C=void 0;;){if(A==r){for(var R=B=D=ea="",C=null,A=Infinity,H=[],G=0;G<l.length;++G){var E=l[G],F=E.marker;E.from<=
r&&(null==E.to||E.to>r)?(null!=E.to&&A>E.to&&(A=E.to,B=""),F.className&&(R+=" "+F.className),F.startStyle&&E.from==r&&(D+=" "+F.startStyle),F.endStyle&&E.to==A&&(B+=" "+F.endStyle),F.title&&!ea&&(ea=F.title),F.collapsed&&(!C||0>ye(C.marker,F))&&(C=E)):E.from>r&&A>E.from&&(A=E.from);"bookmark"==F.type&&E.from==r&&F.widgetNode&&H.push(F)}if(C&&(C.from||0)==r&&(Ce(h,(null==C.to?q+1:C.to)-r,C.marker,null==C.from),null==C.to))break a;if(!C&&H.length)for(G=0;G<H.length;++G)Ce(h,0,H[G])}if(r>=q)break;for(H=
Math.min(q,A);;){if(w){G=r+w.length;C||(E=G>H?w.slice(0,H-r):w,h.addToken(h,E,v?v+R:R,D,r+E.length==A?B:"",ea));if(G>=H){w=w.slice(H-r);r=H;break}r=G;D=""}w=f.slice(m,m=k[s++]);v=Be(k[s++],h)}}else for(var s=1;s<k.length;s+=2)h.addToken(h,f.slice(m,m=k[s]),Be(k[s+1],h))}0==c.map.length&&c.map.push(0,0,c.content.appendChild(sf(a.display.measure)));0==d?(b.measure.map=c.map,b.measure.cache={}):((b.measure.maps||(b.measure.maps=[])).push(c.map),(b.measure.caches||(b.measure.caches=[])).push({}))}aa(a,
"renderLine",a,b.line,c.pre);return c}function pf(a,b,c,d,f,g){if(b){var h=a.cm.options.specialChars,k=!1;if(h.test(b))for(var l=document.createDocumentFragment(),m=0;;){h.lastIndex=m;var q=h.exec(b),r=q?q.index-m:b.length-m;if(r){var s=document.createTextNode(b.slice(m,m+r));fa?l.appendChild(I("span",[s])):l.appendChild(s);a.map.push(a.pos,a.pos+r,s);a.col+=r;a.pos+=r}if(!q)break;m+=r+1;"\t"==q[0]?(s=a.cm.options.tabSize,q=s-a.col%s,s=l.appendChild(I("span",re(q),"cm-tab")),a.col+=q):(s=a.cm.options.specialCharPlaceholder(q[0]),
fa?l.appendChild(I("span",[s])):l.appendChild(s),a.col+=1);a.map.push(a.pos,a.pos+1,s);a.pos++}else{a.col+=b.length;var l=document.createTextNode(b);a.map.push(a.pos,a.pos+b.length,l);fa&&(k=!0);a.pos+=b.length}if(c||d||f||k)return b=c||"",d&&(b+=d),f&&(b+=f),d=I("span",[l],b),g&&(d.title=g),a.content.appendChild(d);a.content.appendChild(l)}}function qf(a){function b(a){for(var e=" ",c=0;c<a.length-2;++c)e+=c%2?" ":"\u00a0";return e+" "}return function(c,d,f,g,h,k){a(c,d.replace(/ {3,}/g,b),f,g,h,
k)}}function rf(a,b){return function(c,d,f,g,h,k){f=f?f+" cm-force-border":"cm-force-border";for(var l=c.pos,m=l+d.length;;){for(var q=0;q<b.length;q++){var r=b[q];if(r.to>l&&r.from<=l)break}if(r.to>=m)return a(c,d,f,g,h,k);a(c,d.slice(0,r.to-l),f,g,null,k);g=null;d=d.slice(r.to-l);l=r.to}}}function Ce(a,b,c,d){if(c=!d&&c.widgetNode)a.map.push(a.pos,a.pos+b,c),a.content.appendChild(c);a.pos+=b}function qe(a,b){return 0==b.from.ch&&0==b.to.ch&&""==V(b.text)&&(!a.cm||a.cm.options.wholeLineUpdateBefore)}
function sd(a,b,c,d){function f(a,e,c){a.text=e;a.stateAfter&&(a.stateAfter=null);a.styles&&(a.styles=null);null!=a.order&&(a.order=null);we(a);xe(a,c);e=d?d(a):1;e!=a.height&&Da(a,e);da(a,"change",a,b)}var g=b.from,h=b.to,k=b.text,l=E(a,g.line),m=E(a,h.line),q=V(k),r=c?c[k.length-1]:null,s=h.line-g.line;if(qe(a,b)){for(var w=0,v=[];w<k.length-1;++w)v.push(new jb(k[w],c?c[w]:null,d));f(m,m.text,r);s&&a.remove(g.line,s);v.length&&a.insert(g.line,v)}else if(l==m)if(1==k.length)f(l,l.text.slice(0,g.ch)+
q+l.text.slice(h.ch),r);else{v=[];for(w=1;w<k.length-1;++w)v.push(new jb(k[w],c?c[w]:null,d));v.push(new jb(q+l.text.slice(h.ch),r,d));f(l,l.text.slice(0,g.ch)+k[0],c?c[0]:null);a.insert(g.line+1,v)}else if(1==k.length)f(l,l.text.slice(0,g.ch)+k[0]+m.text.slice(h.ch),c?c[0]:null),a.remove(g.line+1,s);else{f(l,l.text.slice(0,g.ch)+k[0],c?c[0]:null);f(m,q+m.text.slice(h.ch),r);w=1;for(v=[];w<k.length-1;++w)v.push(new jb(k[w],c?c[w]:null,d));1<s&&a.remove(g.line+1,s-1);a.insert(g.line+1,v)}da(a,"change",
a,b)}function Yb(a){this.lines=a;this.parent=null;for(var b=0,c=0;b<a.length;++b)a[b].parent=this,c+=a[b].height;this.height=c}function Zb(a){this.children=a;for(var b=0,c=0,d=0;d<a.length;++d){var f=a[d],b=b+f.chunkSize(),c=c+f.height;f.parent=this}this.size=b;this.height=c;this.parent=null}function zb(a,b,c){function d(a,e,f){if(a.linked)for(var g=0;g<a.linked.length;++g){var h=a.linked[g];if(h.doc!=e){var k=f&&h.sharedHist;if(!c||k)b(h.doc,k),d(h.doc,a,k)}}}d(a,null,!0)}function Ad(a,b){if(b.cm)throw Error("This document is already in use.");
a.doc=b;b.cm=a;g(a);c(a);a.options.lineWrapping||A(a);a.options.mode=b.modeOption;ta(a)}function E(a,b){b-=a.first;if(0>b||b>=a.size)throw Error("There is no line "+(b+a.first)+" in the document.");for(var c=a;!c.lines;)for(var d=0;;++d){var f=c.children[d],g=f.chunkSize();if(b<g){c=f;break}b-=g}return c.lines[b]}function Vb(a,b,c){var d=[],f=b.line;a.iter(b.line,c.line+1,function(a){a=a.text;f==c.line&&(a=a.slice(0,c.ch));f==b.line&&(a=a.slice(b.ch));d.push(a);++f});return d}function wd(a,b,c){var d=
[];a.iter(b,c,function(a){d.push(a.text)});return d}function Da(a,b){var c=b-a.height;if(c)for(var d=a;d;d=d.parent)d.height+=c}function $(a){if(null==a.parent)return null;var b=a.parent;a=ha(b.lines,a);for(var c=b.parent;c;b=c,c=c.parent)for(var d=0;c.children[d]!=b;++d)a+=c.children[d].chunkSize();return a+b.first}function cb(a,b){var c=a.first;a:do{for(var d=0;d<a.children.length;++d){var f=a.children[d],g=f.height;if(b<g){a=f;continue a}b-=g;c+=f.chunkSize()}return c}while(!a.lines);for(d=0;d<
a.lines.length;++d){f=a.lines[d].height;if(b<f)break;b-=f}return c+d}function Ea(a){a=Ha(a);for(var b=0,c=a.parent,d=0;d<c.lines.length;++d){var f=c.lines[d];if(f==a)break;else b+=f.height}for(a=c.parent;a;c=a,a=c.parent)for(d=0;d<a.children.length&&(f=a.children[d],f!=c);++d)b+=f.height;return b}function Ga(a){var b=a.order;null==b&&(b=a.order=tf(a.text));return b}function Nc(a){this.done=[];this.undone=[];this.undoDepth=Infinity;this.lastModTime=this.lastSelTime=0;this.lastOrigin=this.lastSelOrigin=
this.lastOp=null;this.generation=this.maxGeneration=a||1}function qd(a,b){var c={from:ua(b.from),to:yb(b),text:Vb(a,b.from,b.to)};De(a,c,b.from.line,b.to.line+1);zb(a,function(a){De(a,c,b.from.line,b.to.line+1)},!0);return c}function Hd(a){for(;a.length;)if(V(a).ranges)a.pop();else break}function me(a,b,c,d){var f=a.history;f.undone.length=0;var g=+new Date,h,k;if(k=f.lastOp==d||f.lastOrigin==b.origin&&b.origin&&("+"==b.origin.charAt(0)&&a.cm&&f.lastModTime>g-a.cm.options.historyEventDelay||"*"==
b.origin.charAt(0)))f.lastOp==d?(Hd(f.done),h=V(f.done)):f.done.length&&!V(f.done).ranges?h=V(f.done):1<f.done.length&&!f.done[f.done.length-2].ranges?(f.done.pop(),h=V(f.done)):h=void 0,k=h;if(k){var l=V(h.changes);0==Q(b.from,b.to)&&0==Q(b.from,l.to)?l.to=yb(b):h.changes.push(qd(a,b))}else for((h=V(f.done))&&h.ranges||gc(a.sel,f.done),h={changes:[qd(a,b)],generation:f.generation},f.done.push(h);f.done.length>f.undoDepth;)f.done.shift(),f.done[0].ranges||f.done.shift();f.done.push(c);f.generation=
++f.maxGeneration;f.lastModTime=f.lastSelTime=g;f.lastOp=d;f.lastOrigin=f.lastSelOrigin=b.origin;l||aa(a,"historyAdded")}function gc(a,b){var c=V(b);c&&c.ranges&&c.equals(a)||b.push(a)}function De(a,b,c,d){var f=b["spans_"+a.id],g=0;a.iter(Math.max(a.first,c),Math.min(a.first+a.size,d),function(c){c.markedSpans&&((f||(f=b["spans_"+a.id]={}))[g]=c.markedSpans);++g})}function lf(a){if(!a)return null;for(var b=0,c;b<a.length;++b)a[b].marker.explicitlyCleared?c||(c=a.slice(0,b)):c&&c.push(a[b]);return c?
c.length?c:null:a}function Ab(a,b,c){for(var d=0,f=[];d<a.length;++d){var g=a[d];if(g.ranges)f.push(c?L.prototype.deepCopy.call(g):g);else{var g=g.changes,h=[];f.push({changes:h});for(var k=0;k<g.length;++k){var l=g[k],m;h.push({from:l.from,to:l.to,text:l.text});if(b)for(var q in l)(m=q.match(/^spans_(\d+)$/))&&-1<ha(b,Number(m[1]))&&(V(h)[q]=l[q],delete l[q])}}}return f}function Ee(a,b,c,d){c<a.line?a.line+=d:b<a.line&&(a.line=b,a.ch=0)}function Fe(a,b,c,d){for(var f=0;f<a.length;++f){var g=a[f],
h=!0;if(g.ranges){g.copied||(g=a[f]=g.deepCopy(),g.copied=!0);for(var k=0;k<g.ranges.length;k++)Ee(g.ranges[k].anchor,b,c,d),Ee(g.ranges[k].head,b,c,d)}else{for(k=0;k<g.changes.length;++k){var l=g.changes[k];if(c<l.from.line)l.from=D(l.from.line+d,l.from.ch),l.to=D(l.to.line+d,l.to.ch);else if(b<=l.to.line){h=!1;break}}h||(a.splice(0,f+1),f=0)}}}function ne(a,b){var c=b.from.line,d=b.to.line,f=b.text.length-(d-c)-1;Fe(a.done,c,d,f);Fe(a.undone,c,d,f)}function kd(a){return null!=a.defaultPrevented?
a.defaultPrevented:!1==a.returnValue}function be(a){var b=a.which;null==b&&(a.button&1?b=1:a.button&2?b=3:a.button&4&&(b=2));sb&&a.ctrlKey&&1==b&&(b=3);return b}function da(a,b){function c(a){return function(){a.apply(null,f)}}var d=a._handlers&&a._handlers[b];if(d){var f=Array.prototype.slice.call(arguments,2);Ua||(++nc,Ua=[],setTimeout(uf,0));for(var g=0;g<d.length;++g)Ua.push(c(d[g]))}}function uf(){--nc;var a=Ua;Ua=null;for(var b=0;b<a.length;++b)a[b]()}function Ja(a,b,c){aa(a,c||b.type,a,b);
return kd(b)||b.codemirrorIgnore}function xa(a,b){var c=a._handlers&&a._handlers[b];return c&&0<c.length}function Bb(a){a.prototype.on=function(a,e){N(this,a,e)};a.prototype.off=function(a,e){Va(this,a,e)}}function Qc(){this.id=null}function ce(a,b,c){for(var d=0,f=0;;){var g=a.indexOf("\t",d);-1==g&&(g=a.length);var h=g-d;if(g==a.length||f+h>=b)return d+Math.min(h,b-f);f+=g-d;f+=c-f%c;d=g+1;if(f>=b)return d}}function re(a){for(;Oc.length<=a;)Oc.push(V(Oc)+" ");return Oc[a]}function V(a){return a[a.length-
1]}function ha(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return c;return-1}function rd(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=b(a[d],d);return c}function Ge(a,b){var c;Object.create?c=Object.create(a):(c=function(){},c.prototype=a,c=new c);b&&Ic(b,c);return c}function Ic(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function Ba(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b)}}function He(a){for(var b in a)if(a.hasOwnProperty(b)&&
a[b])return!1;return!0}function Mb(a){return 768<=a.charCodeAt(0)&&vf.test(a)}function I(a,b,c,d){a=document.createElement(a);c&&(a.className=c);d&&(a.style.cssText=d);if("string"==typeof b)a.appendChild(document.createTextNode(b));else if(b)for(c=0;c<b.length;++c)a.appendChild(b[c]);return a}function ab(a){for(var b=a.childNodes.length;0<b;--b)a.removeChild(a.firstChild);return a}function Fa(a,b){return ab(a).appendChild(b)}function Ud(a,b){if(a.contains)return a.contains(b);for(;b=b.parentNode;)if(b==
a)return!0}function Ra(){return document.activeElement}function Ib(a){if(null!=Sb)return Sb;var b=I("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");Fa(a,b);b.offsetWidth&&(Sb=b.offsetHeight-b.clientHeight);return Sb||0}function sf(a){if(null==xd){var b=I("span","\u200b");Fa(a,I("span",[b,document.createTextNode("x")]));0!=a.firstChild.offsetHeight&&(xd=1>=b.offsetWidth&&2<b.offsetHeight&&!Eb)}return xd?I("span","\u200b"):I("span","\u00a0",null,"display: inline-block; width: 1px; margin-right: -1px")}
function Pe(a,b,c,d){if(!a)return d(b,c,"ltr");for(var f=!1,g=0;g<a.length;++g){var h=a[g];if(h.from<c&&h.to>b||b==c&&h.to==b)d(Math.max(h.from,b),Math.min(h.to,c),1==h.level?"rtl":"ltr"),f=!0}f||d(b,c,"ltr")}function $c(a){return a.level%2?a.to:a.from}function ad(a){return a.level%2?a.from:a.to}function lc(a){return(a=Ga(a))?$c(a[0]):0}function mc(a){var b=Ga(a);return b?ad(V(b)):a.text.length}function Ie(a,b){var c=E(a.doc,b),d=Ha(c);d!=c&&(b=$(d));d=(c=Ga(d))?c[0].level%2?mc(d):lc(d):0;return D(b,
d)}function bd(a,b){Pb=null;for(var c=0,d;c<a.length;++c){var f=a[c];if(f.from<b&&f.to>b)return c;if(f.from==b||f.to==b)if(null==d)d=c;else{var g;g=f.level;var h=a[d].level,k=a[0].level;g=g==k?!0:h==k?!1:g<h;if(g)return f.from!=f.to&&(Pb=d),c;f.from!=f.to&&(Pb=c);break}}return d}function yd(a,b,c,d){if(!d)return b+c;do b+=c;while(0<b&&Mb(a.text.charAt(b)));return b}function dd(a,b,c,d){var f=Ga(a);if(!f)return se(a,b,c,d);var g=bd(f,b),h=f[g];for(b=yd(a,b,h.level%2?-c:c,d);;){if(b>h.from&&b<h.to)return b;
if(b==h.from||b==h.to){if(bd(f,b)==g)return b;h=f[g+c];return 0<c==h.level%2?h.to:h.from}h=f[g+=c];if(!h)return null;b=0<c==h.level%2?yd(a,h.to,-1,d):yd(a,h.from,1,d)}}function se(a,b,c,d){b+=c;if(d)for(;0<b&&Mb(a.text.charAt(b));)b+=c;return 0>b||b>a.text.length?null:b}var Tb=/gecko\/\d/i.test(navigator.userAgent),wa=/MSIE \d/.test(navigator.userAgent),Eb=wa&&(null==document.documentMode||8>document.documentMode),fa=wa&&(null==document.documentMode||9>document.documentMode),bf=wa&&(null==document.documentMode||
10>document.documentMode),wf=/Trident\/([7-9]|\d{2,})\./.test(navigator.userAgent),na=wa||wf,qa=/WebKit\//.test(navigator.userAgent),xf=qa&&/Qt\/\d+\.\d+/.test(navigator.userAgent),yf=/Chrome\//.test(navigator.userAgent),ya=/Opera\//.test(navigator.userAgent),ae=/Apple Computer/.test(navigator.vendor),Uc=/KHTML\//.test(navigator.userAgent),Me=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),Ne=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),Ve=/PhantomJS/.test(navigator.userAgent),
Db=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),Pc=Db||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),sb=Db||/Mac/.test(navigator.platform),zf=/win/i.test(navigator.platform),kb=ya&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);kb&&(kb=Number(kb[1]));kb&&15<=kb&&(ya=!1,qa=!0);var Je=sb&&(xf||ya&&(null==kb||12.11>kb)),jd=Tb||na&&!fa,ke=!1,Ta=!1,D=a.Pos=function(a,b){if(!(this instanceof D))return new D(a,b);this.line=a;this.ch=
b},Q=a.cmpPos=function(a,b){return a.line-b.line||a.ch-b.ch};L.prototype={primary:function(){return this.ranges[this.primIndex]},equals:function(a){if(a==this)return!0;if(a.primIndex!=this.primIndex||a.ranges.length!=this.ranges.length)return!1;for(var b=0;b<this.ranges.length;b++){var c=this.ranges[b],d=a.ranges[b];if(0!=Q(c.anchor,d.anchor)||0!=Q(c.head,d.head))return!1}return!0},deepCopy:function(){for(var a=[],b=0;b<this.ranges.length;b++)a[b]=new T(ua(this.ranges[b].anchor),ua(this.ranges[b].head));
return new L(a,this.primIndex)},somethingSelected:function(){for(var a=0;a<this.ranges.length;a++)if(!this.ranges[a].empty())return!0;return!1},contains:function(a,b){b||(b=a);for(var c=0;c<this.ranges.length;c++){var d=this.ranges[c];if(0<=Q(b,d.from())&&0>=Q(a,d.to()))return c}return-1}};T.prototype={from:function(){return Xa(this.anchor,this.head)},to:function(){return Pa(this.anchor,this.head)},empty:function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch}};var Od={left:0,
right:0,top:0,bottom:0},fb,Ue=0,vc,uc,$d=0,yc=0,za=null;na?za=-0.53:Tb?za=15:yf?za=-0.7:ae&&(za=-1/3);var ge,md=null,nd,yb=a.changeEnd=function(a){return a.text?D(a.from.line+a.text.length-1,V(a.text).length+(1==a.text.length?a.from.ch:0)):a.to};a.prototype={constructor:a,posFromMouse:function(a){return gb(this,a,!0)},focus:function(){window.focus();oa(this);Rb(this)},setOption:function(a,b){var c=this.options,d=c[a];if(c[a]!=b||"mode"==a)c[a]=b,qb.hasOwnProperty(a)&&ca(this,qb[a])(this,b,d)},getOption:function(a){return this.options[a]},
getDoc:function(){return this.doc},addKeyMap:function(a,b){this.state.keyMaps[b?"push":"unshift"](a)},removeKeyMap:function(a){for(var b=this.state.keyMaps,c=0;c<b.length;++c)if(b[c]==a||"string"!=typeof b[c]&&b[c].name==a)return b.splice(c,1),!0},addOverlay:ba(function(e,b){var c=e.token?e:a.getMode(this.options,e);if(c.startState)throw Error("Overlays may not be stateful.");this.state.overlays.push({mode:c,modeSpec:e,opaque:b&&b.opaque});this.state.modeGen++;ta(this)}),removeOverlay:ba(function(a){for(var b=
this.state.overlays,c=0;c<b.length;++c){var d=b[c].modeSpec;if(d==a||"string"==typeof a&&d.name==a){b.splice(c,1);this.state.modeGen++;ta(this);break}}}),indentLine:ba(function(a,b,c){"string"!=typeof b&&"number"!=typeof b&&(b=null==b?this.options.smartIndent?"smart":"prev":b?"add":"subtract");Qa(this.doc,a)&&sc(this,a,b,c)}),indentSelection:ba(function(a){for(var b=this.doc.sel.ranges,c=-1,d=0;d<b.length;d++){var f=b[d];if(f.empty())f.head.line>c&&(sc(this,f.head.line,a,!0),c=f.head.line,d==this.doc.sel.primIndex&&
db(this));else for(var g=Math.max(c,f.from().line),c=f.to(),c=Math.min(this.lastLine(),c.line-(c.ch?0:1))+1;g<c;++g)sc(this,g,a)}}),getTokenAt:function(a,b){var c=this.doc;a=G(c,a);for(var d=Lb(this,a.line,b),f=this.doc.mode,c=E(c,a.line),c=new Mc(c.text,this.options.tabSize);c.pos<a.ch&&!c.eol();){c.start=c.pos;var g=f.token(c,d)}return{start:c.start,end:c.pos,string:c.current(),type:g||null,state:d}},getTokenTypeAt:function(a){a=G(this.doc,a);var b=Ae(this,E(this.doc,a.line)),c=0,d=(b.length-1)/
2;a=a.ch;if(0==a)return b[2];for(;;){var f=c+d>>1;if((f?b[2*f-1]:0)>=a)d=f;else if(b[2*f+1]<a)c=f+1;else return b[2*f+2]}},getModeAt:function(e){var b=this.doc.mode;return b.innerMode?a.innerMode(b,this.getTokenAt(e).state).mode:b},getHelper:function(a,b){return this.getHelpers(a,b)[0]},getHelpers:function(a,b){var c=[];if(!lb.hasOwnProperty(b))return lb;var d=lb[b],f=this.getModeAt(a);if("string"==typeof f[b])d[f[b]]&&c.push(d[f[b]]);else if(f[b])for(var g=0;g<f[b].length;g++){var h=d[f[b][g]];h&&
c.push(h)}else f.helperType&&d[f.helperType]?c.push(d[f.helperType]):d[f.name]&&c.push(d[f.name]);for(g=0;g<d._global.length;g++)h=d._global[g],h.pred(f,this)&&-1==ha(c,h.val)&&c.push(h.val);return c},getStateAfter:function(a,b){var c=this.doc;a=Math.max(c.first,Math.min(null==a?c.first+c.size-1:a,c.first+c.size-1));return Lb(this,a+1,b)},cursorCoords:function(a,b){var c;c=this.doc.sel.primary();c=null==a?c.head:"object"==typeof a?G(this.doc,a):a?c.from():c.to();return Oa(this,c,b||"page")},charCoords:function(a,
b){return ic(this,G(this.doc,a),b||"page")},coordsChar:function(a,b){a=Rd(this,a,b||"page");return cd(this,a.left,a.top)},lineAtHeight:function(a,b){a=Rd(this,{top:a,left:0},b||"page").top;return cb(this.doc,a+this.display.viewOffset)},heightAtLine:function(a,b){var c=!1,d=this.doc.first+this.doc.size-1;a<this.doc.first?a=this.doc.first:a>d&&(a=d,c=!0);d=E(this.doc,a);return Zc(this,d,{top:0,left:0},b||"page").top+(c?this.doc.height-Ea(d):0)},defaultTextHeight:function(){return Za(this.display)},
defaultCharWidth:function(){return Gb(this.display)},setGutterMarker:ba(function(a,b,c){return Fc(this,a,"gutter",function(a){var e=a.gutterMarkers||(a.gutterMarkers={});e[b]=c;!c&&He(e)&&(a.gutterMarkers=null);return!0})}),clearGutter:ba(function(a){var b=this,c=b.doc,d=c.first;c.iter(function(c){c.gutterMarkers&&c.gutterMarkers[a]&&(c.gutterMarkers[a]=null,eb(b,d,"gutter"),He(c.gutterMarkers)&&(c.gutterMarkers=null));++d})}),addLineClass:ba(function(a,b,c){return Fc(this,a,"class",function(a){var e=
"text"==b?"textClass":"background"==b?"bgClass":"wrapClass";if(a[e]){if(RegExp("(?:^|\\s)"+c+"(?:$|\\s)").test(a[e]))return!1;a[e]+=" "+c}else a[e]=c;return!0})}),removeLineClass:ba(function(a,b,c){return Fc(this,a,"class",function(a){var e="text"==b?"textClass":"background"==b?"bgClass":"wrapClass",d=a[e];if(d)if(null==c)a[e]=null;else{var f=d.match(RegExp("(?:^|\\s+)"+c+"(?:$|\\s+)"));if(!f)return!1;var g=f.index+f[0].length;a[e]=d.slice(0,f.index)+(f.index&&g!=d.length?" ":"")+d.slice(g)||null}else return!1;
return!0})}),addLineWidget:ba(function(a,b,c){return mf(this,a,b,c)}),removeLineWidget:function(a){a.clear()},lineInfo:function(a){if("number"==typeof a){if(!Qa(this.doc,a))return null;var b=a;a=E(this.doc,a);if(!a)return null}else if(b=$(a),null==b)return null;return{line:b,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(a,
b,c,d,f){var g=this.display;a=Oa(this,G(this.doc,a));var h=a.bottom,k=a.left;b.style.position="absolute";g.sizer.appendChild(b);if("over"==d)h=a.top;else if("above"==d||"near"==d){var l=Math.max(g.wrapper.clientHeight,this.doc.height),m=Math.max(g.sizer.clientWidth,g.lineSpace.clientWidth);("above"==d||a.bottom+b.offsetHeight>l)&&a.top>b.offsetHeight?h=a.top-b.offsetHeight:a.bottom+b.offsetHeight<=l&&(h=a.bottom);k+b.offsetWidth>m&&(k=m-b.offsetWidth)}b.style.top=h+"px";b.style.left=b.style.right=
"";"right"==f?(k=g.sizer.clientWidth-b.offsetWidth,b.style.right="0px"):("left"==f?k=0:"middle"==f&&(k=(g.sizer.clientWidth-b.offsetWidth)/2),b.style.left=k+"px");c&&(a=oc(this,k,h,k+b.offsetWidth,h+b.offsetHeight),null!=a.scrollTop&&Qb(this,a.scrollTop),null!=a.scrollLeft&&rb(this,a.scrollLeft))},triggerOnKeyDown:ba(Yd),triggerOnKeyPress:ba(Zd),triggerOnKeyUp:ba(Xd),execCommand:function(a){if(Ac.hasOwnProperty(a))return Ac[a](this)},findPosH:function(a,b,c,d){var f=1;0>b&&(f=-1,b=-b);var g=0;for(a=
G(this.doc,a);g<b&&(a=td(this.doc,a,f,c,d),!a.hitSide);++g);return a},moveH:ba(function(a,b){var c=this;c.extendSelectionsBy(function(d){return c.display.shift||c.doc.extend||d.empty()?td(c.doc,d.head,a,b,c.options.rtlMoveVisually):0>a?d.from():d.to()},mb)}),deleteH:ba(function(a,b){var c=this.doc;this.doc.sel.somethingSelected()?c.replaceSelection("",null,"+delete"):Gc(this,function(d){var f=td(c,d.head,a,b,!1);return 0>a?{from:f,to:d.head}:{from:d.head,to:f}})}),findPosV:function(a,b,c,d){var f=
1;0>b&&(f=-1,b=-b);var g=0;for(a=G(this.doc,a);g<b&&(a=Oa(this,a,"div"),null==d?d=a.left:a.left=d,a=te(this,a,f,c),!a.hitSide);++g);return a},moveV:ba(function(a,b){var c=this,d=this.doc,f=[],g=!c.display.shift&&!d.extend&&d.sel.somethingSelected();d.extendSelectionsBy(function(h){if(g)return 0>a?h.from():h.to();var k=Oa(c,h.head,"div");null!=h.goalColumn&&(k.left=h.goalColumn);f.push(k.left);var l=te(c,k,a,b);"page"==b&&h==d.sel.primary()&&Dc(c,null,ic(c,l,"div").top-k.top);return l},mb);if(f.length)for(var h=
0;h<d.sel.ranges.length;h++)d.sel.ranges[h].goalColumn=f[h]}),toggleOverwrite:function(a){if(null==a||a!=this.state.overwrite)(this.state.overwrite=!this.state.overwrite)?this.display.cursorDiv.className+=" CodeMirror-overwrite":this.display.cursorDiv.className=this.display.cursorDiv.className.replace(" CodeMirror-overwrite",""),aa(this,"overwriteToggle",this,this.state.overwrite)},hasFocus:function(){return Ra()==this.display.input},scrollTo:ba(function(a,b){null==a&&null==b||Ec(this);null!=a&&(this.curOp.scrollLeft=
a);null!=b&&(this.curOp.scrollTop=b)}),getScrollInfo:function(){var a=this.display.scroller,b=Ma;return{left:a.scrollLeft,top:a.scrollTop,height:a.scrollHeight-b,width:a.scrollWidth-b,clientHeight:a.clientHeight-b,clientWidth:a.clientWidth-b}},scrollIntoView:ba(function(a,b){null==a?(a={from:this.doc.sel.primary().head,to:null},null==b&&(b=this.options.cursorScrollMargin)):"number"==typeof a?a={from:D(a,0),to:null}:null==a.from&&(a={from:a,to:null});a.to||(a.to=a.from);a.margin=b||0;if(null!=a.from.line)Ec(this),
this.curOp.scrollToPos=a;else{var c=oc(this,Math.min(a.from.left,a.to.left),Math.min(a.from.top,a.to.top)-a.margin,Math.max(a.from.right,a.to.right),Math.max(a.from.bottom,a.to.bottom)+a.margin);this.scrollTo(c.scrollLeft,c.scrollTop)}}),setSize:ba(function(a,b){function c(a){return"number"==typeof a||/^\d+$/.test(String(a))?a+"px":a}null!=a&&(this.display.wrapper.style.width=c(a));null!=b&&(this.display.wrapper.style.height=c(b));this.options.lineWrapping&&Qd(this);this.curOp.forceUpdate=!0;aa(this,
"refresh",this)}),operation:function(a){return La(this,a)},refresh:ba(function(){var a=this.display.cachedTextHeight;ta(this);Hb(this);this.scrollTo(this.doc.scrollLeft,this.doc.scrollTop);(null==a||0.5<Math.abs(a-Za(this.display)))&&g(this);aa(this,"refresh",this)}),swapDoc:ba(function(a){var b=this.doc;b.cm=null;Ad(this,a);Hb(this);Ca(this);this.scrollTo(a.scrollLeft,a.scrollTop);da(this,"swapDoc",this,b);return b}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},
getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}};Bb(a);var zd=a.defaults={},qb=a.optionHandlers={},Bd=a.Init={toString:function(){return"CodeMirror.Init"}};M("value","",function(a,b){a.setValue(b)},!0);M("mode",null,function(a,b){a.doc.modeOption=b;c(a)},!0);M("indentUnit",2,c,!0);M("indentWithTabs",!1);M("smartIndent",!0);M("tabSize",4,function(a){d(a);Hb(a);ta(a)},!0);M("specialChars",/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\ufeff]/g,
function(a,b){a.options.specialChars=RegExp(b.source+(b.test("\t")?"":"|\t"),"g");a.refresh()},!0);M("specialCharPlaceholder",function(a){var b=I("span","\u2022","cm-invalidchar");b.title="\\u"+a.charCodeAt(0).toString(16);return b},function(a){a.refresh()},!0);M("electricChars",!0);M("rtlMoveVisually",!zf);M("wholeLineUpdateBefore",!0);M("theme","default",function(a){k(a);q(a)},!0);M("keyMap","default",h);M("extraKeys",null);M("lineWrapping",!1,function(a){a.options.lineWrapping?(a.display.wrapper.className+=
" CodeMirror-wrap",a.display.sizer.style.minWidth=""):(a.display.wrapper.className=a.display.wrapper.className.replace(" CodeMirror-wrap",""),A(a));g(a);ta(a);Hb(a);setTimeout(function(){J(a)},100)},!0);M("gutters",[],function(a){B(a.options);q(a)},!0);M("fixedGutter",!0,function(a,b){a.display.gutters.style.left=b?r(a.display)+"px":"0";a.refresh()},!0);M("coverGutterNextToScrollbar",!1,J,!0);M("lineNumbers",!1,function(a){B(a.options);q(a)},!0);M("firstLineNumber",1,q,!0);M("lineNumberFormatter",
function(a){return a},q,!0);M("showCursorWhenSelecting",!1,Xc,!0);M("resetSelectionOnContextMenu",!0);M("readOnly",!1,function(a,b){"nocursor"==b?(Sc(a),a.display.input.blur(),a.display.disabled=!0):(a.display.disabled=!1,b||Ca(a))});M("disableInput",!1,function(a,b){b||Ca(a)},!0);M("dragDrop",!0);M("cursorBlinkRate",530);M("cursorScrollMargin",0);M("cursorHeight",1);M("workTime",100);M("workDelay",100);M("flattenSpans",!0,d,!0);M("addModeClass",!1,d,!0);M("pollInterval",100);M("undoDepth",200,function(a,
b){a.doc.history.undoDepth=b});M("historyEventDelay",1250);M("viewportMargin",10,function(a){a.refresh()},!0);M("maxHighlightLength",1E4,d,!0);M("moveInputWithCursor",!0,function(a,b){b||(a.display.inputDiv.style.top=a.display.inputDiv.style.left=0)});M("tabindex",null,function(a,b){a.display.input.tabIndex=b||""});M("autofocus",null);var Ke=a.modes={},$b=a.mimeModes={};a.defineMode=function(b,c){a.defaults.mode||"null"==b||(a.defaults.mode=b);if(2<arguments.length){c.dependencies=[];for(var d=2;d<
arguments.length;++d)c.dependencies.push(arguments[d])}Ke[b]=c};a.defineMIME=function(a,b){$b[a]=b};a.resolveMode=function(b){if("string"==typeof b&&$b.hasOwnProperty(b))b=$b[b];else if(b&&"string"==typeof b.name&&$b.hasOwnProperty(b.name)){var c=$b[b.name];"string"==typeof c&&(c={name:c});b=Ge(c,b);b.name=c.name}else if("string"==typeof b&&/^[\w\-]+\/[\w\-]+\+xml$/.test(b))return a.resolveMode("application/xml");return"string"==typeof b?{name:b}:b||{name:"null"}};a.getMode=function(b,c){c=a.resolveMode(c);
var d=Ke[c.name];if(!d)return a.getMode(b,"text/plain");d=d(b,c);if(ac.hasOwnProperty(c.name)){var f=ac[c.name],g;for(g in f)f.hasOwnProperty(g)&&(d.hasOwnProperty(g)&&(d["_"+g]=d[g]),d[g]=f[g])}d.name=c.name;c.helperType&&(d.helperType=c.helperType);if(c.modeProps)for(g in c.modeProps)d[g]=c.modeProps[g];return d};a.defineMode("null",function(){return{token:function(a){a.skipToEnd()}}});a.defineMIME("text/plain","null");var ac=a.modeExtensions={};a.extendMode=function(a,b){var c=ac.hasOwnProperty(a)?
ac[a]:ac[a]={};Ic(b,c)};a.defineExtension=function(b,c){a.prototype[b]=c};a.defineDocExtension=function(a,b){la.prototype[a]=b};a.defineOption=M;var Tc=[];a.defineInitHook=function(a){Tc.push(a)};var lb=a.helpers={};a.registerHelper=function(b,c,d){lb.hasOwnProperty(b)||(lb[b]=a[b]={_global:[]});lb[b][c]=d};a.registerGlobalHelper=function(b,c,d,f){a.registerHelper(b,c,f);lb[b]._global.push({pred:d,val:f})};var Kb=a.copyState=function(a,b){if(!0===b)return b;if(a.copyState)return a.copyState(b);var c=
{},d;for(d in b){var f=b[d];f instanceof Array&&(f=f.concat([]));c[d]=f}return c},Se=a.startState=function(a,b,c){return a.startState?a.startState(b,c):!0};a.innerMode=function(a,b){for(;a.innerMode;){var c=a.innerMode(b);if(!c||c.mode==a)break;b=c.state;a=c.mode}return c||{mode:a,state:b}};var Ac=a.commands={selectAll:function(a){a.setSelection(D(a.firstLine(),0),D(a.lastLine()),tb)},singleSelection:function(a){a.setSelection(a.getCursor("anchor"),a.getCursor("head"),tb)},killLine:function(a){Gc(a,
function(b){if(b.empty()){var c=E(a.doc,b.head.line).text.length;return b.head.ch==c&&b.head.line<a.lastLine()?{from:b.head,to:D(b.head.line+1,0)}:{from:b.head,to:D(b.head.line,c)}}return{from:b.from(),to:b.to()}})},deleteLine:function(a){Gc(a,function(b){return{from:D(b.from().line,0),to:G(a.doc,D(b.to().line+1,0))}})},delLineLeft:function(a){Gc(a,function(a){return{from:D(a.from().line,0),to:a.from()}})},undo:function(a){a.undo()},redo:function(a){a.redo()},undoSelection:function(a){a.undoSelection()},
redoSelection:function(a){a.redoSelection()},goDocStart:function(a){a.extendSelection(D(a.firstLine(),0))},goDocEnd:function(a){a.extendSelection(D(a.lastLine()))},goLineStart:function(a){a.extendSelectionsBy(function(b){return Ie(a,b.head.line)},mb)},goLineStartSmart:function(a){a.extendSelectionsBy(function(b){var c=Ie(a,b.head.line),d=a.getLineHandle(c.line),f=Ga(d);return f&&0!=f[0].level?c:(d=Math.max(0,d.text.search(/\S/)),D(c.line,b.head.line==c.line&&b.head.ch<=d&&b.head.ch?0:d))},mb)},goLineEnd:function(a){a.extendSelectionsBy(function(b){b=
b.head.line;for(var c,d=E(a.doc,b);c=bb(d,!1);)d=c.find(1,!0).line,b=null;c=(c=Ga(d))?c[0].level%2?lc(d):mc(d):d.text.length;return D(null==b?$(d):b,c)},mb)},goLineRight:function(a){a.extendSelectionsBy(function(b){b=a.charCoords(b.head,"div").top+5;return a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:b},"div")},mb)},goLineLeft:function(a){a.extendSelectionsBy(function(b){b=a.charCoords(b.head,"div").top+5;return a.coordsChar({left:0,top:b},"div")},mb)},goLineUp:function(a){a.moveV(-1,
"line")},goLineDown:function(a){a.moveV(1,"line")},goPageUp:function(a){a.moveV(-1,"page")},goPageDown:function(a){a.moveV(1,"page")},goCharLeft:function(a){a.moveH(-1,"char")},goCharRight:function(a){a.moveH(1,"char")},goColumnLeft:function(a){a.moveH(-1,"column")},goColumnRight:function(a){a.moveH(1,"column")},goWordLeft:function(a){a.moveH(-1,"word")},goGroupRight:function(a){a.moveH(1,"group")},goGroupLeft:function(a){a.moveH(-1,"group")},goWordRight:function(a){a.moveH(1,"word")},delCharBefore:function(a){a.deleteH(-1,
"char")},delCharAfter:function(a){a.deleteH(1,"char")},delWordBefore:function(a){a.deleteH(-1,"word")},delWordAfter:function(a){a.deleteH(1,"word")},delGroupBefore:function(a){a.deleteH(-1,"group")},delGroupAfter:function(a){a.deleteH(1,"group")},indentAuto:function(a){a.indentSelection("smart")},indentMore:function(a){a.indentSelection("add")},indentLess:function(a){a.indentSelection("subtract")},insertTab:function(a){a.replaceSelection("\t")},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):
a.execCommand("insertTab")},transposeChars:function(a){La(a,function(){for(var b=a.listSelections(),c=0;c<b.length;c++){var d=b[c].head,f=E(a.doc,d.line).text;0<d.ch&&d.ch<f.length-1&&a.replaceRange(f.charAt(d.ch)+f.charAt(d.ch-1),D(d.line,d.ch-1),D(d.line,d.ch+1))}})},newlineAndIndent:function(a){La(a,function(){for(var b=a.listSelections().length,c=0;c<b;c++){var d=a.listSelections()[c];a.replaceRange("\n",d.anchor,d.head,"+input");a.indentLine(d.from().line+1,null,!0);db(a)}})},toggleOverwrite:function(a){a.toggleOverwrite()}},
Na=a.keyMap={};Na.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"};Na.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart",
"Ctrl-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"};
Na.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess",
"Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection",fallthrough:["basic","emacsy"]};Na.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"};
Na["default"]=sb?Na.macDefault:Na.pcDefault;var Bc=a.lookupKey=function(a,b,c){function d(b){b=ld(b);var f=b[a];if(!1===f)return"stop";if(null!=f&&c(f))return!0;if(b.nofallthrough)return"stop";b=b.fallthrough;if(null==b)return!1;if("[object Array]"!=Object.prototype.toString.call(b))return d(b);for(f=0;f<b.length;++f){var g=d(b[f]);if(g)return g}return!1}for(var f=0;f<b.length;++f){var g=d(b[f]);if(g)return"stop"!=g}},cf=a.isModifierKey=function(a){a=Wa[a.keyCode];return"Ctrl"==a||"Alt"==a||"Shift"==
a||"Mod"==a},df=a.keyName=function(a,b){if(ya&&34==a.keyCode&&a["char"])return!1;var c=Wa[a.keyCode];if(null==c||a.altGraphKey)return!1;a.altKey&&(c="Alt-"+c);if(Je?a.metaKey:a.ctrlKey)c="Ctrl-"+c;if(Je?a.ctrlKey:a.metaKey)c="Cmd-"+c;!b&&a.shiftKey&&(c="Shift-"+c);return c};a.fromTextArea=function(b,c){function d(){b.value=m.getValue()}c||(c={});c.value=b.value;!c.tabindex&&b.tabindex&&(c.tabindex=b.tabindex);!c.placeholder&&b.placeholder&&(c.placeholder=b.placeholder);if(null==c.autofocus){var f=
Ra();c.autofocus=f==b||null!=b.getAttribute("autofocus")&&f==document.body}if(b.form&&(N(b.form,"submit",d),!c.leaveSubmitMethodAlone)){var g=b.form,h=g.submit;try{var k=g.submit=function(){d();g.submit=h;g.submit();g.submit=k}}catch(l){}}b.style.display="none";var m=a(function(a){b.parentNode.insertBefore(a,b.nextSibling)},c);m.save=d;m.getTextArea=function(){return b};m.toTextArea=function(){d();b.parentNode.removeChild(m.getWrapperElement());b.style.display="";b.form&&(Va(b.form,"submit",d),"function"==
typeof b.form.submit&&(b.form.submit=h))};return m};var Mc=a.StringStream=function(a,b){this.pos=this.start=0;this.string=a;this.tabSize=b||8;this.lineStart=this.lastColumnPos=this.lastColumnValue=0};Mc.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(a){var b=this.string.charAt(this.pos);
if("string"==typeof a?b==a:b&&(a.test?a.test(b):a(b)))return++this.pos,b},eatWhile:function(a){for(var b=this.pos;this.eat(a););return this.pos>b},eatSpace:function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},skipToEnd:function(){this.pos=this.string.length},skipTo:function(a){a=this.string.indexOf(a,this.pos);if(-1<a)return this.pos=a,!0},backUp:function(a){this.pos-=a},column:function(){this.lastColumnPos<this.start&&(this.lastColumnValue=
Ia(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start);return this.lastColumnValue-(this.lineStart?Ia(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return Ia(this.string,null,this.tabSize)-(this.lineStart?Ia(this.string,this.lineStart,this.tabSize):0)},match:function(a,b,c){if("string"==typeof a){var d=function(a){return c?a.toLowerCase():a},f=this.string.substr(this.pos,a.length);if(d(f)==d(a))return!1!==b&&(this.pos+=
a.length),!0}else{if((a=this.string.slice(this.pos).match(a))&&0<a.index)return null;a&&!1!==b&&(this.pos+=a[0].length);return a}},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(a,b){this.lineStart+=a;try{return b()}finally{this.lineStart-=a}}};var ib=a.TextMarker=function(a,b){this.lines=[];this.type=b;this.doc=a};Bb(ib);ib.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,b=a&&!a.curOp;b&&ub(a);if(xa(this,"clear")){var c=this.find();
c&&da(this,"clear",c.from,c.to)}for(var d=c=null,f=0;f<this.lines.length;++f){var g=this.lines[f],h=Xb(g.markedSpans,this);a&&!this.collapsed?eb(a,$(g),"text"):a&&(null!=h.to&&(d=$(g)),null!=h.from&&(c=$(g)));for(var k=g,l=g.markedSpans,m=h,q=void 0,r=0;r<l.length;++r)l[r]!=m&&(q||(q=[])).push(l[r]);k.markedSpans=q;null==h.from&&this.collapsed&&!$a(this.doc,g)&&a&&Da(g,Za(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(f=0;f<this.lines.length;++f)g=Ha(this.lines[f]),h=v(g),h>a.display.maxLineLength&&
(a.display.maxLine=g,a.display.maxLineLength=h,a.display.maxLineChanged=!0);null!=c&&a&&this.collapsed&&ta(a,c,d+1);this.lines.length=0;this.explicitlyCleared=!0;this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&Jd(a.doc));a&&da(a,"markerCleared",a,this);b&&vb(a)}};ib.prototype.find=function(a,b){null==a&&"bookmark"==this.type&&(a=1);for(var c,d,f=0;f<this.lines.length;++f){var g=this.lines[f],h=Xb(g.markedSpans,this);if(null!=h.from&&(c=D(b?g:$(g),h.from),-1==a))return c;if(null!=h.to&&(d=
D(b?g:$(g),h.to),1==a))return d}return c&&{from:c,to:d}};ib.prototype.changed=function(){var a=this.find(-1,!0),b=this,c=this.doc.cm;a&&c&&La(c,function(){var d=a.line,f=$(a.line);if(f=Md(c,f))Pd(f),c.curOp.selectionChanged=c.curOp.forceUpdate=!0;c.curOp.updateMaxLine=!0;$a(b.doc,d)||null==b.height||(f=b.height,b.height=null,(f=Ob(b)-f)&&Da(d,d.height+f))})};ib.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;b.maybeHiddenMarkers&&-1!=ha(b.maybeHiddenMarkers,
this)||(b.maybeUnhiddenMarkers||(b.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)};ib.prototype.detachLine=function(a){this.lines.splice(ha(this.lines,a),1);!this.lines.length&&this.doc.cm&&(a=this.doc.cm.curOp,(a.maybeHiddenMarkers||(a.maybeHiddenMarkers=[])).push(this))};var kf=0,Kc=a.SharedTextMarker=function(a,b){this.markers=a;this.primary=b;for(var c=0,d=this;c<a.length;++c)a[c].parent=this,N(a[c],"clear",function(){d.clear()})};Bb(Kc);Kc.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=
!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();da(this,"clear")}};Kc.prototype.find=function(a,b){return this.primary.find(a,b)};var Lc=a.LineWidget=function(a,b,c){if(c)for(var d in c)c.hasOwnProperty(d)&&(this[d]=c[d]);this.cm=a;this.node=b};Bb(Lc);Lc.prototype.clear=function(){var a=this.cm,b=this.line.widgets,c=this.line,d=$(c);if(null!=d&&b){for(var f=0;f<b.length;++f)b[f]==this&&b.splice(f--,1);b.length||(c.widgets=null);var g=Ob(this);La(a,function(){var b=-g;Ea(c)<(a.curOp&&
a.curOp.scrollTop||a.doc.scrollTop)&&Dc(a,null,b);eb(a,d,"widget");Da(c,Math.max(0,c.height-g))})}};Lc.prototype.changed=function(){var a=this.height,b=this.cm,c=this.line;this.height=null;var d=Ob(this)-a;d&&La(b,function(){b.curOp.forceUpdate=!0;Ea(c)<(b.curOp&&b.curOp.scrollTop||b.doc.scrollTop)&&Dc(b,null,d);Da(c,c.height+d)})};var jb=a.Line=function(a,b,c){this.text=a;xe(this,b);this.height=c?c(this):1};Bb(jb);jb.prototype.lineNo=function(){return $(this)};var of={},nf={};Yb.prototype={chunkSize:function(){return this.lines.length},
removeInner:function(a,b){for(var c=a,d=a+b;c<d;++c){var f=this.lines[c];this.height-=f.height;var g=f;g.parent=null;we(g);da(f,"delete")}this.lines.splice(a,b)},collapse:function(a){a.push.apply(a,this.lines)},insertInner:function(a,b,c){this.height+=c;this.lines=this.lines.slice(0,a).concat(b).concat(this.lines.slice(a));for(a=0;a<b.length;++a)b[a].parent=this},iterN:function(a,b,c){for(b=a+b;a<b;++a)if(c(this.lines[a]))return!0}};Zb.prototype={chunkSize:function(){return this.size},removeInner:function(a,
b){this.size-=b;for(var c=0;c<this.children.length;++c){var d=this.children[c],f=d.chunkSize();if(a<f){var g=Math.min(b,f-a),h=d.height;d.removeInner(a,g);this.height-=h-d.height;f==g&&(this.children.splice(c--,1),d.parent=null);if(0==(b-=g))break;a=0}else a-=f}25>this.size-b&&(1<this.children.length||!(this.children[0]instanceof Yb))&&(c=[],this.collapse(c),this.children=[new Yb(c)],this.children[0].parent=this)},collapse:function(a){for(var b=0;b<this.children.length;++b)this.children[b].collapse(a)},
insertInner:function(a,b,c){this.size+=b.length;this.height+=c;for(var d=0;d<this.children.length;++d){var f=this.children[d],g=f.chunkSize();if(a<=g){f.insertInner(a,b,c);if(f.lines&&50<f.lines.length){for(;50<f.lines.length;)a=f.lines.splice(f.lines.length-25,25),a=new Yb(a),f.height-=a.height,this.children.splice(d+1,0,a),a.parent=this;this.maybeSpill()}break}a-=g}},maybeSpill:function(){if(!(10>=this.children.length)){var a=this;do{var b=a.children.splice(a.children.length-5,5),b=new Zb(b);if(a.parent){a.size-=
b.size;a.height-=b.height;var c=ha(a.parent.children,a);a.parent.children.splice(c+1,0,b)}else c=new Zb(a.children),c.parent=a,a.children=[c,b],a=c;b.parent=a.parent}while(10<a.children.length);a.parent.maybeSpill()}},iterN:function(a,b,c){for(var d=0;d<this.children.length;++d){var f=this.children[d],g=f.chunkSize();if(a<g){g=Math.min(b,g-a);if(f.iterN(a,g,c))return!0;if(0==(b-=g))break;a=0}else a-=g}}};var Af=0,la=a.Doc=function(a,b,c){if(!(this instanceof la))return new la(a,b,c);null==c&&(c=0);
Zb.call(this,[new Yb([new jb("",null)])]);this.first=c;this.scrollTop=this.scrollLeft=0;this.cantEdit=!1;this.cleanGeneration=1;this.frontier=c;c=D(c,0);this.sel=va(c);this.history=new Nc(null);this.id=++Af;this.modeOption=b;"string"==typeof a&&(a=wb(a));sd(this,{from:c,to:c,text:a});S(this,va(c),tb)};la.prototype=Ge(Zb.prototype,{constructor:la,iter:function(a,b,c){c?this.iterN(a-this.first,b-a,c):this.iterN(this.first,this.first+this.size,a)},insert:function(a,b){for(var c=0,d=0;d<b.length;++d)c+=
b[d].height;this.insertInner(a-this.first,b,c)},remove:function(a,b){this.removeInner(a-this.first,b)},getValue:function(a){var b=wd(this,this.first,this.first+this.size);return!1===a?b:b.join(a||"\n")},setValue:ra(function(a){var b=D(this.first,0),c=this.first+this.size-1;xb(this,{from:b,to:D(c,E(this,c).text.length),text:wb(a),origin:"setValue"},!0);S(this,va(b))}),replaceRange:function(a,b,c,d){b=G(this,b);c=c?G(this,c):b;xc(this,a,b,c,d)},getRange:function(a,b,c){a=Vb(this,G(this,a),G(this,b));
return!1===c?a:a.join(c||"\n")},getLine:function(a){return(a=this.getLineHandle(a))&&a.text},getLineHandle:function(a){if(Qa(this,a))return E(this,a)},getLineNumber:function(a){return $(a)},getLineHandleVisualStart:function(a){"number"==typeof a&&(a=E(this,a));return Ha(a)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return G(this,a)},getCursor:function(a){var b=this.sel.primary();return null==
a||"head"==a?b.head:"anchor"==a?b.anchor:"end"==a||"to"==a||!1===a?b.to():b.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:ra(function(a,b,c){a=G(this,"number"==typeof a?D(a,b||0):a);S(this,va(a,null),c)}),setSelection:ra(function(a,b,c){var d=G(this,a);a=G(this,b||a);S(this,va(d,a),c)}),extendSelection:ra(function(a,b,c){ga(this,G(this,a),b&&G(this,b),c)}),extendSelections:ra(function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=
G(this,a[d]);ob(this,c)}),extendSelectionsBy:ra(function(a,b){ob(this,rd(this.sel.ranges,a),b)}),setSelections:ra(function(a,b,c){if(a.length){for(var d=0,f=[];d<a.length;d++)f[d]=new T(G(this,a[d].anchor),G(this,a[d].head));null==b&&(b=Math.min(a.length-1,this.sel.primIndex));S(this,ka(f,b),c)}}),addSelection:ra(function(a,b,c){var d=this.sel.ranges.slice(0);d.push(new T(G(this,a),G(this,b||a)));S(this,ka(d,d.length-1),c)}),getSelection:function(a){for(var b=this.sel.ranges,c,d=0;d<b.length;d++){var f=
Vb(this,b[d].from(),b[d].to());c=c?c.concat(f):f}return!1===a?c:c.join(a||"\n")},getSelections:function(a){for(var b=[],c=this.sel.ranges,d=0;d<c.length;d++){var f=Vb(this,c[d].from(),c[d].to());!1!==a&&(f=f.join(a||"\n"));b[d]=f}return b},replaceSelection:ra(function(a,b,c){for(var d=[],f=0;f<this.sel.ranges.length;f++)d[f]=a;this.replaceSelections(d,b,c||"+input")}),replaceSelections:function(a,b,c){for(var d=[],f=this.sel,g=0;g<f.ranges.length;g++){var h=f.ranges[g];d[g]={from:h.from(),to:h.to(),
text:wb(a[g]),origin:c}}if(g=b)if(g="end"!=b){g=[];c=a=D(this.first,0);for(f=0;f<d.length;f++){var k=d[f],h=ie(k.from,a,c),l=ie(yb(k),a,c);a=k.to;c=l;"around"==b?(k=this.sel.ranges[f],k=0>Q(k.head,k.anchor),g[f]=new T(k?l:h,k?h:l)):g[f]=new T(h,h)}g=new L(g,this.sel.primIndex)}b=g;for(g=d.length-1;0<=g;g--)xb(this,d[g]);b?Cb(this,b):this.cm&&db(this.cm)},undo:ra(function(){Cc(this,"undo")}),redo:ra(function(){Cc(this,"redo")}),undoSelection:ra(function(){Cc(this,"undo",!0)}),redoSelection:ra(function(){Cc(this,
"redo",!0)}),setExtending:function(a){this.extend=a},getExtending:function(){return this.extend},historySize:function(){for(var a=this.history,b=0,c=0,d=0;d<a.done.length;d++)a.done[d].ranges||++b;for(d=0;d<a.undone.length;d++)a.undone[d].ranges||++c;return{undo:b,redo:c}},clearHistory:function(){this.history=new Nc(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(a){a&&(this.history.lastOp=this.history.lastOrigin=null);return this.history.generation},
isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:Ab(this.history.done),undone:Ab(this.history.undone)}},setHistory:function(a){var b=this.history=new Nc(this.history.maxGeneration);b.done=Ab(a.done.slice(0),null,!0);b.undone=Ab(a.undone.slice(0),null,!0)},markText:function(a,b,c){return Wb(this,G(this,a),G(this,b),c,"range")},setBookmark:function(a,b){var c={replacedWith:b&&(null==b.nodeType?b.widget:b),insertLeft:b&&b.insertLeft,clearWhenEmpty:!1,
shared:b&&b.shared};a=G(this,a);return Wb(this,a,a,c,"bookmark")},findMarksAt:function(a){a=G(this,a);var b=[],c=E(this,a.line).markedSpans;if(c)for(var d=0;d<c.length;++d){var f=c[d];(null==f.from||f.from<=a.ch)&&(null==f.to||f.to>=a.ch)&&b.push(f.marker.parent||f.marker)}return b},findMarks:function(a,b){a=G(this,a);b=G(this,b);var c=[],d=a.line;this.iter(a.line,b.line+1,function(f){if(f=f.markedSpans)for(var g=0;g<f.length;g++){var h=f[g];d==a.line&&a.ch>h.to||null==h.from&&d!=a.line||d==b.line&&
h.from>b.ch||c.push(h.marker.parent||h.marker)}++d});return c},getAllMarks:function(){var a=[];this.iter(function(b){if(b=b.markedSpans)for(var c=0;c<b.length;++c)null!=b[c].from&&a.push(b[c].marker)});return a},posFromIndex:function(a){var b,c=this.first;this.iter(function(d){d=d.text.length+1;if(d>a)return b=a,!0;a-=d;++c});return G(this,D(c,b))},indexFromPos:function(a){a=G(this,a);var b=a.ch;if(a.line<this.first||0>a.ch)return 0;this.iter(this.first,a.line,function(a){b+=a.text.length+1});return b},
copy:function(a){var b=new la(wd(this,this.first,this.first+this.size),this.modeOption,this.first);b.scrollTop=this.scrollTop;b.scrollLeft=this.scrollLeft;b.sel=this.sel;b.extend=!1;a&&(b.history.undoDepth=this.history.undoDepth,b.setHistory(this.getHistory()));return b},linkedDoc:function(a){a||(a={});var b=this.first,c=this.first+this.size;null!=a.from&&a.from>b&&(b=a.from);null!=a.to&&a.to<c&&(c=a.to);b=new la(wd(this,b,c),a.mode||this.modeOption,b);a.sharedHist&&(b.history=this.history);(this.linked||
(this.linked=[])).push({doc:b,sharedHist:a.sharedHist});b.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}];return b},unlinkDoc:function(b){b instanceof a&&(b=b.doc);if(this.linked)for(var c=0;c<this.linked.length;++c)if(this.linked[c].doc==b){this.linked.splice(c,1);b.unlinkDoc(this);break}if(b.history==this.history){var d=[b.id];zb(b,function(a){d.push(a.id)},!0);b.history=new Nc(null);b.history.done=Ab(this.history.done,d);b.history.undone=Ab(this.history.undone,d)}},iterLinkedDocs:function(a){zb(this,
a)},getMode:function(){return this.mode},getEditor:function(){return this.cm}});la.prototype.eachLine=la.prototype.iter;var Bf=["iter","insert","remove","copy","getEditor"],bc;for(bc in la.prototype)la.prototype.hasOwnProperty(bc)&&0>ha(Bf,bc)&&(a.prototype[bc]=function(a){return function(){return a.apply(this.doc,arguments)}}(la.prototype[bc]));Bb(la);var ia=a.e_preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},Cf=a.e_stopPropagation=function(a){a.stopPropagation?a.stopPropagation():
a.cancelBubble=!0},gd=a.e_stop=function(a){ia(a);Cf(a)},N=a.on=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):(a=a._handlers||(a._handlers={}),(a[b]||(a[b]=[])).push(c))},Va=a.off=function(a,b,c){if(a.removeEventListener)a.removeEventListener(b,c,!1);else if(a.detachEvent)a.detachEvent("on"+b,c);else if(a=a._handlers&&a._handlers[b])for(b=0;b<a.length;++b)if(a[b]==c){a.splice(b,1);break}},aa=a.signal=function(a,b){var c=a._handlers&&a._handlers[b];
if(c)for(var d=Array.prototype.slice.call(arguments,2),f=0;f<c.length;++f)c[f].apply(null,d)},Ua,nc=0,Ma=30,de=a.Pass={toString:function(){return"CodeMirror.Pass"}},tb={scroll:!1},wc={origin:"*mouse"},mb={origin:"+move"};Qc.prototype.set=function(a,b){clearTimeout(this.id);this.id=setTimeout(b,a)};var Ia=a.countColumn=function(a,b,c,d,f){null==b&&(b=a.search(/[^\s\u00a0]/),-1==b&&(b=a.length));d=d||0;for(f=f||0;;){var g=a.indexOf("\t",d);if(0>g||g>=b)return f+(b-d);f+=g-d;f+=c-f%c;d=g+1}},Oc=[""],
tc=function(a){a.select()};Db?tc=function(a){a.selectionStart=0;a.selectionEnd=a.value.length}:na&&(tc=function(a){try{a.select()}catch(b){}});[].indexOf&&(ha=function(a,b){return a.indexOf(b)});[].map&&(rd=function(a,b){return a.map(b)});var Df=/[\u00df\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Hc=a.isWordChar=function(a){return/\w/.test(a)||"\u0080"<a&&(a.toUpperCase()!=a.toLowerCase()||Df.test(a))},vf=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,
Nb;Nb=document.createRange?function(a,b,c){var d=document.createRange();d.setEnd(a,c);d.setStart(a,b);return d}:function(a,b,c){var d=document.body.createTextRange();d.moveToElementText(a.parentNode);d.collapse(!0);d.moveEnd("character",c);d.moveStart("character",b);return d};wa&&(Ra=function(){try{return document.activeElement}catch(a){return document.body}});var Ze=function(){if(fa)return!1;var a=I("div");return"draggable"in a||"dragDrop"in a}(),Sb,xd,vd,wb=a.splitLines=3!="\n\nb".split(/\n/).length?
function(a){for(var b=0,c=[],d=a.length;b<=d;){var f=a.indexOf("\n",b);-1==f&&(f=a.length);var g=a.slice(b,"\r"==a.charAt(f-1)?f-1:f),h=g.indexOf("\r");-1!=h?(c.push(g.slice(0,h)),b+=h+1):(c.push(g),b=f+1)}return c}:function(a){return a.split(/\r\n?|\n/)},We=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch(b){return!1}}:function(a){try{var b=a.ownerDocument.selection.createRange()}catch(c){}return b&&b.parentElement()==a?0!=b.compareEndPoints("StartToEnd",b):!1},Td=
function(){var a=I("div");if("oncopy"in a)return!0;a.setAttribute("oncopy","return;");return"function"==typeof a.oncopy}(),Wa={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",107:"=",109:"-",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",
219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};a.keyNames=Wa;(function(){for(var a=0;10>a;a++)Wa[a+48]=Wa[a+96]=String(a);for(a=65;90>=a;a++)Wa[a]=String.fromCharCode(a);for(a=1;12>=a;a++)Wa[a+111]=Wa[a+63235]="F"+a})();var Pb,tf=function(){function a(b){return 247>=b?c.charAt(b):1424<=b&&1524>=b?"R":1536<=b&&1773>=b?d.charAt(b-1536):1774<=b&&2220>=b?"r":8192<=b&&8203>=b?"w":
8204==b?"b":"L"}function b(a,c,d){this.level=a;this.from=c;this.to=d}var c="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",d="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmm",
f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,g=/[stwN]/,h=/[LRr]/,k=/[Lb1n]/,l=/[1n]/;return function(c){if(!f.test(c))return!1;for(var d=c.length,m=[],q=0,r;q<d;++q)m.push(a(c.charCodeAt(q)));for(var q=0,s="L";q<d;++q)r=m[q],"m"==r?m[q]=s:s=r;q=0;for(s="L";q<d;++q)r=m[q],"1"==r&&"r"==s?m[q]="n":h.test(r)&&(s=r,"r"==r&&(m[q]="R"));q=1;for(s=m[0];q<d-1;++q)r=m[q],"+"==r&&"1"==s&&"1"==m[q+1]?m[q]="1":","!=r||s!=m[q+1]||"1"!=s&&"n"!=s||(m[q]=s),s=r;for(q=0;q<d;++q)if(r=m[q],","==r)m[q]="N";else if("%"==
r){for(s=q+1;s<d&&"%"==m[s];++s);var w=q&&"!"==m[q-1]||s<d&&"1"==m[s]?"1":"N";for(r=q;r<s;++r)m[r]=w;q=s-1}q=0;for(s="L";q<d;++q)r=m[q],"L"==s&&"1"==r?m[q]="L":h.test(r)&&(s=r);for(q=0;q<d;++q)if(g.test(m[q])){for(s=q+1;s<d&&g.test(m[s]);++s);r="L"==(s<d?m[s]:"L");w="L"==(q?m[q-1]:"L")||r?"L":"R";for(r=q;r<s;++r)m[r]=w;q=s-1}for(var s=[],u,q=0;q<d;)if(k.test(m[q])){r=q;for(++q;q<d&&k.test(m[q]);++q);s.push(new b(0,r,q))}else{var v=q,w=s.length;for(++q;q<d&&"L"!=m[q];++q);for(r=v;r<q;)if(l.test(m[r])){v<
r&&s.splice(w,0,new b(1,v,r));v=r;for(++r;r<q&&l.test(m[r]);++r);s.splice(w,0,new b(2,v,r));v=r}else++r;v<q&&s.splice(w,0,new b(1,v,q))}1==s[0].level&&(u=c.match(/^\s+/))&&(s[0].from=u[0].length,s.unshift(new b(0,0,u[0].length)));1==V(s).level&&(u=c.match(/\s+$/))&&(V(s).to-=u[0].length,s.push(new b(0,d-u[0].length,d)));s[0].level!=V(s).level&&s.push(new b(s[0].level,d,d));return s}}();a.version="4.0.3";return a});colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"};
colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",
grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",
darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",
lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",
orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",
lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",
purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",
grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",
darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",
lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",
orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",
lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",
purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{3}){1,2})\s*/;function createSprite(a,b,c,d){void 0===c&&(c=[state.bgcolor,state.fgcolor]);a=makeSpriteCanvas(a);var f=a.getContext("2d");f.clearRect(0,0,cellwidth,cellheight);var g=b[0].length,h=b.length,k=~~(cellwidth/(g+(d|0))),q=d=~~(cellheight/(h+(d|0)));"scanline"in state.metadata&&(q=Math.ceil(d/2));f.fillStyle=state.fgcolor;for(var m=0;m<g;m++)for(var v=0;v<h;v++){var A=b[m][v];if(0<=A){var B=m*k|0,F=v*d|0;f.fillStyle=c[A];f.fillRect(F,B,k,q)}}return a}
function regenText(a,b){textImages={};for(var c in font)font.hasOwnProperty(c)&&(textImages[c]=createSprite("char"+c,font[c],void 0,1))}var spriteimages;function regenSpriteImages(){if(textMode)regenText();else if(levelEditorOpened&&(textImages.s=createSprite("chars",font.s,void 0)),0!==state.levels.length){spriteimages=[];for(var a=0;a<sprites.length;a++)void 0!=sprites[a]&&(spriteimages[a]=createSprite(a.toString(),sprites[a].dat,sprites[a].colors));canOpenEditor&&generateGlyphImages()}}
var glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvasdict={};function makeSpriteCanvas(a){var b;a in canvasdict?b=canvasdict[a]:(b=document.createElement("canvas"),canvasdict[a]=b);b.width=cellwidth;b.height=cellheight;return b}
function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){glyphImagesCorrespondance=[];glyphImages=[];for(var a in state.glyphDict)if(1==a.length&&state.glyphDict.hasOwnProperty(a)){var b=state.glyphDict[a],c=makeSpriteCanvas("C"+a),d=c.getContext("2d");glyphImagesCorrespondance.push(a);for(var f=0;f<b.length;f++){var g=b[f];-1!==g&&d.drawImage(spriteimages[g],0,0)}glyphImages.push(c)}glyphHighlight=makeSpriteCanvas("highlight");d=glyphHighlight.getContext("2d");d.fillStyle="#FFFFFF";d.fillRect(0,
0,cellwidth,1);d.fillRect(0,0,1,cellheight);d.fillRect(0,cellheight-1,cellwidth,1);d.fillRect(cellwidth-1,0,1,cellheight);glyphPrintButton=textImages.s;glyphHighlightResize=makeSpriteCanvas("highlightresize");d=glyphHighlightResize.getContext("2d");d.fillStyle="#FFFFFF";a=cellwidth/2-1|0;b=cellheight/2-1|0;c=cellheight-b-1-a;d.fillRect(a,0,cellwidth-a-1-a,cellheight);d.fillRect(0,b,cellwidth,c);glyphMouseOver=makeSpriteCanvas();d=glyphMouseOver.getContext("2d");d.fillStyle="yellow";d.fillRect(0,0,
cellwidth,2);d.fillRect(0,0,2,cellheight);d.fillRect(0,cellheight-2,cellwidth,2);d.fillRect(cellwidth-2,0,2,cellheight)}}var canvas,ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.addEventListener("resize",canvasResize,!1);canvas=document.getElementById("gameCanvas");ctx=canvas.getContext("2d");y=x=0;function glyphCount(){var a=0,b;for(b in state.glyphDict)1==b.length&&state.glyphDict.hasOwnProperty(b)&&a++;return a}
function redraw(){if(0!==cellwidth&&0!==cellheight)if(void 0===spriteimages&&regenSpriteImages(),textMode){ctx.fillStyle=state.bgcolor;ctx.fillRect(0,0,canvas.width,canvas.height);for(var a=0;a<titleWidth;a++)for(var b=0;b<titleHeight;b++){var c=titleImage[b].charAt(a);if(c in textImages){var d=textImages[c];ctx.drawImage(d,xoffset+a*cellwidth,yoffset+b*cellheight)}}}else{ctx.fillStyle=state.bgcolor;ctx.fillRect(0,0,canvas.width,canvas.height);var c=0,f=screenwidth,g=0,h=screenheight;levelEditorOpened?
(a=glyphCount(),editorRowCount=Math.ceil(a/(screenwidth-1)),f-=2,h-=2+editorRowCount):flickscreen?(a=getPlayerPositions(),0<a.length?(f=a[0],c=f/level.height|0,f=f%level.height|0,f=f/screenheight|0,c=(c/screenwidth|0)*screenwidth,g=f*screenheight,f=Math.min(c+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[c,g,f,h]):0<oldflickscreendat.length&&(c=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3])):zoomscreen&&(a=getPlayerPositions(),
0<a.length?(f=a[0],c=f/level.height|0,f=f%level.height|0,c=Math.max(Math.min(c-(screenwidth/2|0),level.width-screenwidth),0),g=Math.max(Math.min(f-(screenheight/2|0),level.height-screenheight),0),f=Math.min(c+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[c,g,f,h]):0<oldflickscreendat.length&&(c=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3]));for(a=c;a<f;a++)for(b=g;b<h;b++)for(var k=level.getCellInto(b+a*level.height,
_o12),q=0;q<state.objectCount;q++)0!=k.get(q)&&(d=spriteimages[q],ctx.drawImage(d,xoffset+(a-c)*cellwidth,yoffset+(b-g)*cellheight));levelEditorOpened&&drawEditorIcons()}}
function drawEditorIcons(){var a=glyphImages.length-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var b=editorRowCount-(-mouseCoordY-2)-1,c=mouseCoordX+(screenwidth-1)*b,d=0;d<a;d++){var f=glyphImages[0+d],g=d%(screenwidth-1),b=d/(screenwidth-1)|0;ctx.drawImage(f,xoffset+g*cellwidth,yoffset+b*cellheight-cellheight*
(1+editorRowCount));0<=mouseCoordX&&mouseCoordX<screenwidth-1&&c===d&&ctx.drawImage(glyphMouseOver,xoffset+g*cellwidth,yoffset+b*cellheight-cellheight*(1+editorRowCount));d===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+g*cellwidth,yoffset+b*cellheight-cellheight*(1+editorRowCount))}-1<=mouseCoordX&&-1<=mouseCoordY&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?
ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1;
function canvasResize(){canvas.width=canvas.parentNode.clientWidth;canvas.height=canvas.parentNode.clientHeight;screenwidth=level.width;screenheight=level.height;if(void 0!==state)if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,levelEditorOpened){screenwidth+=2;var a=glyphCount();editorRowCount=Math.ceil(a/(screenwidth-1));screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):
zoomscreen&&(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]);textMode&&(screenwidth=titleWidth,screenheight=titleHeight);cellwidth=canvas.width/screenwidth;cellheight=canvas.height/screenheight;var b=a=5;textMode&&(b=a=6);cellwidth=a*~~(cellwidth/a);cellheight=b*~~(cellheight/b);yoffset=xoffset=0;cellwidth>cellheight?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=
(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2);magnification=cellwidth/a*5|0;levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount));cellwidth|=0;cellheight|=0;xoffset|=0;yoffset|=0;if(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||oldfgcolor!=state.fgcolor||forceRegenImages)forceRegenImages=!1,regenSpriteImages();oldcellheight=cellheight;oldcellwidth=cellwidth;oldtextmode=textMode;oldfgcolor=
state.fgcolor;redraw()};var RandomGen=new RNG,intro_template="..................................;..................................;..................................;......Puzzle Script Terminal......;..............v 1.0...............;..................................;..................................;..................................;.........insert cartridge.........;..................................;..................................;..................................;..................................".split(";"),
messagecontainer_template="..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..........X to continue...........;..................................;..................................".split(";"),titletemplate_firstgo=
"..................................;..................................;..................................;..................................;..................................;..................................;..........#.start game.#..........;..................................;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),titletemplate_select0="..................................;..................................;..................................;..................................;..................................;...........#.new game.#...........;..................................;.............continue.............;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),
titletemplate_select1="..................................;..................................;..................................;..................................;..................................;.............new game.............;..................................;...........#.continue.#...........;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),titletemplate_firstgo_selected=
"..................................;..................................;..................................;..................................;..................................;..................................;###########.start game.###########;..................................;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),titletemplate_select0_selected="..................................;..................................;..................................;..................................;..................................;############.new game.############;..................................;.............continue.............;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),
titletemplate_select1_selected="..................................;..................................;..................................;..................................;..................................;.............new game.............;..................................;############.continue.############;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";"),titleImage=
[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1;function unloadGame(){state=introstate;level=new Level(0,5,5,2,null);level.objects=new Int32Array(0);generateTitleScreen();canvasResize();redraw()}
function generateTitleScreen(){titleMode=0<curlevel||null!==curlevelTarget?1:0;if(0===state.levels.length)titleImage=intro_template;else{var a="PuzzleScript Game";void 0!==state.metadata.title&&(a=state.metadata.title);titleImage=0===titleMode?titleSelected?deepClone(titletemplate_firstgo_selected):deepClone(titletemplate_firstgo):0===titleSelection?titleSelected?deepClone(titletemplate_select0_selected):deepClone(titletemplate_select0):titleSelected?deepClone(titletemplate_select1_selected):deepClone(titletemplate_select1);
var b="noaction"in state.metadata,c="noundo"in state.metadata,d="norestart"in state.metadata;c&&d?titleImage[11]="..................................":c?titleImage[11]=".R to restart.....................":d&&(titleImage[11]=".Z to undo.....................");b&&(titleImage[10]="..................................");for(b=0;b<titleImage.length;b++)titleImage[b]=titleImage[b].replace(/\./g," ");c=titleImage[0].length;d=wordwrap(a,titleImage[0].length);for(b=0;b<d.length;b++){var f=d[b],g=(c-f.length)/
2|0,a=titleImage[1+b];titleImage[1+b]=a.slice(0,g)+f+a.slice(g+f.length)}if(void 0!==state.metadata.author)for(d=wordwrap("by "+state.metadata.author,titleImage[0].length),b=0;b<d.length;b++)f=d[b],a=titleImage[3+b],titleImage[3+b]=a.slice(0,c-f.length-1)+f+a[a.length-1]}}var introstate={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate;
function deepClone(a){if(!a)return a;var b;[Number,String,Boolean].forEach(function(c){a instanceof c&&(b=c(a))});if("undefined"==typeof b)if("[object Array]"===Object.prototype.toString.call(a))b=[],a.forEach(function(a,c,g){b[c]=deepClone(a)});else if("object"==typeof a)if(a.nodeType&&"function"==typeof a.cloneNode)b=a.cloneNode(!0);else if(a.prototype)b=a;else if(a instanceof Date)b=new Date(a);else{b={};for(var c in a)b[c]=deepClone(a[c])}else b=a;return b}
function wordwrap(a,b){b=b||75;return a?a.match(RegExp(".{1,"+b+"}(\\s|$)"+("|.{"+b+"}|.+$"),"g")):a}var splitMessage=[];
function drawMessageScreen(){titleMode=0;textMode=!0;titleImage=deepClone(messagecontainer_template);for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");var b=titleImage[0].length,a=""===messagetext?state.levels[curlevel].message.trim():messagetext;splitMessage=wordwrap(a,titleImage[0].length);for(a=0;a<splitMessage.length;a++){var c=splitMessage[a],d=5-(splitMessage.length/2|0)+a,f=(b-c.length)/2|0,g=titleImage[d];titleImage[d]=g.slice(0,f)+c+g.slice(f+c.length)}quittingMessageScreen&&
(titleImage[10]=titleImage[9]);canvasResize()}var loadedLevelSeed=0;
function loadLevelFromLevelDat(a,b,c){null==c&&(c=(Math.random()+Date.now()).toString());loadedLevelSeed=c;RandomGen=new RNG(loadedLevelSeed);forceRegenImages=!0;titleScreen=!1;titleMode=0<curlevel||null!==curlevelTarget?1:0;titleSelection=0<curlevel||null!==curlevelTarget?1:0;againing=titleSelected=!1;void 0===b?consolePrint("Trying to access a level that doesn't exist.",!0):(void 0===b.message?(titleMode=0,textMode=!1,level=b.clone(),RebuildLevelArrays(),backups=[],restartTarget=backupLevel(),"run_rules_on_level_start"in
a.metadata&&processInput(-1,!0)):(tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()),clearInputHistory())}function loadLevelFromStateTarget(a,b,c,d){curlevel=b;curlevelTarget=c;void 0===c.message&&tryPlayStartLevelSound();loadLevelFromLevelDat(a,a.levels[b],d);restoreLevel(c);restartTarget=c}function loadLevelFromState(a,b,c){var d=a.levels[b];curlevel=b;curlevelTarget=null;void 0===d.message&&tryPlayStartLevelSound();loadLevelFromLevelDat(a,d,c)}
var sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];generateTitleScreen();canvasResize();function tryPlaySimpleSound(a){void 0!==state.sfx_Events[a]&&playSound(state.sfx_Events[a])}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}
function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}var backups=[],restartTarget;
function backupLevel(){return{dat:new Int32Array(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([])}}
function setGameState(a,b,c){oldflickscreendat=[];autotick=timer=0;messageselected=againing=winning=!1;STRIDE_MOV=a.STRIDE_MOV;STRIDE_OBJ=a.STRIDE_OBJ;void 0===b&&(b=["restart"]);0===state.levels.length&&0<b.length&&"rebuild"===b[0]&&(b=["restart"]);void 0===c&&(c=null);RandomGen=new RNG(c);state=a;window.console.log("setting game state :D ");backups=[];sprites=[];for(var d in state.objects)state.objects.hasOwnProperty(d)&&(a=state.objects[d],sprites[a.id]={colors:a.colors,dat:a.spritematrix});void 0!==
state.metadata.realtime_interval?(autotick=0,autotickinterval=1E3*state.metadata.realtime_interval):autotickinterval=autotick=0;repeatinterval=void 0!==state.metadata.key_repeat_interval?1E3*state.metadata.key_repeat_interval:150;againinterval=void 0!==state.metadata.again_interval?1E3*state.metadata.again_interval:150;throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't.");
norepeat_action=void 0!==state.metadata.norepeat_action;switch(b[0]){case "restart":winning=!1;timer=0;titleScreen=!0;tryPlayTitleSound();textMode=!0;titleSelection=0<curlevel||null!==curlevelTarget?1:0;messageselected=quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;if(0<curlevel||null!==curlevelTarget)titleMode=1;generateTitleScreen();break;case "loadLevel":d=b[1];curlevel=f;winning=!1;timer=0;textMode=titleScreen=!1;titleSelection=0<curlevel||null!==curlevelTarget?1:0;messageselected=
quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;loadLevelFromState(state,d,c);break;case "levelline":c=b[1];for(var f=state.levels.length-1;0<=f;f--)if(state.levels[f].lineNumber<=c+1){curlevel=f;winning=!1;timer=0;textMode=titleScreen=!1;titleSelection=0<curlevel||null!==curlevelTarget?1:0;messageselected=quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;loadLevelFromState(state,f);break}}"rebuild"!==b[0]&&clearInputHistory();canvasResize();canYoutube&&
"youtube"in state.metadata&&(b=state.metadata.youtube,b="https://youtube.googleapis.com/v/"+b+"?autoplay=1&loop=1&playlist="+b,ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",b),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm))}
function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV);level.rigidMovementAppliedMask=[];level.rigidGroupIndexMask=[];level.rowCellContents=[];level.colCellContents=[];level.mapCellContents=new BitVec(STRIDE_OBJ);_movementsVec=new BitVec(STRIDE_MOV);_o1=new BitVec(STRIDE_OBJ);_o2=new BitVec(STRIDE_OBJ);_o2_5=new BitVec(STRIDE_OBJ);_o3=new BitVec(STRIDE_OBJ);_o4=new BitVec(STRIDE_OBJ);_o5=new BitVec(STRIDE_OBJ);_o6=new BitVec(STRIDE_OBJ);_o7=new BitVec(STRIDE_OBJ);_o8=
new BitVec(STRIDE_OBJ);_o9=new BitVec(STRIDE_OBJ);_o10=new BitVec(STRIDE_OBJ);_o11=new BitVec(STRIDE_OBJ);_o12=new BitVec(STRIDE_OBJ);_m1=new BitVec(STRIDE_MOV);_m2=new BitVec(STRIDE_MOV);_m3=new BitVec(STRIDE_MOV);for(var a=0;a<level.height;a++)level.rowCellContents[a]=new BitVec(STRIDE_OBJ);for(a=0;a<level.width;a++)level.colCellContents[a]=new BitVec(STRIDE_OBJ);for(a=0;a<level.n_tiles;a++)level.rigidMovementAppliedMask[a]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[a]=new BitVec(STRIDE_MOV)}
var messagetext="";
function restoreLevel(a){oldflickscreendat=a.oldflickscreendat.concat([]);level.objects=new Int32Array(a.dat);if(level.width!==a.width||level.height!==a.height)level.width=a.width,level.height=a.height,level.n_tiles=a.width*a.height,RebuildLevelArrays();else{for(a=0;a<level.n_tiles;a++)level.movements[a]=0,level.rigidMovementAppliedMask[a]=0,level.rigidGroupIndexMask[a]=0;for(a=0;a<level.height;a++)level.rowCellContents[a].setZero();for(a=0;a<level.width;a++)level.colCellContents[a].setZero()}againing=!1;
level.commandQueue=[]}var zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0;function DoRestart(a){!0!==a&&"norestart"in state.metadata||(!1===a&&backups.push(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),level.commandQueue=[])}
function DoUndo(a){!levelEditorOpened&&"noundo"in state.metadata&&!0!==a||(verbose_logging&&consolePrint("--- undoing ---",!0),0<backups.length&&(restoreLevel(backups[backups.length-1]),backups=backups.splice(0,backups.length-1),a||tryPlayUndoSound()))}function getPlayerPositions(){var a=[],b=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),b.anyBitsInCommon(_o11)&&a.push(i);return a}
function getLayersOfMask(a){for(var b=[],c=0;c<state.objectCount;c++)a.get(c)&&b.push(state.objects[state.idDict[c]].layer);return b}function moveEntitiesAtIndex(a,b,c){var d=level.getCell(a);d.iand(b);b=getLayersOfMask(d);for(var d=level.getMovements(a),f=0;f<b.length;f++)d.ishiftor(c,5*b[f]);level.setMovements(a,d)}function startMovement(a){for(var b=getPlayerPositions(),c=0;c<b.length;c++)moveEntitiesAtIndex(b[c],state.playerMask,a);return b}
var dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];
function repositionEntitiesOnLayer(a,b,c){var d=dirMasksDelta[c],f=d[0],g=d[1],h=a/level.height|0,k=a%level.height,q=level.width-1,m=level.height-1;if(0===h&&0>f||h===q&&0<f||0===k&&0>g||k===m&&0<g)return!1;d=(a+d[1]+d[0]*level.height)%level.n_tiles;b=state.layerMasks[b];f=level.getCellInto(d,_o7);g=level.getCellInto(a,_o8);if(b.anyBitsInCommon(f)&&16!=c)return!1;for(c=0;c<state.sfx_MovementMasks.length;c++)h=state.sfx_MovementMasks[c],h.objectMask.anyBitsInCommon(g)&&level.getMovements(a).anyBitsInCommon(h.directionMask)&&
-1===seedsToPlay_CanMove.indexOf(h.seed)&&seedsToPlay_CanMove.push(h.seed);c=g.clone();g.iclear(b);c.iand(b);f.ior(c);level.setCell(a,g);level.setCell(d,f);a=d%level.height;level.colCellContents[d/level.height|0].ior(c);level.rowCellContents[a].ior(c);level.mapCellContents.ior(b);return!0}
function repositionEntitiesAtCell(a){var b=level.getMovements(a);if(b.iszero())return!1;for(var c=!1,d=0;d<level.layerCount;d++){var f=b.getshiftor(31,5*d);0!==f&&repositionEntitiesOnLayer(a,d,f)&&(b.ishiftclear(f,5*d),c=!0)}level.setMovements(a,b);return c}function Level(a,b,c,d,f){this.lineNumber=a;this.width=b;this.height=c;this.n_tiles=b*c;this.objects=f;this.layerCount=d;this.commandQueue=[]}
Level.prototype.clone=function(){var a=new Level(this.lineNumber,this.width,this.height,this.layerCount,null);a.objects=new Int32Array(this.objects);return a};Level.prototype.getCell=function(a){return new BitVec(this.objects.subarray(a*STRIDE_OBJ,a*STRIDE_OBJ+STRIDE_OBJ))};Level.prototype.getCellInto=function(a,b){for(var c=0;c<STRIDE_OBJ;c++)b.data[c]=this.objects[a*STRIDE_OBJ+c];return b};Level.prototype.setCell=function(a,b){for(var c=0;c<b.data.length;++c)this.objects[a*STRIDE_OBJ+c]=b.data[c]};
var _movementsVec;Level.prototype.getMovements=function(a){for(var b=0;b<STRIDE_MOV;b++)_movementsVec.data[b]=this.movements[a*STRIDE_MOV+b];return _movementsVec};Level.prototype.setMovements=function(a,b){for(var c=0;c<b.data.length;++c)this.movements[a*STRIDE_MOV+c]=b.data[c]};var ellipsisPattern=["ellipsis"];function BitVec(a){this.data=new Int32Array(a);return this}BitVec.prototype.cloneInto=function(a){for(var b=0;b<this.data.length;++b)a.data[b]=this.data[b];return a};
BitVec.prototype.clone=function(){return new BitVec(this.data)};BitVec.prototype.iand=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=a.data[b]};BitVec.prototype.ior=function(a){for(var b=0;b<this.data.length;++b)this.data[b]|=a.data[b]};BitVec.prototype.iclear=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=~a.data[b]};BitVec.prototype.ibitset=function(a){this.data[a>>5]|=1<<(a&31)};BitVec.prototype.ibitclear=function(a){this.data[a>>5]&=~(1<<(a&31))};
BitVec.prototype.get=function(a){return 0!==(this.data[a>>5]&1<<(a&31))};BitVec.prototype.getshiftor=function(a,b){var c=b&31,d=this.data[b>>5]>>>c;c&&(d|=this.data[(b>>5)+1]<<32-c);return d&a};BitVec.prototype.ishiftor=function(a,b){var c=b&31;this.data[b>>5]|=a<<c;c&&(this.data[(b>>5)+1]|=a>>32-c)};BitVec.prototype.ishiftclear=function(a,b){var c=b&31;this.data[b>>5]&=~(a<<c);c&&(this.data[(b>>5)+1]&=~(a>>32-(b&31)))};
BitVec.prototype.equals=function(a){if(this.data.length!==a.data.length)return!1;for(var b=0;b<this.data.length;++b)if(this.data[b]!==a.data[b])return!1;return!0};BitVec.prototype.setZero=function(){for(var a=0;a<this.data.length;++a)this.data[a]=0};BitVec.prototype.iszero=function(){for(var a=0;a<this.data.length;++a)if(this.data[a])return!1;return!0};BitVec.prototype.bitsSetInArray=function(a){for(var b=0;b<this.data.length;++b)if((this.data[b]&a[b])!==this.data[b])return!1;return!0};
BitVec.prototype.bitsClearInArray=function(a){for(var b=0;b<this.data.length;++b)if(this.data[b]&a[b])return!1;return!0};BitVec.prototype.anyBitsInCommon=function(a){return!this.bitsClearInArray(a.data)};
function Rule(a){this.direction=a[0];this.patterns=a[1];this.hasReplacements=a[2];this.lineNumber=a[3];this.isEllipsis=a[4];this.groupNumber=a[5];this.isRigid=a[6];this.commands=a[7];this.isRandom=a[8];this.cellRowMasks=a[9];this.cellRowMatches=[];for(a=0;a<this.patterns.length;a++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[a],this.isEllipsis[a]))}
Rule.prototype.generateCellRowMatchesFunction=function(a,b){if(!1==b){for(var c=dirMasksDelta[this.direction],d=c[0],f=c[1],c=a.length,d="var d = "+f+"+"+d+"*level.height;\n",f=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,g=0;g<STRIDE_OBJ;++g)d+="var cellObjects"+g+" = level.objects[i"+f+(g?"+"+g:"")+"];\n";f=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(g=0;g<STRIDE_MOV;++g)d+="var cellMovements"+g+" = level.movements[i"+f+(g?"+"+g:"")+"];\n";d+="return "+a[0].generateMatchString("0_");for(f=1;f<c;f++)d+="&&cellRow["+
f+"].matches((i+"+f+"*d)%level.n_tiles)";d+=";";return d in matchCache?matchCache[d]:matchCache[d]=new Function("cellRow","i",d)}c=dirMasksDelta[this.direction];d=c[0];f=c[1];c=a.length;d="var d = "+f+"+"+d+"*level.height;\nvar result = [];\n";d+="if(cellRow[0].matches(i)";for(f=1;a[f]!==ellipsisPattern;f++)d+="&&cellRow["+f+"].matches((i+"+f+"*d)%level.n_tiles)";f++;d+=") {\n";d+="\tfor (var k=kmin;k<kmax;k++) {\n";d+="\t\tif(cellRow["+f+"].matches((i+d*(k+"+(f-1)+"))%level.n_tiles)";for(f++;f<c;f++)d+=
"&&cellRow["+f+"].matches((i+d*(k+"+(f-1)+"))%level.n_tiles)";d+="){\n";d+="\t\t\tresult.push([i,k]);\n";d+="\t\t}\n";d+="\t}\n";d+="}\n";d+="return result;";return d in matchCache?matchCache[d]:matchCache[d]=new Function("cellRow","i","kmax","kmin",d)};Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks]};var STRIDE_OBJ=1,STRIDE_MOV=1;
function CellPattern(a){this.objectsPresent=a[0];this.objectsMissing=a[1];this.anyObjectsPresent=a[2];this.movementsPresent=a[3];this.movementsMissing=a[4];this.matches=this.generateMatchFunction();this.replacement=a[5]}function CellReplacement(a){this.objectsClear=a[0];this.objectsSet=a[1];this.movementsClear=a[2];this.movementsSet=a[3];this.movementsLayerMask=a[4];this.randomEntityMask=a[5];this.randomDirMask=a[6]}var matchCache={};
CellPattern.prototype.generateMatchString=function(){for(var a="(true",b=0;b<Math.max(STRIDE_OBJ,STRIDE_MOV);++b){var c="cellObjects"+b,d="cellMovements"+b,f=this.objectsPresent.data[b],g=this.objectsMissing.data[b],h=this.movementsPresent.data[b],k=this.movementsMissing.data[b];f&&(a=f&f-1?a+("\t\t&& (("+c+"&"+f+")==="+f+")\n"):a+("\t\t&& ("+c+"&"+f+")\n"));g&&(a+="\t\t&& !("+c+"&"+g+")\n");h&&(a=h&h-1?a+("\t\t&& (("+d+"&"+h+")==="+h+")\n"):a+("\t\t&& ("+d+"&"+h+")\n"));k&&(a+="\t\t&& !("+d+"&"+
k+")\n")}for(c=0;c<this.anyObjectsPresent.length;c++){a+="\t\t&& (0";for(b=0;b<STRIDE_OBJ;++b)(d=this.anyObjectsPresent[c].data[b])&&(a+="|(cellObjects"+b+"&"+d+")");a+=")"}return a+"\t)"};
CellPattern.prototype.generateMatchFunction=function(){var a,b="",c=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ;for(a=0;a<STRIDE_OBJ;++a)b+="\tvar cellObjects"+a+" = level.objects[i"+c+(a?"+"+a:"")+"];\n";c=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(a=0;a<STRIDE_MOV;++a)b+="\tvar cellMovements"+a+" = level.movements[i"+c+(a?"+"+a:"")+"];\n";b+="return "+this.generateMatchString()+";";return b in matchCache?matchCache[b]:matchCache[b]=new Function("i",b)};
CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]};var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3;
CellPattern.prototype.replace=function(a,b){var c=this.replacement;if(null===c)return!1;var d=c.randomEntityMask,f=c.randomDirMask,g=c.objectsSet.cloneInto(_o1),h=c.objectsClear.cloneInto(_o2),k=c.movementsSet.cloneInto(_m1),q=c.movementsClear.cloneInto(_m2);q.ior(c.movementsLayerMask);if(!d.iszero()){for(var m=[],v=0;v<32*STRIDE_OBJ;v++)d.get(v)&&m.push(v);d=m[Math.floor(RandomGen.uniform()*m.length)];m=state.objects[state.idDict[d]];g.ibitset(d);h.ior(state.layerMasks[m.layer]);q.ishiftor(31,5*
m.layer)}if(!f.iszero())for(d=0;d<level.layerCount;d++)f.get(5*d)&&(m=Math.floor(4*RandomGen.uniform()),k.ibitset(m+5*d));f=level.getCellInto(b,_o2_5);d=level.getMovements(b);m=f.cloneInto(_o3);v=d.cloneInto(_m3);f.iclear(h);f.ior(g);d.iclear(q);d.ior(k);g=!1;q=k=0;if(a.isRigid){k=state.groupNumber_to_RigidGroupIndex[a.groupNumber];k++;h=new BitVec(STRIDE_MOV);for(q=0;q<level.layerCount;q++)h.ishiftor(k,5*q);h.iand(c.movementsLayerMask);k=level.rigidGroupIndexMask[b]||new BitVec(STRIDE_MOV);q=level.rigidMovementAppliedMask[b]||
new BitVec(STRIDE_MOV);h.bitsSetInArray(k.data)||c.movementsLayerMask.bitsSetInArray(q.data)||(k.ior(h),q.ior(c.movementsLayerMask),g=!0)}c=!1;m.equals(f)&&v.equals(d)&&!g||(c=!0,g&&(level.rigidGroupIndexMask[b]=k,level.rigidMovementAppliedMask[b]=q),g=f.cloneInto(_o4),g.iclear(m),sfxCreateMask.ior(g),g=m.cloneInto(_o5),g.iclear(f),sfxDestroyMask.ior(g),level.setCell(b,f),level.setMovements(b,d),d=b%level.height,level.colCellContents[b/level.height|0].ior(f),level.rowCellContents[d].ior(f),level.mapCellContents.ior(f));
return c};function DoesCellRowMatchWildCard(a,b,c,d,f){void 0===f&&(f=0);var g=b[0];if(g.matches(c)){g=dirMasksDelta[a];a=g[0]*level.height;for(var h=g[1],k=1;k<b.length;k+=1)if(c=(c+h+a)%level.n_tiles,g=b[k],g===ellipsisPattern){for(;f<d;f++){for(var q=c,q=(q+(h+a)*f+level.n_tiles)%level.n_tiles,m=k+1;m<b.length;m++){g=b[m];if(!g.matches(q))break;q=(q+h+a)%level.n_tiles}if(m>=b.length)return!0}break}else if(!g.matches(c))break}return!1}
function DoesCellRowMatch(a,b,c,d){var f=b[0];if(f.matches(c)){f=dirMasksDelta[a];a=f[0]*level.height;for(var g=f[1],h=b.length,k=1;k<h&&(c=(c+g+a)%level.n_tiles,f=b[k],f===ellipsisPattern&&(c=(c+(g+a)*d)%level.n_tiles),f.matches(c));k++);if(k>=b.length)return!0}return!1}
function matchCellRow(a,b,c,d){var f=[];if(!d.bitsSetInArray(level.mapCellContents.data))return f;var g=0,h=level.width,k=0,q=level.height,m=c.length;switch(a){case 1:k+=m-1;break;case 2:q-=m-1;break;case 4:g+=m-1;break;case 8:h-=m-1;break;default:window.console.log("EEEP "+a)}if(2<a)for(a=k;a<q;a++){if(d.bitsSetInArray(level.rowCellContents[a].data))for(m=g;m<h;m++){var v=m*level.height+a;b(c,v)&&f.push(v)}}else for(m=g;m<h;m++)if(d.bitsSetInArray(level.colCellContents[m].data))for(a=k;a<q;a++)v=
m*level.height+a,b(c,v)&&f.push(v);return f}
function matchCellRowWildCard(a,b,c,d){var f=[];if(!d.bitsSetInArray(level.mapCellContents.data))return f;var g=0,h=level.width,k=0,q=level.height,m=c.length-1;switch(a){case 1:k+=m-1;break;case 2:q-=m-1;break;case 4:g+=m-1;break;case 8:h-=m-1;break;default:window.console.log("EEEP2 "+a)}if(2<a)for(var v=k;v<q;v++){if(d.bitsSetInArray(level.rowCellContents[v].data))for(var A=g;A<h;A++){var B=A*level.height+v,F;4===a?F=A-m+2:8===a?F=level.width-(A+m)+1:window.console.log("EEEP2 "+a);f.push.apply(f,
b(c,B,F,0))}}else for(A=g;A<h;A++)if(d.bitsSetInArray(level.colCellContents[A].data))for(v=k;v<q;v++)B=A*level.height+v,2===a?F=level.height-(v+m)+1:1===a?F=v-m+2:window.console.log("EEEP2 "+a),f.push.apply(f,b(c,B,F,0));return f}function generateTuples(a){for(var b=[[]],c=0;c<a.length;c++){for(var d=a[c],f=[],g=0;g<d.length;g++)for(var h=d[g],k=0;k<b.length;k++){var q=b[k].concat([h]);f.push(q)}b=f}return b}var rigidBackups=[];
function commitPreservationState(a){var b={ruleGroupIndex:a,objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([])};return rigidBackups[a]=b}
function restorePreservationState(a){level.objects=new Int32Array(a.objects);level.movements=new Int32Array(a.movements);level.rigidGroupIndexMask=a.rigidGroupIndexMask.concat([]);level.rigidMovementAppliedMask=a.rigidMovementAppliedMask.concat([]);sfxCreateMask=new BitVec(STRIDE_OBJ);sfxDestroyMask=new BitVec(STRIDE_OBJ)}
Rule.prototype.findMatches=function(){for(var a=[],b=this.cellRowMasks,c=0;c<this.patterns.length;c++){var d=this.patterns[c],f=this.cellRowMatches[c],d=this.isEllipsis[c]?matchCellRowWildCard(this.direction,f,d,b[c]):matchCellRow(this.direction,f,d,b[c]);if(0===d.length)return[];a.push(d)}return a};
Rule.prototype.applyAt=function(a,b,c){if(c){var d=!0;for(c=0;c<this.patterns.length;c++)if(this.isEllipsis[c]){if(!1===DoesCellRowMatchWildCard(this.direction,this.patterns[c],b[c][0],b[c][1]+1,b[c][1])){d=!1;break}}else if(!1===DoesCellRowMatch(this.direction,this.patterns[c],b[c])){d=!1;break}if(!1===d)return!1}var d=!1,f=a[0]*level.height;a=a[1];for(c=0;c<this.patterns.length;c++)for(var g=this.patterns[c],h=this.isEllipsis[c]?b[c][0]:b[c],k=0;k<g.length;k++){var q=g[k];q===ellipsisPattern?h=
(h+(a+f)*b[c][1])%level.n_tiles:(d=q.replace(this,h)||d,h=(h+a+f)%level.n_tiles)}verbose_logging&&d&&consolePrint('<font color="green">Rule <a onclick="jumpToLine('+this.lineNumber+');"  href="javascript:void(0);">'+this.lineNumber+"</a> "+dirMaskName[this.direction]+" applied.</font>");return d};
Rule.prototype.tryApply=function(){var a=dirMasksDelta[this.direction],b=this.findMatches();if(0===b.length)return!1;var c=!1;if(this.hasReplacements)for(var d=generateTuples(b),f=0;f<d.length;f++)c=this.applyAt(a,d[f],0<f)||c;0<b.length&&this.queueCommands();return c};
Rule.prototype.queueCommands=function(){for(var a=this.commands,b=0;b<a.length;b++){var c=a[b];if(!(0<=level.commandQueue.indexOf(c[0]))){level.commandQueue.push(c[0]);if(verbose_logging){var d=this.lineNumber;consolePrint('<font color="green">Rule <a onclick="jumpToLine('+d.toString()+');"  href="javascript:void(0);">'+d.toString()+"</a> triggers command "+c[0]+".</font>")}"message"===c[0]&&(messagetext=c[1])}}};
function showTempMessage(){keybuffer=[];textMode=!0;messageselected=quittingMessageScreen=titleScreen=!1;tryPlayShowMessageSound();drawMessageScreen();canvasResize()}
function applyRandomRuleGroup(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],d=d.findMatches();if(0<d.length)for(var d=generateTuples(d),f=0;f<d.length;f++){var g=d[f];b.push([c,g])}}if(0===b.length)return!1;b=b[Math.floor(RandomGen.uniform()*b.length)];c=b[0];d=a[c];a=dirMasksDelta[d.direction];g=b[1];a=d.applyAt(a,g,!1);d.queueCommands();return a}
function applyRuleGroup(a){if(a[0].isRandom)return applyRandomRuleGroup(a);for(var b=!1,c=!0,d=0;c;){d++;if(200<d){logErrorCacheable("Got caught looping lots in a rule group :O",a[0].lineNumber,!0);break}for(var c=!1,f=0;f<a.length;f++)c=a[f].tryApply()||c;c&&(b=!0)}return b}
function applyRules(a,b,c,d){for(var f=0<c,g=0;c<a.length;){if(!d||!d[c])var h=a[c],f=applyRuleGroup(h)||f;if(f&&void 0!==b[c]){if(c=b[c],f=!1,g++,200<g){h=a[c];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",h[0].lineNumber,!0);break}}else if(c++,c===a.length&&f&&void 0!==b[c]&&(c=b[c],f=!1,g++,200<g)){h=a[c];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",h[0].lineNumber,!0);break}}}
function resolveMovements(a){for(var b=!0;b;)for(b=!1,a=0;a<level.n_tiles;a++)b=repositionEntitiesAtCell(a)||b;var c=!1;for(a=0;a<level.n_tiles;a++){var b=level.getCellInto(a,_o6),d=level.getMovements(a);if(!d.iszero()){var f=level.rigidMovementAppliedMask[a];if(0!==f&&(d.iand(f),!d.iszero()))for(f=0;f<level.layerCount;f++)if(0!==d.getshiftor(31,5*f)){c=level.rigidGroupIndexMask[a].getshiftor(31,5*f);c--;c=level.bannedGroup[state.rigidGroupIndex_to_GroupIndex[c]]=!0;break}for(f=0;f<state.sfx_MovementFailureMasks.length;f++){var g=
state.sfx_MovementFailureMasks[f];g.objectMask.anyBitsInCommon(b)&&d.anyBitsInCommon(g.directionMask)&&-1===seedsToPlay_CantMove.indexOf(g.seed)&&seedsToPlay_CantMove.push(g.seed)}}for(f=0;f<STRIDE_MOV;f++)level.movements[f+a*STRIDE_MOV]=0;level.rigidGroupIndexMask[a]=0;level.rigidMovementAppliedMask[a]=0}return c}var sfxCreateMask=0,sfxDestroyMask=0;
function calculateRowColMasks(){for(var a=0;a<level.mapCellContents.length;a++)level.mapCellContents[a]=0;for(a=0;a<level.width;a++)level.colCellContents[a].setZero();for(a=0;a<level.height;a++)level.rowCellContents[a].setZero();for(a=0;a<level.width;a++)for(var b=0;b<level.height;b++){var c=level.getCellInto(b+a*level.height,_o9);level.mapCellContents.ior(c);level.rowCellContents[b].ior(c);level.colCellContents[a].ior(c)}}
function processInput(a,b,c){againing=!1;verbose_logging&&(-1===a?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action"][a]+".")));var d=backupLevel(),f=[];if(4>=a){if(0<=a){switch(a){case 0:a=1;break;case 1:a=4;break;case 2:a=2;break;case 3:a=8;break;case 4:a=16}f=startMovement(a)}var g=0;level.bannedGroup=[];rigidBackups=[];level.commandQueue=[];var h=0,k=!1,q=commitPreservationState();sfxCreateMask=
new BitVec(STRIDE_OBJ);sfxDestroyMask=new BitVec(STRIDE_OBJ);seedsToPlay_CanMove=[];seedsToPlay_CantMove=[];calculateRowColMasks();do k=!1,g++,verbose_logging&&consolePrint("applying rules"),applyRules(state.rules,state.loopPoint,h,level.bannedGroup),resolveMovements()?(k=!0,restorePreservationState(q)):(verbose_logging&&consolePrint("applying late rules"),applyRules(state.lateRules,state.lateLoopPoint,0)),h=0;while(50>g&&k);50<=g&&consolePrint("looped through 50 times, gave up.  too many loops!");
if(0<f.length&&void 0!==state.metadata.require_player_movement){h=!1;for(g=0;g<f.length;g++)if(k=level.getCell(f[g]),state.playerMask.bitsClearInArray(k.data)){h=!0;break}if(!1===h)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),backups.push(d),DoUndo(!0),!1}if(0<=level.commandQueue.indexOf("cancel"))return verbose_logging&&(consolePrint("CANCEL command executed, cancelling turn."),consoleCacheDump()),backups.push(d),
DoUndo(!0),!1;if(0<=level.commandQueue.indexOf("restart"))return verbose_logging&&(consolePrint("RESTART command executed, reverting to restart state."),consoleCacheDump()),backups.push(d),DoRestart(!0),!0;if(c&&0<=level.commandQueue.indexOf("win"))return!0;h=!1;for(g=0;g<level.objects.length;g++)if(level.objects[g]!==d.dat[g]){if(c)return verbose_logging&&consoleCacheDump(),backups.push(d),DoUndo(!0),!0;-1!==a&&backups.push(d);h=!0;break}if(c)return verbose_logging&&consoleCacheDump(),!1;for(g=0;g<
seedsToPlay_CantMove.length;g++)playSound(seedsToPlay_CantMove[g]);for(g=0;g<seedsToPlay_CanMove.length;g++)playSound(seedsToPlay_CanMove[g]);for(g=0;g<state.sfx_CreationMasks.length;g++)a=state.sfx_CreationMasks[g],sfxCreateMask.anyBitsInCommon(a.objectMask)&&playSound(a.seed);for(g=0;g<state.sfx_DestructionMasks.length;g++)a=state.sfx_DestructionMasks[g],sfxDestroyMask.anyBitsInCommon(a.objectMask)&&playSound(a.seed);for(g=0;g<level.commandQueue.length;g++)a=level.commandQueue[g],"f"===a.charAt(1)&&
tryPlaySimpleSound(a),!1===unitTesting&&"message"===a&&showTempMessage();!1!==textMode||void 0!==b&&!1!==b||(verbose_logging&&consolePrint("Checking win condition."),checkWin());if(!winning){if(0<=level.commandQueue.indexOf("checkpoint")){verbose_logging&&consolePrint("CHECKPOINT command executed, saving current state to the restart state.");curlevelTarget=restartTarget=backupLevel();localStorage[document.URL+"_checkpoint"]=JSON.stringify(restartTarget);b=JSON.parse(localStorage[document.URL+"_checkpoint"]);
var g=[],m;for(m in Object.getOwnPropertyNames(b.dat))g[m]=b.dat[m];b.dat=new Int32Array(g);localStorage[document.URL]=curlevel}0<=level.commandQueue.indexOf("again")&&h&&(m=verbose_logging,b=messagetext,verbose_logging=!1,processInput(-1,!0,!0)?((verbose_logging=m)&&consolePrint("AGAIN command executed, with changes detected - will execute another turn."),againing=!0,timer=0):(verbose_logging=m)&&consolePrint("AGAIN command not executed, it wouldn't make any changes."),verbose_logging=m,messagetext=
b)}level.commandQueue=[]}verbose_logging&&consoleCacheDump();winning&&(againing=!1);return h}
function checkWin(){if(!levelEditorOpened)if(0<=level.commandQueue.indexOf("win"))consolePrint("Win Condition Satisfied"),DoWin();else{var a=!1;if(0<state.winconditions.length)for(var a=!0,b=0;b<state.winconditions.length;b++){var c=state.winconditions[b],d=c[1],f=c[2],g=!0;switch(c[0]){case -1:for(c=0;c<level.n_tiles;c++){var h=level.getCellInto(c,_o10);if(!d.bitsClearInArray(h.data)&&!f.bitsClearInArray(h.data)){g=!1;break}}break;case 0:for(var k=!1,c=0;c<level.n_tiles;c++)if(h=level.getCellInto(c,
_o10),!d.bitsClearInArray(h.data)&&!f.bitsClearInArray(h.data)){k=!0;break}!1===k&&(g=!1);break;case 1:for(c=0;c<level.n_tiles;c++)if(h=level.getCellInto(c,_o10),!d.bitsClearInArray(h.data)&&f.bitsClearInArray(h.data)){g=!1;break}}!1===g&&(a=!1)}a&&(consolePrint("Win Condition Satisfied"),DoWin())}}function DoWin(){winning||(againing=!1,tryPlayEndLevelSound(),unitTesting?nextLevel():(winning=!0,timer=0))}
function nextLevel(){keybuffer=[];againing=!1;messagetext="";titleScreen?(0===titleSelection&&(curlevel=0,curlevelTarget=null),null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel)):curlevel<state.levels.length-1?(curlevel++,messageselected=quittingMessageScreen=titleScreen=textMode=!1,null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel)):(curlevel=0,curlevelTarget=null,goToTitleScreen(),
tryPlayEndGameSound());try{window.localStorage&&(localStorage[document.URL]=curlevel,null!==curlevelTarget?localStorage[document.URL+"_checkpoint"]=JSON.stringify(curlevelTarget):localStorage.removeItem(document.URL+"_checkpoint"))}catch(a){}canvasResize();clearInputHistory()}function goToTitleScreen(){againing=!1;messagetext="";textMode=titleScreen=!0;titleSelection=0<curlevel||null!==curlevelTarget?1:0;generateTitleScreen()};var compiling=!1,errorStrings=[],errorCount=0;function logErrorCacheable(a,b,c){if(compiling||c){if(void 0===b)return logErrorNoLine(a);a='<a onclick="jumpToLine('+b.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+b.toString()+'</span></a> : <span class="errorText">'+a+"</span>";0<=errorStrings.indexOf(a)&&!c||(consolePrint(a),errorStrings.push(a),errorCount++)}}
function logError(a,b,c){if(compiling||c){if(void 0===b)return logErrorNoLine(a);a='<a onclick="jumpToLine('+b.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+b.toString()+'</span></a> : <span class="errorText">'+a+"</span>";0<=errorStrings.indexOf(a)&&!c||(consolePrint(a,!0),errorStrings.push(a),errorCount++)}}
function logWarning(a,b,c){if(compiling||c){if(void 0===b)return logErrorNoLine(a);a='<a onclick="jumpToLine('+b.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+b.toString()+'</span></a> : <span class="warningText">'+a+"</span>";0<=errorStrings.indexOf(a)&&!c||(consolePrint(a,!0),errorStrings.push(a))}}
function logErrorNoLine(a,b){if(compiling||b){var c='<span class="errorText">'+a+"</span>";0<=errorStrings.indexOf(c)&&!b||(consolePrint(c,!0),errorStrings.push(c));errorCount++}}function logBetaMessage(a,b){if(compiling||b){var c='<span class="betaText">'+a+"</span>";0<=errorStrings.indexOf(c)&&!b||(consoleError(c),errorStrings.push(c))}}function blankLineHandle(a){"levels"===a.section?0<a.levels[a.levels.length-1].length&&a.levels.push([]):"objects"===a.section&&(a.objects_section=0)}
var codeMirrorFn=function(){function a(a,b){if(void 0!==a.objects[b])return logError('Object "'+b.toUpperCase()+'" defined multiple times.',a.lineNumber),"ERROR";for(var c=0;c<a.legend_synonyms.length;c++){var d=a.legend_synonyms[c];d[0]==b&&logError('Name "'+b.toUpperCase()+'" already in use.',a.lineNumber)}for(c=0;c<a.legend_aggregates.length;c++)d=a.legend_aggregates[c],d[0]==b&&logError('Name "'+b.toUpperCase()+'" already in use.',a.lineNumber);for(c=0;c<a.legend_properties.length;c++)d=a.legend_properties[c],
d[0]==b&&logError('Name "'+b.toUpperCase()+'" already in use.',a.lineNumber)}var b="objects legend sounds collisionlayers rules winconditions levels".split(" "),c="sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10 cancel checkpoint restart win message again".split(" "),d=/[\w]+\s*/,f=/\d+\b/,g=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)\s*/,h=/[\=]+/,k=/[^\(]+/,q=/[ \,]*/,m=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\s+/,
v=/^(action|up|down|left|right|\^|v|\<|\>|forward|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/,A=/^(startloop|endloop)$/,B=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,F=/\s*(up|down|left|right|horizontal|vertical|orthogonal)\s*/,J=/^(all|any|no|some)$/,C="objects collisionlayers legend sounds rules ... winconditions levels up down left right late rigid ^ v > < no randomdir random horizontal vertical any all no some moving stationary parallel perpendicular action message".split(" ");
return{copyState:function(a){var b={},c;for(c in a.objects)if(a.objects.hasOwnProperty(c)){var d=a.objects[c];b[c]={colors:d.colors.concat([]),lineNumber:d.lineNumber,spritematrix:d.spritematrix.concat([])}}d=[];for(c=0;c<a.collisionLayers.length;c++)d.push(a.collisionLayers[c].concat([]));var f=[],g=[],h=[],k=[],m=[],q=[];for(c=0;c<a.legend_synonyms.length;c++)f.push(a.legend_synonyms[c].concat([]));for(c=0;c<a.legend_aggregates.length;c++)g.push(a.legend_aggregates[c].concat([]));for(c=0;c<a.legend_properties.length;c++)h.push(a.legend_properties[c].concat([]));
for(c=0;c<a.sounds.length;c++)k.push(a.sounds[c].concat([]));for(c=0;c<a.levels.length;c++)m.push(a.levels[c].concat([]));for(c=0;c<a.winconditions.length;c++)q.push(a.winconditions[c].concat([]));return{lineNumber:a.lineNumber,objects:b,collisionLayers:d,commentLevel:a.commentLevel,section:a.section,visitedSections:a.visitedSections.concat([]),objects_candname:a.objects_candname,objects_section:a.objects_section,objects_spritematrix:a.objects_spritematrix.concat([]),tokenIndex:a.tokenIndex,legend_synonyms:f,
legend_aggregates:g,legend_properties:h,sounds:k,rules:a.rules.concat([]),names:a.names.concat([]),winconditions:q,abbrevNames:a.abbrevNames.concat([]),metadata:a.metadata.concat([]),levels:m,STRIDE_OBJ:a.STRIDE_OBJ,STRIDE_MOV:a.STRIDE_MOV}},blankLine:function(a){"levels"===a.section&&0<a.levels[a.levels.length-1].length&&a.levels.push([])},token:function(w,l){var r=w.string,H=w.sol();H&&(w.string=w.string.toLowerCase(),l.tokenIndex=0);w.eatWhile(/[ \t]/);var s=w.peek();if("("===s&&-4!==l.tokenIndex)w.next(),
l.commentLevel++;else if(")"===s&&(w.next(),0<l.commentLevel&&(l.commentLevel--,0===l.commentLevel)))return"comment";if(0<l.commentLevel){for(;;){w.eatWhile(/[^\(\)]+/);if(w.eol())break;s=w.peek();"("===s?l.commentLevel++:")"===s&&l.commentLevel--;w.next();if(0===l.commentLevel)break}return"comment"}w.eatWhile(/[ \t]/);if(H&&w.eol())return blankLineHandle(l);if(H&&w.match(h,!0))return"EQUALSBIT";if(w.match(g,!0)){l.section=w.string.slice(0,w.pos).trim();0<=l.visitedSections.indexOf(l.section)&&logError('cannot duplicate sections (you tried to duplicate "'+
l.section.toUpperCase()+'").',l.lineNumber);l.visitedSections.push(l.section);s=b.indexOf(l.section);0==s?(l.objects_section=0,1<l.visitedSections.length&&logError('section "'+l.section.toUpperCase()+'" must be the first section',l.lineNumber)):-1==l.visitedSections.indexOf(b[s-1])&&(-1===s?logError('no such section as "'+l.section.toUpperCase()+'".',l.lineNumber):logError('section "'+l.section.toUpperCase()+'" is out of order, must follow  "'+b[s-1].toUpperCase()+'".',l.lineNumber));if("sounds"===
l.section){for(var K in l.objects)l.objects.hasOwnProperty(K)&&l.names.push(K);for(s=0;s<l.legend_synonyms.length;s++)K=l.legend_synonyms[s][0],l.names.push(K);for(s=0;s<l.legend_aggregates.length;s++)K=l.legend_aggregates[s][0],l.names.push(K);for(s=0;s<l.legend_properties.length;s++)K=l.legend_properties[s][0],l.names.push(K)}else if("levels"===l.section){for(K in l.objects)l.objects.hasOwnProperty(K)&&1==K.length&&l.abbrevNames.push(K);for(s=0;s<l.legend_synonyms.length;s++)1==l.legend_synonyms[s][0].length&&
l.abbrevNames.push(l.legend_synonyms[s][0]);for(s=0;s<l.legend_aggregates.length;s++)1==l.legend_aggregates[s][0].length&&l.abbrevNames.push(l.legend_aggregates[s][0])}return"HEADER"}void 0===l.section&&logError('must start with section "OBJECTS"',l.lineNumber);if(w.eol())return null;switch(l.section){case "objects":K=function(){var a=H?w.match(d,!0):w.match(/[^\s\()]+\s*/,!0);if(null==a)return w.match(k,!0),"ERROR";a=a[0].trim();if(void 0!==l.objects[a])return logError('Object "'+a.toUpperCase()+
'" defined multiple times.',l.lineNumber),"ERROR";for(var b=0;b<l.legend_synonyms.length;b++)l.legend_synonyms[b][0]==a&&logError('Name "'+a.toUpperCase()+'" already in use.',l.lineNumber);0<=C.indexOf(a)&&logWarning('You named an object "'+a.toUpperCase()+"\", but this is a keyword. Don't do that!",l.lineNumber);H?(l.objects_candname=a,l.objects[l.objects_candname]={lineNumber:l.lineNumber,colors:[],spritematrix:[]}):(a=[a,l.objects_candname],a.lineNumber=l.lineNumber,l.legend_synonyms.push(a));
l.objects_section=1;return"NAME"};H&&2==l.objects_section&&(l.objects_section=3);H&&1==l.objects_section&&(l.objects_section=2);switch(l.objects_section){case 0:case 1:return l.objects_spritematrix=[],K();case 2:l.tokenIndex=0;s=w.match(reg_color,!0);if(null==s)return s=w.match(d,!0)||w.match(k,!0),logError("Was looking for color for object "+l.objects_candname.toUpperCase()+', got "'+s+'" instead.',l.lineNumber),null;void 0===l.objects[l.objects_candname].colors?l.objects[l.objects_candname].colors=
[s[0].trim()]:l.objects[l.objects_candname].colors.push(s[0].trim());s=s[0].trim().toLowerCase();return s in colorPalettes.arnecolors?"COLOR COLOR-"+s.toUpperCase():"transparent"===s?"COLOR FADECOLOR":"COLOR";case 3:s=w.eat(/[.\d]/);r=l.objects_spritematrix;if(void 0===s){if(0===r.length)return K();logError("Unknown junk in spritematrix for object "+l.objects_candname.toUpperCase()+".",l.lineNumber);w.match(k,!0);return null}H&&r.push("");var W=l.objects[l.objects_candname];r[r.length-1]+=s;5===r.length&&
5==r[r.length-1].length&&(W.spritematrix=l.objects_spritematrix,l.objects_section=0);return"."!==s?(K=parseInt(s),K>=W.colors.length?(logError("trying to access color number "+K+" from the color palette of sprite "+l.objects_candname.toUpperCase()+", but there are only "+W.colors.length+" defined in it.",l.lineNumber),"ERROR"):isNaN(K)?(logError('invalid character "'+s+'" in sprite for '+l.objects_candname.toUpperCase(),l.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+W.colors[K].toUpperCase()):"COLOR FADECOLOR";
default:window.console.logError("EEK shouldn't get here.")}break;case "sounds":if(H){var X=!0,r=k.exec(w.string)[0].split(/\s/).filter(function(a){return""!==a});r.push(l.lineNumber);l.sounds.push(r)}P=w.match(m,!0);if(null!==P)return"SOUNDVERB";P=w.match(F,!0);if(null!==P)return"DIRECTION";P=w.match(f,!0);if(null!==P)return l.tokenIndex++,"SOUND";P=w.match(/[^\[\|\]\s]*/,!0);if(null!==P&&(s=P[0].trim(),0<=l.names.indexOf(s)))return"NAME";P=w.match(k,!0);logError('unexpected sound token "'+P+'".',
l.lineNumber);w.match(k,!0);return"ERROR";case "collisionlayers":H&&(l.collisionLayers.push([]),l.tokenIndex=0);s=w.match(d,!0);if(null===s)return s=w.pos,w.match(q,!0),w.pos==s&&(logError("error detected - unexpected character "+w.peek(),l.lineNumber),w.next()),null;var P=s[0].trim(),Y=function(a){a=a.toLowerCase();if(a in l.objects)return[a];for(var b=0;b<l.legend_synonyms.length;b++){var c=l.legend_synonyms[b];if(c[0]===a)return[c[1]]}for(b=0;b<l.legend_aggregates.length;b++)if(c=l.legend_aggregates[b],
c[0]===a)return logError('"'+a+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',l.lineNumber),[];for(b=0;b<l.legend_properties.length;b++)if(c=l.legend_properties[b],c[0]===a)return[].concat.apply([],c.slice(1).map(Y));logError('Cannot add "'+P.toUpperCase()+'" to a collision layer; it has not been declared.',l.lineNumber);return[]};"background"===P?(0<l.collisionLayers.length&&0<l.collisionLayers[l.collisionLayers.length-
1].length&&logError("Background must be in a layer by itself.",l.lineNumber),l.tokenIndex=1):0!==l.tokenIndex&&logError("Background must be in a layer by itself.",l.lineNumber);s=Y(P);if(0===l.collisionLayers.length)return logError("no layers found.",l.lineNumber),"ERROR";l.collisionLayers[l.collisionLayers.length-1]=l.collisionLayers[l.collisionLayers.length-1].concat(s);return 0<s.length?"NAME":"ERROR";case "legend":if(H){s=w.string.replace("="," = ");s=k.exec(s)[0];r=s.split(/\s/).filter(function(a){return""!==
a});X=!0;0<r.length&&(P=r[0].toLowerCase(),0<=C.indexOf(P)&&logWarning('You named an object "'+P.toUpperCase()+"\", but this is a keyword. Don't do that!",l.lineNumber),2<=r.indexOf(P,2)&&logError("You can't define object "+P.toUpperCase()+" in terms of itself!",l.lineNumber),a(l,P));if(3>r.length)X=!1;else if("="!==r[1])X=!1;else if(3===r.length)s=[r[0],r[2].toLowerCase()],s.lineNumber=l.lineNumber,l.legend_synonyms.push(s);else if(0===r.length%2)X=!1;else if(s=r[3].toLowerCase(),"and"===s){Y=function(a){a=
a.toLowerCase();if(a in l.objects)return[a];for(var b=0;b<l.legend_synonyms.length;b++){var c=l.legend_synonyms[b];if(c[0]===a)return[1]}for(b=0;b<l.legend_aggregates.length;b++)if(c=l.legend_aggregates[b],c[0]===a)return[].concat.apply([],c.slice(1).map(Y));for(b=0;b<l.legend_properties.length;b++)if(c=l.legend_properties[b],c[0]===a){logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",l.lineNumber);X=!1;break}return[a]};for(s=5;s<r.length;s+=2)if("and"!==
r[s].toLowerCase()){X=!1;break}if(X){K=[r[0]].concat(Y(r[2])).concat(Y(r[4]));for(s=6;s<r.length;s+=2)K=K.concat(Y(r[s]));K.lineNumber=l.lineNumber;l.legend_aggregates.push(K)}}else if("or"===s){Y=function(a){a=a.toLowerCase();if(a in l.objects)return[a];for(var b=0;b<l.legend_synonyms.length;b++){var c=l.legend_synonyms[b];if(c[0]===a)return[1]}for(b=0;b<l.legend_aggregates.length;b++)c=l.legend_aggregates[b],c[0]===a&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",
l.lineNumber),X=!1);for(b=0;b<l.legend_properties.length;b++)if(c=l.legend_properties[b],c[0]===a)return[].concat.apply([],c.slice(1).map(Y));return[a]};for(s=5;s<r.length;s+=2)if("or"!==r[s].toLowerCase()){X=!1;break}if(X){K=[r[0],r[2].toLowerCase(),r[4].toLowerCase()];for(s=6;s<r.length;s+=2)K.push(r[s].toLowerCase());K.lineNumber=l.lineNumber;l.legend_properties.push(K)}}else X=!1;if(!1===X)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",
l.lineNumber),w.match(k,!0),"ERROR";l.tokenIndex=0}if(0===l.tokenIndex)return w.match(/[^=]*/,!0),l.tokenIndex++,"NAME";if(1===l.tokenIndex)return w.next(),w.match(/\s*/,!0),l.tokenIndex++,"ASSSIGNMENT";s=w.match(d,!0);if(null===s)return logError("Something bad's happening in the LEGEND",l.lineNumber),w.match(k,!0),"ERROR";P=s[0].trim();if(0===l.tokenIndex%2){if(!1===function(a){a=a.toLowerCase();if(a in l.objects)return!0;for(var b=0;b<l.legend_aggregates.length;b++){var c=l.legend_aggregates[b];
if(c[0]===a)return!0}for(b=0;b<l.legend_properties.length;b++)if(c=l.legend_properties[b],c[0]===a)return!0;for(b=0;b<l.legend_synonyms.length;b++)if(c=l.legend_synonyms[b],c[0]===a)return!0;return!1}(P))return logError('Cannot reference "'+P.toUpperCase()+'" in the LEGEND section; it has not been defined yet.',l.lineNumber),l.tokenIndex++,"ERROR";l.tokenIndex++;return"NAME"}l.tokenIndex++;return"LOGICWORD";case "rules":H&&(K=k.exec(w.string)[0],l.rules.push([K,l.lineNumber,r]),l.tokenIndex=0);if(-4===
l.tokenIndex)return w.skipToEnd(),"MESSAGE";if(w.match(/\s*\-\>\s*/,!0))return"ARROW";if("["===s||"|"===s||"]"===s||"+"===s)return"+"!==s&&(l.tokenIndex=1),w.next(),w.match(/\s*/,!0),"BRACKET";s=w.match(/[^\[\|\]\s]*/,!0)[0].trim();if(0===l.tokenIndex&&A.exec(s))return"BRACKET";if(0===l.tokenIndex&&B.exec(s)||1===l.tokenIndex&&v.exec(s))return w.match(/\s*/,!0),"DIRECTION";if(0<=l.names.indexOf(s)){if(H)return logError("Identifiers cannot appear outside of square brackes in rules, only directions can.",
l.lineNumber),"ERROR";w.match(/\s*/,!0);return"NAME"}if("..."===s||"rigid"===s||"random"===s)return"DIRECTION";if(0<=c.indexOf(s))return"message"===s&&(l.tokenIndex=-4),"COMMAND";logError('Name "'+s+'", referred to in a rule, does not exist.',l.lineNumber);return"ERROR";case "winconditions":H&&(s=k.exec(w.string)[0].split(/\s/).filter(function(a){return""!==a}),s.push(l.lineNumber),l.winconditions.push(s),l.tokenIndex=-1);l.tokenIndex++;s=w.match(/\s*\w+\s*/);if(null===s)return logError("incorrect format of win condition.",
l.lineNumber),w.match(k,!0),"ERROR";s=s[0].trim();if(0===l.tokenIndex)return J.exec(s)?"LOGICWORD":"ERROR";if(2===l.tokenIndex)return"on"!=s?"ERROR":"LOGICWORD";if(1===l.tokenIndex||3===l.tokenIndex)return-1===l.names.indexOf(s)?(logError('Error in win condition: "'+s.toUpperCase()+'" is not a valid object name.',l.lineNumber),"ERROR"):"NAME";break;case "levels":if(H){if(w.match(/\s*message\s*/,!0))return l.tokenIndex=1,s=["\n",r.slice(w.pos).trim()],0==l.levels[l.levels.length-1].length?l.levels.splice(l.levels.length-
1,0,s):l.levels.push(s),"MESSAGE_VERB";s=w.match(k,!1)[0].trim();l.tokenIndex=2;r=l.levels[l.levels.length-1];"\n"==r[0]?l.levels.push([l.lineNumber,s]):(0==r.length&&r.push(l.lineNumber),r.push(s))}else if(1==l.tokenIndex)return w.skipToEnd(),"MESSAGE";if(2===l.tokenIndex&&!w.eol()){s=w.peek();w.next();if(0<=l.abbrevNames.indexOf(s))return"LEVEL";logError('Key "'+s.toUpperCase()+'" not found. Do you need to add it to the legend, or define a new object?',l.lineNumber);return"ERROR"}break;default:if(H&&
(l.tokenIndex=0),0==l.tokenIndex){if(s=w.match(/\s*\w+\s*/),null!==s){s=s[0].trim();if(H)if(0<="title author homepage background_color text_color key_repeat_interval realtime_interval again_interval flickscreen zoomscreen color_palette youtube".split(" ").indexOf(s)){if("youtube"===s||"author"===s||"title"===s)w.string=r;r=w.match(k,!1);null!=r?(l.metadata.push(s),l.metadata.push(r[0].trim())):logError('MetaData "'+s+'" needs a value.',l.lineNumber);l.tokenIndex=1}else if(0<="run_rules_on_level_start norepeat_action require_player_movement debug verbose_logging throttle_movement noundo noaction norestart scanline".split(" ").indexOf(s))l.metadata.push(s),
l.metadata.push("true"),l.tokenIndex=-1;else return logError("Unrecognised stuff in metadata section.",l.lineNumber),"ERROR";else if(-1==l.tokenIndex)return logError('MetaData "'+s+'" has no parameters.',l.lineNumber),"ERROR";return"METADATA"}}else return w.match(k,!0),"METADATATEXT"}if(w.eol())return null;if(!w.eol())return w.next(),null},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],
collisionLayers:[],tokenIndex:0,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);function isColor(a){a=a.trim();return a in colorPalettes.arnecolors||/^#([0-9A-F]{3}){1,2}$/i.test(a)||"transparent"===a?!0:!1}function colorToHex(a,b){b=b.trim();return b in a?a[b]:b}function generateSpriteMatrix(a){for(var b=[],c=0;c<a.length;c++){for(var d=[],f=0;f<a.length;f++){var g=a[c].charAt(f);"."==g?d.push(-1):d.push(g)}b.push(d)}return b}var debugMode,colorPalette;
function generateExtraMembers(a){0===a.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers.");a.idDict={};for(var b=0,c=0;c<a.collisionLayers.length;c++)for(var d=0;d<a.collisionLayers[c].length;d++){var f=a.collisionLayers[c][d];if(f in a.objects){var g=a.objects[f];g.layer=c;g.id=b;a.idDict[b]=f;b++}}a.objectCount=b;d=a.collisionLayers.length;c=[];for(b=0;b<d;b++)c.push(-1);STRIDE_OBJ=Math.ceil(a.objectCount/32)|0;STRIDE_MOV=Math.ceil(d/5)|
0;a.STRIDE_OBJ=STRIDE_OBJ;a.STRIDE_MOV=STRIDE_MOV;throttle_movement=verbose_logging=debugMode=!1;colorPalette=colorPalettes.arnecolors;for(b=0;b<a.metadata.length;b+=2){var h=a.metadata[b],d=a.metadata[b+1];"color_palette"===h?(d in colorPalettesAliases&&(d=colorPalettesAliases[d]),void 0===colorPalettes[d]?logError('Palette "'+d+'" not found, defaulting to arnecolors.',0):colorPalette=colorPalettes[d]):"debug"===h?cache_console_messages=debugMode=!0:"verbose_logging"===h?cache_console_messages=verbose_logging=
!0:"throttle_movement"===h&&(throttle_movement=!0)}for(f in a.objects)if(a.objects.hasOwnProperty(f))for(g=a.objects[f],10<g.colors.length&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",g.lineNumber+1),b=0;b<g.colors.length;b++)d=g.colors[b],isColor(d)?(d=colorToHex(colorPalette,d),g.colors[b]=d):(logError('Invalid color specified for object "'+f+'", namely "'+g.colors[b]+'".',g.lineNumber+1),g.colors[b]="#ff00ff");for(f in a.objects)a.objects.hasOwnProperty(f)&&
(g=a.objects[f],0==g.colors.length&&(logError('color not specified for object "'+f+'".',g.lineNumber),g.colors=["#ff00ff"]),g.spritematrix=0===g.spritematrix.length?[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]]:generateSpriteMatrix(g.spritematrix));var k={};for(f in a.objects)if(a.objects.hasOwnProperty(f)){var g=a.objects[f],q=c.concat([]);q[g.layer]=g.id;k[f]=q}for(g=!0;g;){g=!1;for(b=0;b<a.legend_synonyms.length;b++){var m=a.legend_synonyms[b],h=m[0],d=m[1];h in k&&void 0!==k[h]||
void 0===k[d]||(g=!0,k[h]=k[d])}for(b=0;b<a.legend_aggregates.length;b++){for(var m=a.legend_aggregates[b],h=m[0],q=m.slice(1),v=!0,d=0;d<q.length;d++)if(void 0===k[q[d]]){v=!1;break}if(!(h in k&&void 0!==k[h])&&v){q=c.concat([]);for(d=1;d<m.length;d++)f=m[d],g=a.objects[f],void 0==g&&logError("Object not found with name "+f,a.lineNumber),-1==q[g.layer]?q[g.layer]=g.id:void 0===g.layer?logError('Object "'+f.toUpperCase()+'" has been defined, but not assigned to a layer.',m.lineNumber):logError('Trying to create an aggregate object (defined in the legend) with both "'+
f.toUpperCase()+'" and "'+a.idDict[q[g.layer]].toUpperCase()+"\", which are on the same layer and therefore can't coexist.",m.lineNumber);g=!0;k[m[0]]=q}}}a.glyphDict=k;g={};for(b=0;b<a.legend_aggregates.length;b++)d=a.legend_aggregates[b],g[d[0]]=d.slice(1);a.aggregatesDict=g;c={};for(b=0;b<a.legend_properties.length;b++)d=a.legend_properties[b],c[d[0]]=d.slice(1);a.propertiesDict=c;k={};for(b=0;b<a.legend_synonyms.length;b++)d=a.legend_synonyms[b],h=d[0],q=d[1],q in g?g[h]=g[q]:q in c?c[h]=c[q]:
h!==q&&(k[h]=q);a.synonymsDict=k;for(d=!0;d;){d=!1;for(f in k)k.hasOwnProperty(f)&&(q=k[f],q in c?(delete k[f],c[f]=c[q],d=!0):q in g?(delete g[f],g[f]=g[q],d=!0):q in k&&(k[f]=k[q]));for(f in c)if(c.hasOwnProperty(f))for(m=c[f],b=0;b<m.length;b++){q=m[b];if(q in k)m[b]=k[q],d=!0;else if(q in c){m.splice(b,1);v=c[q];for(d=0;d<v.length;d++){var A=v[d];-1===m.indexOf(A)&&m.push(A)}d=!0}q in g&&logError('Trying to define property "'+f.toUpperCase()+'" in terms of aggregate "'+q.toUpperCase()+'".')}for(f in g)if(g.hasOwnProperty(f))for(m=
g[f],b=0;b<m.length;b++){q=m[b];if(q in k)m[b]=k[q],d=!0;else if(q in g){m.splice(b,1);v=g[q];for(d=0;d<v.length;d++)A=v[d],-1===m.indexOf(A)&&m.push(A);d=!0}q in c&&logError('Trying to define aggregate "'+f.toUpperCase()+'" in terms of property "'+q.toUpperCase()+'".')}}a.propertiesSingleLayer={};for(h in c)if(c.hasOwnProperty(h)){m=c[h];f=!0;for(b=1;b<m.length;b++)if(a.objects[m[b-1]].layer!==a.objects[m[b]].layer){f=!1;break}f&&(a.propertiesSingleLayer[h]=a.objects[m[0]].layer)}void 0===a.idDict[0]&&
0<a.collisionLayers.length&&logError("You need to have some objects defined");void 0===a.objects.background?"background"in a.synonymsDict?(f=a.synonymsDict.background,g=a.objects[f],h=g.id,f=g.layer):"background"in a.propertiesDict?(f=a.propertiesDict.background[0],g=a.objects[f],h=g.id,f=g.layer):"background"in a.aggregatesDict?(g=a.idDict[0],h=g.id,f=g.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")):
(g=a.idDict[0],h=g.id,f=g.layer,logError("you have to define something to be the background")):(h=a.objects.background.id,f=a.objects.background.layer);a.backgroundid=h;a.backgroundlayer=f}Level.prototype.calcBackgroundMask=function(a){void 0===a.backgroundlayer&&logError("you have to have a background layer");for(var b=a.layerMasks[a.backgroundlayer],c=0;c<this.n_tiles;c++){var d=this.getCell(c);d.iand(b);if(!d.iszero())return d}d=new BitVec(STRIDE_OBJ);d.ibitset(a.backgroundid);return d};
function levelFromString(a,b){var c=a.layerMasks[a.backgroundlayer],d=new Level(b[0],b[1].length,b.length-1,a.collisionLayers.length,null);d.objects=new Int32Array(d.width*d.height*STRIDE_OBJ);for(var f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=b[g+1].charAt(f);0==h.length&&(h=b[g+1].charAt(b[g+1].length-1));var k=a.glyphDict[h];void 0==k&&(void 0===a.propertiesDict[h]?logError('Error, symbol "'+h+'", used in map, not found.',b[0]+g):logError('Error, symbol "'+h+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",
b[0]+g));for(var h=new BitVec(STRIDE_OBJ),k=k.concat([]),q=0;q<d.layerCount;q++)0<=k[q]&&h.ibitset(k[q]);for(k=0;k<STRIDE_OBJ;++k)d.objects[STRIDE_OBJ*(f*d.height+g)+k]=h.data[k]}g=d.calcBackgroundMask(a);for(f=0;f<d.n_tiles;f++)k=d.getCell(f),c.anyBitsInCommon(k)||k.ior(g),d.setCell(f,k);return d}function levelsToArray(a){for(var b=a.levels,c=[],d=0;d<b.length;d++){var f=b[d];0!=f.length&&(f="\n"==f[0]?{message:f[1]}:levelFromString(a,f),c.push(f))}a.levels=c}
var directionaggregates={horizontal:["left","right"],vertical:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},relativeDirections="^ v < > horizontal vertical".split(" "),simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],reg_directions_only=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/,
commandwords="sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10 cancel checkpoint restart win message again".split(" ");
function directionalRule(a){for(var b=0;b<a.lhs.length;b++){var c=a.lhs[b];if(1<c.length)return!0;for(var d=0;d<c.length;d++)for(var f=c[d],g=0;g<f.length;g+=2)if(0<=relativeDirections.indexOf(f[g]))return!0}for(b=0;b<a.rhs.length;b++){c=a.rhs[b];if(1<c.length)return!0;for(d=0;d<c.length;d++)for(f=c[d],g=0;g<f.length;g+=2)if(0<=relativeDirections.indexOf(f[g]))return!0}return!1}
function processRuleString(a,b,c){var d=a[0],f=a[1],g=a[2],d=d.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> "),h=d.split(/\s/).filter(function(a){return""!==a});0==h.length&&logError("Spooky error!  Empty line passed to rule function.",f);var k=0,q=[],m=null,v=[],A=!1,B=[],d=[],F=!1,J=!1,C=f;a=[];var w=!1;if(1===h.length){if("startloop"===h[0])return b={bracket:1};if("endloop"===h[0])return b={bracket:-1}}-1==h.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",
f);for(var l=0;l<h.length;l++){var r=h[l];switch(k){case 0:"+"===r?C===f?(0==c.length&&logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.'),0!==l&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),C=c[c.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol)applied to the same rule.',f):r in directionaggregates?q=q.concat(directionaggregates[r]):
"late"===r?F=!0:"rigid"===r?J=!0:"random"===r?w=!0:0<=simpleAbsoluteDirections.indexOf(r)?q.push(r):0<=simpleRelativeDirections.indexOf(r)?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',f):"["==r?(0==q.length&&(q=q.concat(directionaggregates.orthogonal)),k=1,
l--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+r.toUpperCase()+'".',f);break;case 1:if("["==r)0<v.length&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',f),m=[];else if(reg_directions_only.exec(r))1==m.length%2?logError("Error, an item can't move in multiple directions.",
f):m.push(r);else if("|"==r)1==m.length%2?logError("In a rule, if you specify a force, it has to act on an object.",f):(v.push(m),m=[]);else if("]"===r)1==m.length%2?"..."===m[0]?logError("Cannot end a rule with ellipses.",f):logError("In a rule, if you specify a force, it has to act on an object.",f):(v.push(m),m=[]),A?d.push(v):B.push(v),v=[];else if("->"===r)A&&logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',f),0<v.length?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',
f):A=!0;else if(0<=b.names.indexOf(r))0==m.length%2?(m.push(""),m.push(r)):1==m.length%2&&m.push(r);else if("..."===r)m.push(r),m.push(r);else if(0<=commandwords.indexOf(r))if(!1===A&&logError("Commands cannot appear on the left-hand side of the arrow.",f),"message"===r){var H=g.match(/message (.*)/i);null===H?logError("invalid message string",f):(a.push([r,H[1].trim()]),l=h.length)}else a.push([r]);else logError('Error, malformed cell rule - was looking for cell contents, but found "'+r+'".  What am I supposed to do with this, eh, please tell me that.',
f)}}if(B.length!=d.length)0<a.length&&0==d.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",f);else for(l=0;l<B.length;l++)B[l].length!=d[l].length&&logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",f),0==B[l].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certianly don't want this.");
0==B.length&&logError("This rule refers to nothing.  What the heck? :O",f);b={directions:q,lhs:B,rhs:d,lineNumber:f,late:F,rigid:J,groupNumber:C,commands:a,randomRule:w};!1===directionalRule(b)&&(b.directions=["up"]);for(l=0;l<a.length;l++)c=a[l][0],"restart"===c?(1<a.length||0<d.length)&&logError("The RESTART command can only appear by itself on the right hand side of the arrow.",f):"cancel"===c&&(1<a.length||0<d.length)&&logError("The CANCEL command can only appear by itself on the right hand side of the arrow.",
f);return b}function deepCloneHS(a){return a.map(function(a){return a.map(function(a){return a.slice()})})}function deepCloneRule(a){return{direction:a.direction,lhs:deepCloneHS(a.lhs),rhs:deepCloneHS(a.rhs),lineNumber:a.lineNumber,late:a.late,rigid:a.rigid,groupNumber:a.groupNumber,commands:a.commands,randomRule:a.randomRule}}
function rulesToArray(a){for(var b=a.rules,c=[],d=[],f=0;f<b.length;f++){var g=b[f][1],h=processRuleString(b[f],a,c);void 0!==h.bracket?d.push([g,h.bracket]):c.push(h)}a.loops=d;d=[];for(f=0;f<c.length;f++)for(b=c[f],g=b.directions,h=0;h<g.length;h++){var k=g[h];if(k in directionaggregates&&directionalRule(b))for(var k=directionaggregates[k],q=0;q<k.length;q++){var m=deepCloneRule(b);m.direction=k[q];d.push(m)}else m=deepCloneRule(b),m.direction=k,d.push(m)}for(f=0;f<d.length;f++)b=d[f],convertRelativeDirsToAbsolute(b),
rewriteUpLeftRules(b),atomizeAggregates(a,b),rephraseSynonyms(a,b);c=[];for(f=0;f<d.length;f++)b=d[f],c=c.concat(concretizeMovingRule(a,b,b.lineNumber));d=[];for(f=0;f<c.length;f++)b=c[f],d=d.concat(concretizePropertyRule(a,b,b.lineNumber));a.rules=d}function containsEllipsis(a){for(var b=0;b<a.lhs.length;b++)for(var c=0;c<a.lhs[b].length;c++)if("..."===a.lhs[b][c][1])return!0;return!1}
function rewriteUpLeftRules(a){if(!containsEllipsis(a)){if("up"==a.direction)a.direction="down";else if("left"==a.direction)a.direction="right";else return;for(var b=0;b<a.lhs.length;b++)a.lhs[b].reverse(),0<a.rhs.length&&a.rhs[b].reverse()}}function getPropertiesFromCell(a,b){for(var c=[],d=0;d<b.length;d+=2){var f=b[d+1];"random"!=b[d]&&f in a.propertiesDict&&c.push(f)}return c}
function getMovings(a,b){for(var c=[],d=0;d<b.length;d+=2){var f=b[d],g=b[d+1];f in directionaggregates&&c.push([g,f])}return c}function concretizePropertyInCell(a,b,c){for(var d=0;d<a.length;d+=2)a[d+1]===b&&"random"!==a[d]&&(a[d+1]=c)}function concretizeMovingInCell(a,b,c,d){for(var f=0;f<a.length;f+=2)a[f]===b&&a[f+1]===c&&(a[f]=d)}function concretizeMovingInCellByAmbiguousMovementName(a,b,c){for(var d=0;d<a.length;d+=2)a[d]===b&&(a[d]=c)}
function expandNoPrefixedProperties(a,b){for(var c=[],d=0;d<b.length;d+=2){var f=b[d],g=b[d+1];if("no"===f&&g in a.propertiesDict)for(var g=a.propertiesDict[g],h=0;h<g.length;h++){var k=g[h];c.push(f);c.push(k)}else c.push(f),c.push(g)}return c}
function concretizePropertyRule(a,b,c){for(var d=0;d<b.lhs.length;d++)for(var f=b.lhs[d],g=0;g<f.length;g++)f[g]=expandNoPrefixedProperties(a,f[g]),0<b.rhs.length&&(b.rhs[d][g]=expandNoPrefixedProperties(a,b.rhs[d][g]));f={};for(g=0;g<b.rhs.length;g++)for(var d=b.lhs[g],h=b.rhs[g],k=0;k<h.length;k++)for(var q=getPropertiesFromCell(a,d[k]),m=getPropertiesFromCell(a,h[k]),v=0;v<m.length;v++){var A=m[v];-1==q.indexOf(A)&&(f[A]=!0)}b=[b];for(var B=!0;B;)for(B=!1,d=0;d<b.length;d++){h=b[d];m=!1;for(g=
0;g<h.lhs.length&&!m;g++)for(q=h.lhs[g],k=0;k<q.length&&!m;k++)for(var v=q[k],F=getPropertiesFromCell(a,v),v=0;v<F.length;++v)if(A=F[v],!a.propertiesSingleLayer.hasOwnProperty(A)||!0===f[A]){for(var F=a.propertiesDict[A],B=m=!0,J=0;J<F.length;J++){var v=F[J],C=deepCloneRule(h);C.propertyReplacement={};for(var w in h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(w)){var l=h.propertyReplacement[w];C.propertyReplacement[w]=[l[0],l[1]]}concretizePropertyInCell(C.lhs[g][k],A,v);0<C.rhs.length&&
concretizePropertyInCell(C.rhs[g][k],A,v);void 0===C.propertyReplacement[A]?C.propertyReplacement[A]=[v,1]:C.propertyReplacement[A][1]+=1;b.push(C)}break}m&&(b.splice(d,1),d--)}for(d=0;d<b.length;d++)if(h=b[d],void 0!==h.propertyReplacement)for(A in h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(A)&&(g=h.propertyReplacement[A],v=g[0],1===g[1]))for(g=0;g<h.rhs.length;g++)for(w=h.rhs[g],k=0;k<w.length;k++)concretizePropertyInCell(w[k],A,v);A="";for(d=0;d<b.length;d++)for(h=b[d],delete b.propertyReplacement,
g=0;g<h.rhs.length;g++)for(q=h.rhs[g],k=0;k<q.length;k++)for(v=q[k],F=getPropertiesFromCell(a,v),v=0;v<F.length;v++)f.hasOwnProperty(F[v])&&(A=F[v]);0<A.length&&logError('This rule has a property on the right-hand side, "'+A+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",
c);return b}
function concretizeMovingRule(a,b,c){var d;b=[b];for(var f=!0;f;)for(var f=!1,g=0;g<b.length;g++){var h=b[g];d=!1;for(var k=0;k<h.lhs.length;k++)for(var q=h.lhs[k],m=0;m<q.length;m++){var v=q[m],v=getMovings(a,v);if(0<v.length)for(var f=d=!0,A=v[0][0],v=v[0][1],B=directionaggregates[v],F=0;F<B.length;F++){var J=B[F],C=deepCloneRule(h);C.movingReplacement={};for(var w in h.movingReplacement)if(h.movingReplacement.hasOwnProperty(w)){var l=h.movingReplacement[w];C.movingReplacement[w]=[l[0],l[1],l[3]]}concretizeMovingInCell(C.lhs[k][m],
v,A,J);0<C.rhs.length&&concretizeMovingInCell(C.rhs[k][m],v,A,J);void 0===C.movingReplacement[A]?C.movingReplacement[A]=[J,1,v]:C.movingReplacement[A][1]+=1;b.push(C)}}d&&(b.splice(g,1),g--)}for(g=0;g<b.length;g++)if(h=b[g],void 0!==h.movingReplacement){q={};for(A in h.movingReplacement)if(h.movingReplacement.hasOwnProperty(A)){var r=h.movingReplacement[A];w=r[0];k=r[1];r=r[2];q[r]=r in q||1!==k?"INVALID":w;if(1===k)for(k=0;k<h.rhs.length;k++)for(d=h.rhs[k],m=0;m<d.length;m++)f=d[m],concretizeMovingInCell(f,
r,A,w)}for(r in q)if(q.hasOwnProperty(r)&&"INVALID"!==r)for(w=q[r],k=0;k<h.rhs.length;k++)for(d=h.rhs[k],m=0;m<d.length;m++)f=d[m],concretizeMovingInCellByAmbiguousMovementName(f,r,w)}A="";for(g=0;g<b.length;g++)for(h=b[g],delete b.movingReplacement,k=0;k<h.rhs.length;k++)for(q=h.rhs[k],m=0;m<q.length;m++)v=q[m],v=getMovings(a,v),0<v.length&&(A=v[0][1]);0<A.length&&logError('This rule has an ambiguous movement on the right-hand side, "'+A+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",
c);return b}function rephraseSynonyms(a,b){for(var c=0;c<b.lhs.length;c++)for(var d=b.lhs[c],f=b.rhs[c],g=0;g<d.length;g++){for(var h=d[g],k=1;k<h.length;k+=2){var q=h[k];q in a.synonymsDict&&(h[k]=a.synonymsDict[h[k]])}if(0<b.rhs.length)for(h=f[g],k=1;k<h.length;k+=2)q=h[k],q in a.synonymsDict&&(h[k]=a.synonymsDict[h[k]])}}
function atomizeAggregates(a,b){for(var c=0;c<b.lhs.length;c++)for(var d=b.lhs[c],f=0;f<d.length;f++){var g=d[f];atomizeCellAggregates(a,g,b.lineNumber)}for(c=0;c<b.rhs.length;c++)for(d=b.rhs[c],f=0;f<d.length;f++)g=d[f],atomizeCellAggregates(a,g,b.lineNumber)}
function atomizeCellAggregates(a,b,c){for(var d=0;d<b.length;d+=2){var f=b[d],g=b[d+1];if(g in a.aggregatesDict)for("no"===f&&logError("You cannot use 'no' to exclude the aggregate object "+g.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",c),f=a.aggregatesDict[g],b[d+1]=f[0],g=1;g<f.length;g++)b.push(b[d]),b.push(f[g])}}
function convertRelativeDirsToAbsolute(a){for(var b=a.direction,c=0;c<a.lhs.length;c++)for(var d=a.lhs[c],f=0;f<d.length;f++){var g=d[f];absolutifyRuleCell(b,g)}for(c=0;c<a.rhs.length;c++)for(d=a.rhs[c],f=0;f<d.length;f++)g=d[f],absolutifyRuleCell(b,g)}var relativeDirs="^ v < > parallel perpendicular".split(" "),relativeDict={right:"up down left right horizontal vertical".split(" "),up:"left right down up vertical horizontal".split(" "),down:"right left up down vertical horizontal".split(" "),left:"down up right left horizontal vertical".split(" ")};
function absolutifyRuleCell(a,b){for(var c=0;c<b.length;c+=2){var d=relativeDirs.indexOf(b[c]);0<=d&&(b[c]=relativeDict[a][d])}}var dirMasks={up:1,down:2,left:4,right:8,moving:15,no:3,randomdir:5,random:18,action:16,"":0};
function rulesToMask(a){for(var b=a.collisionLayers.length,c=[],d=0;d<b;d++)c.push(null);for(d=0;d<a.rules.length;d++)for(var f=a.rules[d],g=0;g<f.lhs.length;g++)for(var h=f.lhs[g],k=f.rhs[g],q=0;q<h.length;q++){for(var m=h[q],v=c.concat([]),A=new BitVec(STRIDE_OBJ),B=new BitVec(STRIDE_OBJ),F=[],J=new BitVec(STRIDE_MOV),C=new BitVec(STRIDE_MOV),w=new BitVec(STRIDE_MOV),l=0;l<m.length;l+=2){var r=m[l];if("..."===r){A=ellipsisPattern;2!==m.length?logError("You can't have anything in with an ellipsis. Sorry.",
f.lineNumber):0===q||q===h.length-1?logError("There's no point in putting an ellipsis at the very start or the end of a rule",f.lineNumber):0<f.rhs.length&&(r=k[q],2===r.length&&"..."===r[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",f.lineNumber));break}else if("random"===r){logError("'random' cannot be matched on the left-hand side, it can only appear on the right",f.lineNumber);continue}var H=m[l+1],s=a.objects[H],K=a.objectMasks[H],W=s?
s.layer|0:a.propertiesSingleLayer[H];if("no"===r)B.ior(K);else{var X=v[W];null!==X&&logError("Rule matches object types that can't overlap: \""+H.toUpperCase()+'" and "'+X.toUpperCase()+'".',f.lineNumber);v[W]=H;s?(A.ior(K),w.ishiftor(31,5*W)):F.push(K);"stationary"===r?C.ishiftor(31,5*W):J.ishiftor(dirMasks[r],5*W)}}if(0<f.rhs.length)for(r=k[q],l=h[q],"..."===r[0]&&"..."!==l[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",f.lineNumber),l=0;l<
r.length;l+=2)"..."===r[l]&&2!==r.length&&logError("You can't have anything in with an ellipsis. Sorry.",f.lineNumber);if(A===ellipsisPattern)h[q]=ellipsisPattern;else if(h[q]=new CellPattern([A,B,F,J,C,null]),0!==f.rhs.length){for(var B=k[q],F=c.concat([]),C=new BitVec(STRIDE_OBJ),m=new BitVec(STRIDE_OBJ),P=new BitVec(STRIDE_MOV),Y=new BitVec(STRIDE_MOV),R=new BitVec(STRIDE_MOV),ea=new BitVec(STRIDE_OBJ),ja=new BitVec(STRIDE_MOV),sa=new BitVec(STRIDE_MOV),l=0;l<B.length;l+=2){r=B[l];H=B[l+1];if("..."===
r){logError("spooky ellipsis found! (should never hit this)");break}else if("random"===r){H in a.objectMasks?ea.ior(a.objectMasks[H]):logError('You want to spawn a random "'+H.toUpperCase()+"\", but I don't know how to do that",f.lineNumber);continue}s=a.objects[H];K=a.objectMasks[H];W=s?s.layer|0:a.propertiesSingleLayer[H];"no"==r?C.ior(K):(X=F[W],null!==X&&logError("Rule matches object types that can't overlap: \""+H.toUpperCase()+'" and "'+X.toUpperCase()+'".',f.lineNumber),F[W]=H,0<r.length&&
ja.ishiftor(31,5*W),H=a.layerMasks[W],s&&(m.ibitset(s.id),C.ior(H),R.ishiftor(31,5*W)),"stationary"===r&&P.ishiftor(31,5*W),"randomdir"===r?sa.ishiftor(dirMasks[r],5*W):Y.ishiftor(dirMasks[r],5*W))}A.bitsSetInArray(m.data)||C.ior(A);J.bitsSetInArray(Y.data)||P.ior(J);for(l=0;l<b;l++)null!==v[l]&&null===F[l]&&(C.ior(a.layerMasks[l]),ja.ishiftor(31,5*l));w.iclear(R);ja.ior(w);if(C||m||P||Y||ja)h[q].replacement=new CellReplacement([C,m,P,Y,ja,ea,sa])}}}
function cellRowMasks(a){var b=[];a=a[1];for(var c=0;c<a.length;c++){for(var d=a[c],f=new BitVec(STRIDE_OBJ),g=0;g<d.length;g++)d[g]!==ellipsisPattern&&f.ior(d[g].objectsPresent);b.push(f)}return b}
function collapseRules(a){for(var b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.length;d++){for(var f=c[d],g=[0,[],0<f.rhs.length,f.lineNumber],h=[],k=0;k<f.lhs.length;k++)h.push(!1);g[0]=dirMasks[f.direction];for(k=0;k<f.lhs.length;k++){for(var q=f.lhs[k],m=0;m<q.length;m++)q[m]===ellipsisPattern&&(h[k]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",f.lineNumber),h[k]=!0);g[1][k]=q}g.push(h);g.push(f.groupNumber);
g.push(f.rigid);g.push(f.commands);g.push(f.randomRule);g.push(cellRowMasks(g));c[d]=new Rule(g)}matchCache={}}function ruleGroupRandomnessTest(a){if(0!==a.length)for(var b=a[0].lineNumber,c=1;c<a.length;c++){var d=a[c];d.lineNumber!==b&&d.randomRule&&logError("A rule-group can only be marked random by the first rule",d.lineNumber)}}
function arrangeRulesByGroupNumber(a){for(var b={},c={},d=0;d<a.rules.length;d++){var f=a.rules[d],g=b;f.late&&(g=c);void 0==g[f.groupNumber]&&(g[f.groupNumber]=[]);g[f.groupNumber].push(f)}var d=[],h;for(h in b)b.hasOwnProperty(h)&&(f=b[h],ruleGroupRandomnessTest(f),d.push(f));b=[];for(h in c)c.hasOwnProperty(h)&&(f=c[h],ruleGroupRandomnessTest(f),b.push(f));a.rules=d;a.lateRules=b}
function checkNoLateRulesHaveMoves(a){for(var b=0;b<a.lateRules.length;b++)for(var c=a.lateRules[b],d=0;d<c.length;d++)for(var f=c[d],g=0;g<f.patterns.length;g++)for(var h=f.patterns[g],k=0;k<h.length;k++){var q=h[k];if(q!==ellipsisPattern){var m=q.movementsPresent;if(!q.movementsMissing.iszero()||!m.iszero()){logError("Movements cannot appear in late rules.",f.lineNumber);return}if(null!=q.replacement&&(m=q.replacement.movementsSet,!q.replacement.movementsClear.iszero()||!m.iszero())){logError("Movements cannot appear in late rules.",
f.lineNumber);return}}}}function generateRigidGroupList(a){for(var b=[],c=[],d=[],f=[],g=0;g<a.rules.length;g++){for(var h=a.rules[g],k=!1,q=0;q<h.length;q++)h[q].isRigid&&(k=!0);if(f[g]=k)h=h[0].groupNumber,k=b.length,c[g]=k,d[h]=k,b.push(g)}30<b.length&&logError("There can't be more than 30 rigid groups (rule groups containing rigid members).",rules[0][0][3]);a.rigidGroups=f;a.rigidGroupIndex_to_GroupIndex=b;a.groupNumber_to_RigidGroupIndex=d;a.groupIndex_to_RigidGroupIndex=c}
function getMaskFromName(a,b){var c=new BitVec(STRIDE_OBJ);if(b in a.objects){var d=a.objects[b];c.ibitset(d.id)}if(b in a.aggregatesDict)for(var f=a.aggregatesDict[b],g=0;g<f.length;g++)d=f[g],d=a.objects[d],c.ibitset(d.id);if(b in a.propertiesDict)for(f=a.propertiesDict[b],g=0;g<f.length;g++)d=f[g],d=a.objects[d],c.ibitset(d.id);b in a.synonymsDict&&(d=a.synonymsDict[b],d=a.objects[d],c.ibitset(d.id));c.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!");
return c}
function generateMasks(a){a.playerMask=getMaskFromName(a,"player");for(var b=[],c=a.collisionLayers.length,d=0;d<c;d++){for(var f=new BitVec(STRIDE_OBJ),g=0;g<a.objectCount;g++){var h=a.idDict[g],k=a.objects[h];k.layer==d&&f.ibitset(k.id)}b.push(f)}a.layerMasks=b;b={};for(h in a.objects)a.objects.hasOwnProperty(h)&&(k=a.objects[h],b[h]=new BitVec(STRIDE_OBJ),b[h].ibitset(k.id));k=a.legend_synonyms.concat(a.legend_properties);k.sort(function(a,b){return a.lineNumber-b.lineNumber});for(c=0;c<k.length;c++)if(d=
k[c],2==d.length)b[d[0]]=b[d[1]];else{f=new BitVec(STRIDE_OBJ);for(g=1;g<d.length;g++)h=d[g],f.ior(b[h]);b[d[0]]=f}a.objectMasks=b}function checkObjectsAreLayered(a){for(var b in a.objects)if(a.objects.hasOwnProperty(b)){for(var c=!1,d=0;d<a.collisionLayers.length;d++){for(var f=a.collisionLayers[d],g=0;g<f.length;g++)if(f[g]===b){c=!0;break}if(c)break}!1===c&&(c=a.objects[b],logError('Object "'+b.toUpperCase()+'" has been defined, but not assigned to a layer.',c.lineNumber))}}
function twiddleMetaData(a){for(var b={},c=0;c<a.metadata.length;c+=2){var d=a.metadata[c+1];b[a.metadata[c]]=d}void 0!==b.flickscreen&&(d=b.flickscreen,c=d.split("x"),c=[parseInt(c[0]),parseInt(c[1])],b.flickscreen=c);void 0!==b.zoomscreen&&(d=b.zoomscreen,c=d.split("x"),c=[parseInt(c[0]),parseInt(c[1])],b.zoomscreen=c);a.metadata=b}
function processWinConditions(a){for(var b=[],c=0;c<a.winconditions.length;c++){var d=a.winconditions[c];if(0==d.length)return;var f=0;switch(d[0]){case "no":f=-1;break;case "all":f=1}var g=d[d.length-1],h=d[1],d=5==d.length?d[3]:"background",k=0,q=0;h in a.objectMasks?k=a.objectMasks[h]:logError('unwelcome term "'+h+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',g);d in a.objectMasks?q=a.objectMasks[d]:logError('unwelcome term "'+
d+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',g);b.push([f,k,q,g])}a.winconditions=b}function printCellRow(a){for(var b="[ ",c=0;c<a.length;c++){0<c&&(b+="| ");for(var d=a[c],f=0;f<d.length;f+=2)var g=d[f],h=d[f+1],b="..."===g?b+(g+" "):b+(g+" "+h+" ")}return b+"] "}
function printRule(a){var b="(<a onclick=\"jumpToLine('"+a.lineNumber.toString()+'\');"  href="javascript:void(0);">'+a.groupNumber+"</a>) "+a.direction.toString().toUpperCase()+" ";a.rigid&&(b="RIGID "+b+" ");a.randomRule&&(b="RANDOM "+b+" ");a.late&&(b="LATE "+b+" ");for(var c=0;c<a.lhs.length;c++)var d=a.lhs[c],b=b+printCellRow(d);b+="-> ";for(c=0;c<a.rhs.length;c++)d=a.rhs[c],b+=printCellRow(d);for(c=0;c<a.commands.length;c++)d=a.commands[c],b=1===d.length?b+d[0].toString():b+"("+d[0].toString()+
", "+d[1].toString()+") ";return b}function printRules(a){for(var b="<br>Rule Assembly : ("+a.rules.length+" rules )<br>===========<br>",c=0,d=-1,f=0;f<a.rules.length;f++){var g=a.rules[f];c<a.loops.length&&a.loops[c][0]<g.lineNumber&&(b+="STARTLOOP<br>",c++,c<a.loops.length&&(d=a.loops[c][0],c++));-1!==d&&d<g.lineNumber&&(b+="ENDLOOP<br>",d=-1);b+=printRule(g)+"<br>"}-1!==d&&(b+="ENDLOOP<br>");consolePrint(b+"===========<br>")}
function removeDuplicateRules(a){console.log("rule count before = "+a.rules.length);for(var b={},c=-1,d=a.rules.length-1;0<=d;d--){var f=a.rules[d],g=f.groupNumber;g!==c&&(b={});c=printRule(f);b.hasOwnProperty(c)?a.rules.splice(d,1):b[c]=!0;c=g}console.log("rule count after = "+a.rules.length)}
function generateLoopPoints(a){var b={},c=!0,d=0,f=0;1===a.loops.length%2&&logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points.");for(var g=0;g<a.loops.length;g++)for(var h=a.loops[g],d=0;d<a.rules.length;d++){var k=a.rules[d],k=k[0],k=k.lineNumber;if(c){if(k>=h[0]){f=d;c=!1;-1===h[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(k>=h[0]){d-=1;b[d]=f;c=!0;1===h[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");
break}}!1===c&&(d=a.rules.length,b[d]=f);a.loopPoint=b;b={};c=!0;for(g=0;g<a.loops.length;g++)for(h=a.loops[g],d=0;d<a.lateRules.length;d++)if(k=a.lateRules[d],k=k[0],k=k.lineNumber,c){if(k>=h[0]){f=d;c=!1;-1===h[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(k>=h[0]){d-=1;b[d]=f;c=!0;1===h[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}!1===c&&(d=a.lateRules.length,b[d]=f);
a.lateLoopPoint=b}var soundEvents="titlescreen startgame endgame startlevel undo restart endlevel showmessage closemessage sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10".split(" "),soundMaskedEvents=["create","destroy","move","cantmove","action"],soundVerbs=soundEvents.concat(soundMaskedEvents);function validSeed(a){return null!==/^\s*\d+\s*$/.exec(a)}
var soundDirectionIndicatorMasks={up:1,down:2,left:4,right:8,horizontal:12,vertical:3,orthogonal:15,___action____:16},soundDirectionIndicators="up down left right horizontal vertical orthogonal ___action____".split(" ");
function generateSoundData(a){for(var b={},c=[],d=[],f=[],g=[],h=0;h<a.sounds.length;h++){var k=a.sounds[h];if(!(1>=k.length)){var q=k[k.length-1];if(2===k.length)logError("incorrect sound declaration.",q);else if(0<=soundEvents.indexOf(k[0])){4<k.length&&logError("too much stuff to define a sound event",q);var m=k[1];validSeed(m)?(void 0!==b[k[0]]&&logError(k[0].toUpperCase()+" already declared.",q),b[k[0]]=k[1]):logError('Expecting sfx data, instead found "'+k[1]+'".',q)}else{var v=k[0].trim(),
A=k[1].trim(),B=k.slice(2,k.length-2);0<B.length&&"move"!==A&&"cantmove"!==A&&logError("incorrect sound declaration.",q);"action"===A&&(A="move",B=["___action____"]);0==B.length&&(B=["orthogonal"]);m=k[k.length-2];v in a.aggregatesDict?logError('cannot assign sound fevents to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+v+'").',q):v in a.objectMasks||logError('Object "'+v+'" not found.',q);for(var k=a.objectMasks[v],F=0,J=0;J<
B.length;J++){B[J]=B[J].trim();var C=B[J];-1===soundDirectionIndicators.indexOf(C)?logError('Was expecting a direction, instead found "'+C+'".',q):F|=soundDirectionIndicatorMasks[C]}v=[v];for(J=!0;J;)for(J=!1,B=0;B<v.length;B++)if(C=v[B],C in a.synonymsDict)v[B]=a.synonymsDict[C],J=!0;else if(C in a.propertiesDict){J=!0;C=a.propertiesDict[C];v.splice(B,1);B--;for(var w=0;w<C.length;w++)v.push(C[w])}if("move"===A||"cantmove"===A)for(J=0;J<v.length;J++)B=a.objects[v[J]].layer,C=new BitVec(STRIDE_MOV),
C.ishiftor(F,5*B),B={objectMask:k,directionMask:C,seed:m},"move"===A?f.push(B):g.push(B);validSeed(m)||logError('Expecting sfx data, instead found "'+m+'".',q);switch(A){case "create":B={objectMask:k,seed:m};c.push(B);break;case "destroy":B={objectMask:k,seed:m},d.push(B)}}}}a.sfx_Events=b;a.sfx_CreationMasks=c;a.sfx_DestructionMasks=d;a.sfx_MovementMasks=f;a.sfx_MovementFailureMasks=g}
function formatHomePage(a){a.bgcolor="background_color"in a.metadata?colorToHex(colorPalette,a.metadata.background_color):"#000000";a.fgcolor="text_color"in a.metadata?colorToHex(colorPalette,a.metadata.text_color):"#FFFFFF";!1===isColor(a.fgcolor)&&logError("text_color in incorrect format - found "+a.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').");!1===isColor(a.bgcolor)&&logError("background_color in incorrect format - found "+a.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').");
if(canSetHTMLColors&&("background_color"in a.metadata&&(document.body.style.backgroundColor=a.bgcolor),"text_color"in a.metadata)){var b=document.getElementById("separator");null!=b&&(b.style.color=a.fgcolor);for(var b=document.getElementsByTagName("a"),c=0;c<b.length;c++)b[c].style.color=a.fgcolor;b=document.getElementsByTagName("h1");for(c=0;c<b.length;c++)b[c].style.color=a.fgcolor}"homepage"in a.metadata&&(b=a.metadata.homepage,b=b.replace("http://",""),b=b.replace("https://",""),a.metadata.homepage=
b)}var MAX_ERRORS=5;
function loadFile(a){window.console.log("loadFile");var b=new codeMirrorFn,c=b.startState();a=a.split("\n");for(var d=0;d<a.length;d++){var f=a[d];c.lineNumber=d+1;f=new CodeMirror.StringStream(f,4);do if(b.token(f,c),errorCount>MAX_ERRORS){consolePrint("too many errors, aborting compilation");return}while(!1===f.eol())}delete c.lineNumber;generateExtraMembers(c);generateMasks(c);levelsToArray(c);rulesToArray(c);removeDuplicateRules(c);debugMode&&printRules(c);rulesToMask(c);arrangeRulesByGroupNumber(c);collapseRules(c.rules);
collapseRules(c.lateRules);checkNoLateRulesHaveMoves(c);generateRigidGroupList(c);processWinConditions(c);checkObjectsAreLayered(c);twiddleMetaData(c);generateLoopPoints(c);generateSoundData(c);formatHomePage(c);delete c.commentLevel;delete c.names;delete c.abbrevNames;delete c.objects_candname;delete c.objects_section;delete c.objects_spritematrix;delete c.section;delete c.subsection;delete c.tokenIndex;delete c.visitedSections;delete c.loops;return c}var ifrm;
function compile(a,b,c){matchCache={};forceRegenImages=!0;void 0===a&&(a=["restart"]);void 0===c&&(c=null);lastDownTarget=canvas;void 0===b&&(b=window.form1.code.editorreference.getValue()+"\n");!0===canDump&&(compiledText=b);errorCount=0;compiling=!0;errorStrings=[];consolePrint("=================================");try{var d=loadFile(b)}finally{compiling=!1}if(!(errorCount>MAX_ERRORS)){if(0<errorCount)consoleError('<span class="systemMessage">Errors detected during compilation, the game may not work correctly.</span>');
else{for(var f=b=0;f<d.rules.length;f++)b+=d.rules[f].length;for(f=0;f<d.lateRules.length;f++)b+=d.lateRules[f].length;"restart"==a[0]?consolePrint('<span class="systemMessage">Successful Compilation, generated '+b+" instructions.</span>"):consolePrint('<span class="systemMessage">Successful live recompilation, generated '+b+" instructions.</span>")}setGameState(d,a,c);clearInputHistory();consoleCacheDump()}}function qualifyURL(a){var b=document.createElement("a");b.href=a;return b.href};var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1;
function selectText(a,b){b=b||window.event;var c=document.getElementById(a);if(b&&(b.ctrlKey||b.metaKey))c=["console"].concat(c.innerHTML.split("<br>")),c=levelFromString(state,c),loadLevelFromLevelDat(state,c,null),canvasResize();else if(document.selection){var d=document.body.createTextRange();d.moveToElementText(c);d.select()}else window.getSelection&&(d=document.createRange(),d.selectNode(c),window.getSelection().addRange(d))}function recalcLevelBounds(){}
function arrCopy(a,b,c,d,f){for(;f--;)c[d++]=a[b]++}function adjustLevel(a,b,c){backups.push(backupLevel());var d=a.clone();a.width+=b;a.height+=c;a.n_tiles=a.width*a.height;a.objects=new Int32Array(a.n_tiles*STRIDE_OBJ);b=new BitVec(STRIDE_OBJ);b.ibitset(state.backgroundid);for(c=0;c<a.n_tiles;++c)a.setCell(c,b);a.movements=new Int32Array(a.objects.length);columnAdded=!0;RebuildLevelArrays();return d}
function addLeftColumn(){for(var a=adjustLevel(level,1,0),b=1;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-level.height))}}function addRightColumn(){for(var a=adjustLevel(level,1,0),b=0;b<level.width-1;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}}
function addTopRow(){for(var a=adjustLevel(level,0,1),b=0;b<level.width;++b)for(var c=1;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b-1))}}function addBottomRow(){for(var a=adjustLevel(level,0,1),b=0;b<level.width;++b)for(var c=0;c<level.height-1;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b))}}
function removeLeftColumn(){if(!(1>=level.width))for(var a=adjustLevel(level,-1,0),b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+level.height))}}function removeRightColumn(){if(!(1>=level.width))for(var a=adjustLevel(level,-1,0),b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}}
function removeTopRow(){if(!(1>=level.height))for(var a=adjustLevel(level,0,-1),b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b+1))}}function removeBottomRow(){if(!(1>=level.height))for(var a=adjustLevel(level,0,-1),b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b))}}
function matchGlyph(a,b){for(var c=-1,d,f=0;f<b.length;++f){var g=b[f][0],h=b[f][1];if(h.bitsSetInArray(a.data)){for(var k=0,q=0;q<32*STRIDE_OBJ;++q)h.get(q)&&a.get(q)&&k++;k>c&&(c=k,d=g)}}if(0<c)return d;logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0);return"."}var htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0;
function printLevel(){var a=[],b;for(b in state.glyphDict)if(state.glyphDict.hasOwnProperty(b)&&1===b.length){for(var c=state.glyphDict[b],d=new BitVec(STRIDE_OBJ),f=0;f<c.length;f++){var g=c[f];0<=g&&d.ibitset(g)}a.push([b,d.clone()]);c=state.layerMasks[state.backgroundlayer];d.iclear(c);a.push([b,d.clone()]);for(f=0;32>f;f++)c.get(f)&&(d.ibitset(f),a.push([b,d.clone()]),d.ibitclear(f))}selectableint++;f="selectable"+selectableint;b='Printing level contents:<br><br><span id="'+f+'" onclick="selectText(\''+
f+"',event)\">";cache_console_messages=!1;for(d=0;d<level.height;d++){for(f=0;f<level.width;f++)c=level.getCell(d+f*level.height),c=matchGlyph(c,a),c in htmlEntityMap&&(c=htmlEntityMap[c]),b+=c;d<level.height-1&&(b+="<br>")}consolePrint(b+"</span><br>",!0)}
function levelEditorClick(a,b){if(-2>=mouseCoordY){var c=mouseCoordX+(screenwidth-1)*(editorRowCount-(-mouseCoordY-2)-1);-1===mouseCoordX?printLevel():0<=mouseCoordX&&c<glyphImages.length&&(glyphSelectedIndex=c,redraw())}else if(-1<mouseCoordX&&-1<mouseCoordY&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var d=state.glyphDict[glyphImagesCorrespondance[glyphSelectedIndex]],c=new BitVec(STRIDE_OBJ),f=0;f<d.length;f++){var g=d[f];0<=g&&c.ibitset(g)}c.bitsClearInArray(state.layerMasks[state.backgroundlayer])&&
c.ibitset(state.backgroundid);d=mouseCoordY+mouseCoordX*level.height;level.getCell(d).equals(c)||(!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(d,c),redraw())}else b&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}
function levelEditorRightClick(a,b){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(-1<mouseCoordX&&-1<mouseCoordY&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var c=mouseCoordY+mouseCoordX*level.height,d=new BitVec(STRIDE_OBJ);d.ibitset(state.backgroundid);level.setCell(c,d);redraw()}else b&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?
(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}var anyEditsSinceMouseDown=!1;
function onMouseDown(a){if(0===a.button&&!a.ctrlKey&&!a.metaKey){lastDownTarget=a.target;keybuffer=[];if(a.target===canvas&&(setMouseCoord(a),dragging=!0,rightdragging=!1,levelEditorOpened))return anyEditsSinceMouseDown=!1,levelEditorClick(a,!0);rightdragging=dragging=!1}else if((2===a.button||0===a.button&&(a.ctrlKey||a.metaKey))&&"gameCanvas"===a.target.id&&(dragging=!1,rightdragging=!0,levelEditorOpened))return levelEditorRightClick(a,!0)}function rightClickCanvas(a){return prevent(a)}
function onMouseUp(a){rightdragging=dragging=!1}function onKeyDown(a){a=a||window.event;!IDE&&-1<[32,37,38,39,40].indexOf(a.keyCode)&&prevent(a);0<=keybuffer.indexOf(a.keyCode)||(lastDownTarget===canvas&&-1===keybuffer.indexOf(a.keyCode)&&(keybuffer.splice(keyRepeatIndex,0,a.keyCode),keyRepeatTimer=0,checkKey(a,!0)),!0===canDump&&(74===a.keyCode&&(a.ctrlKey||a.metaKey)?(dumpTestCase(),prevent(a)):75===a.keyCode&&(a.ctrlKey||a.metaKey)&&(makeGIF(),prevent(a))))}
function relMouseCoords(a){var b=0,c=0,d=0,f=0,d=this;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop;while(d=d.offsetParent);d=a.pageX-b;f=a.pageY-c;return{x:d,y:f}}HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;function onKeyUp(a){a=a||window.event;a=keybuffer.indexOf(a.keyCode);0<=a&&(keybuffer.splice(a,1),keyRepeatIndex>=a&&keyRepeatIndex--)}function onMyFocus(a){keybuffer=[];keyRepeatTimer=keyRepeatIndex=0}
function onMyBlur(a){keybuffer=[];keyRepeatTimer=keyRepeatIndex=0}var mouseCoordX=0,mouseCoordY=0;function setMouseCoord(a){a=canvas.relMouseCoords(a);mouseCoordX=a.x-xoffset;mouseCoordY=a.y-yoffset;mouseCoordX=Math.floor(mouseCoordX/cellwidth);mouseCoordY=Math.floor(mouseCoordY/cellheight)}function mouseMove(a){levelEditorOpened&&(setMouseCoord(a),dragging?levelEditorClick(a,!1):rightdragging&&levelEditorRightClick(a,!1),redraw())}function mouseOut(){}
document.addEventListener("mousedown",onMouseDown,!1);document.addEventListener("mouseup",onMouseUp,!1);document.addEventListener("keydown",onKeyDown,!1);document.addEventListener("keyup",onKeyUp,!1);window.addEventListener("focus",onMyFocus,!1);window.addEventListener("blur",onMyBlur,!1);function prevent(a){a.preventDefault&&a.preventDefault();a.stopImmediatePropagation&&a.stopImmediatePropagation();a.stopPropagation&&a.stopPropagation();return a.returnValue=!1}
function checkKey(a,b){if(!winning){var c=-1;switch(a.keyCode){case 65:case 37:c=1;break;case 38:case 87:c=0;break;case 68:case 39:c=3;break;case 83:case 40:c=2;break;case 13:case 32:case 67:case 88:if(!1===norepeat_action||b)c=4;else return;break;case 85:case 90:if(!1===textMode)return pushInput("undo"),DoUndo(),canvasResize(),prevent(a);break;case 82:if(!1===textMode&&b)return pushInput("restart"),DoRestart(),canvasResize(),prevent(a);break;case 27:if(!1===titleScreen)return goToTitleScreen(),tryPlayTitleSound(),
canvasResize(),prevent(a);break;case 69:if(canOpenEditor)return b&&(levelEditorOpened=!levelEditorOpened,restartTarget=backupLevel(),canvasResize()),prevent(a);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&b)return c=9,49<=a.keyCode&&(c=a.keyCode-49),c<glyphImages.length?glyphSelectedIndex=c:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(a)}if(throttle_movement&&0<=c&&3>=c){if(lastinput==
c&&input_throttle_timer<repeatinterval)return;lastinput=c;input_throttle_timer=0}if(textMode){if(0!==state.levels.length)if(titleScreen)if(0===titleMode)4===c&&b&&!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize());else if(4==c&&b)!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw());else{if(0===c||2===c)titleSelection=
1-titleSelection,generateTitleScreen(),redraw()}else 4==c&&b&&(unitTesting?nextLevel():!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen()))}else if(!againing&&0<=c)return 4===c&&"noaction"in state.metadata||(pushInput(c),processInput(c)&&redraw()),prevent(a)}}
function update(){timer+=deltatime;input_throttle_timer+=deltatime;quittingTitleScreen&&0.3<timer/1E3&&(quittingTitleScreen=!1,nextLevel());againing&&timer>againinterval&&0==messagetext.length&&processInput(-1)&&(redraw(),autotick=keyRepeatTimer=0);quittingMessageScreen&&0.15<timer/1E3&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",titleScreen=textMode=!1,titleMode=0<curlevel||null!==curlevelTarget?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin()));winning&&
0.5<timer/1E3&&(winning=!1,nextLevel());if(0<keybuffer.length){keyRepeatTimer+=deltatime;var a=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);keyRepeatTimer>a&&(keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length,checkKey({keyCode:keybuffer[keyRepeatIndex]},!1))}0<autotickinterval&&!(textMode||levelEditorOpened||againing||winning)&&(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&redraw()))}
setInterval(function(){update()},deltatime);window.Mobile={};Mobile.hasTouch=function(){var a;if("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)a=!0;return a};Mobile.enable=function(a){if(a||Mobile.hasTouch()&&!Mobile._instance)Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap();return Mobile._instance};window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)};
Mobile.log=function(a){document.getElementsByTagName("h1")[0].innerHTML=""+Math.random().toString().substring(4,1)+"-"+a};Mobile.debugDot=function(a){var b;b="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+a.touches[0].clientX+"px;top: "+a.touches[0].clientY+"px;";a=document.createElement("div");a.setAttribute("style",b);document.getElementsByTagName("body")[0].appendChild(a)};
(function(a){var b={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27};a.initialize=function(){this.firstPos={x:0,y:0};this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this);this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this);this.repeatTick=this.repeatTick.bind(this);this.isFocused=!0};a.setFocusElement=function(a){this.focusElement=a;this.isFocused=!1;this.buildFocusIndicator()};a.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this));
window.addEventListener("touchend",this.onTouchEnd.bind(this));window.addEventListener("touchmove",this.onTouchMove.bind(this))};a.bootstrap=function(){this.showTab();this.isAudioSupported()||this.disableAudio();this.disableSelection()};a.onTouchStart=function(a){this.isTouching||(this.handleFocusChange(a),this.isFocused&&"A"!==a.target.tagName.toUpperCase()&&(this.mayBeSwiping=this.isTouching=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),
this.firstPos.x=a.touches[0].clientX,this.firstPos.y=a.touches[0].clientY))};a.onTouchEnd=function(a){this.isFocused&&this.isTouching&&(this.gestured||0===a.touches.length&&this.handleTap(),0===a.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))};a.onTouchMove=function(a){if(this.isFocused)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(a)):this.mayBeSwiping?this.swipeStep(a):this.isRepeating&&
this.repeatStep(a),prevent(a),!1};a.handleFocusChange=function(a){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(a),this.setFocusIndicatorVisibility(this.isFocused))};a.isTouchInsideFocusElement=function(a){var b;if(!a.touches||!a.touches[0])return!1;b=this.absoluteElementPosition(this.focusElement);return a.touches[0].clientX<b.left||a.touches[0].clientY<b.top||a.touches[0].clientX>b.left+this.focusElement.clientWidth||a.touches[0].clientY>b.top+this.focusElement.clientHeight?
!1:!0};a.setFocusIndicatorVisibility=function(a){var b;b="visible";a||(b="hidden");this.focusIndicator.setAttribute("style","visibility: "+b+";")};a.absoluteElementPosition=function(a){var b,f;b={top:a.offsetTop||0,left:a.offsetLeft||0};f=document.getElementsByTagName("body")[0];for(b.top-=f.scrollTop||0;;){a=a.offsetParent;if(!a)break;b.top+=a.offsetTop||0;b.left+=a.offsetLeft||0}return b};a.beginRepeatWatcher=function(a){var b;if(!this.repeatInterval){this.isRepeating=!0;b=1E3*state.metadata.key_repeat_interval;
if(isNaN(b)||!b)b=150;this.repeatInterval=setInterval(this.repeatTick,b);this.recenter(a)}};a.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)};a.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)};a.recenter=function(a){this.firstPos.x=a.touches[0].clientX;this.firstPos.y=a.touches[0].clientY};a.isSuccessfulSwipe=function(){var a;this.mayBeSwiping&&void 0!==this.swipeDirection&&
50<=this.swipeDistance&&(a=!0);return a};a.swipeStep=function(a){var b,f;this.mayBeSwiping&&((b={x:a.touches[0].clientX,y:a.touches[0].clientY},f=(new Date).getTime(),a=a.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,b),this.swipeDirection)?1E3<f-this.startTime&&(this.mayBeSwiping=!1):10<this.swipeDistance&&(this.swipeDirection=this.dominantDirection(this.firstPos,b),this.touchCount=a))};a.repeatStep=function(a){var b;b={x:a.touches[0].clientX,y:a.touches[0].clientY};50<=this.cardinalDistance(this.firstPos,
b)&&(this.swipeDirection=this.dominantDirection(this.firstPos,b),this.recenter(a))};a.cardinalDistance=function(a,b){var f,g;f=Math.abs(a.x-b.x);g=Math.abs(a.y-b.y);return Math.max(f,g)};a.dominantDirection=function(a,b){var f,g,h;f=b.x-a.x;g=b.y-a.y;h="x";Math.abs(g)>Math.abs(f)&&(h="y");return"x"===h?0<f?"right":"left":0<g?"down":"up"};a.handleSwipe=function(a,b){1===b?this.emitKeydown(this.swipeDirection):1<b&&this.toggleMenu()};a.handleTap=function(){this.emitKeydown("action")};a.emitKeydown=
function(a){a={keyCode:b[a]};this.fakeCanvasFocus();onKeyDown(a);onKeyUp(a)};a.fakeCanvasFocus=function(){var a;a=document.getElementById("gameCanvas");onMouseDown({button:0,target:a})};a.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()};a.showMenu=function(){this.menuElem||this.buildMenu();this.getAnimatables().menu.animateUp();this.isMenuVisible=!0;this.hideTab()};a.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown();this.isMenuVisible=!1;this.showTab()};
a.getAnimatables=function(){this._animatables||(this._animatables={tab:Animatable("tab",0.1,this.setTabAnimationRatio),menu:Animatable("menu",0.1,this.setMenuAnimationRatio)});return this._animatables};a.showTab=function(){this.tabElem||this.buildTab();this.getAnimatables().tab.animateDown()};a.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;");this.getAnimatables().tab.animateUp()};a.buildTab=function(){var a=this,b,f;b=document.createElement("div");b.innerHTML=
'<div class="tab">\n  <div class="tab-affordance"></div>\n  <div class="tab-icon">\n    <div class="slice"></div>\n    <div class="slice"></div>\n  </div>\n</div>';f=b.children[0];b=function(b){b.stopPropagation();a.showMenu()};this.tabAffordance=f.getElementsByClassName("tab-affordance")[0];this.tabElem=f.getElementsByClassName("tab-icon")[0];this.tabAffordance.addEventListener("touchstart",b);this.tabElem.addEventListener("touchstart",b);document.getElementsByTagName("body")[0].appendChild(f)};
a.buildMenu=function(){var a=this,b,f;b=document.createElement("div");b.innerHTML=this.buildMenuString(state);this.menuElem=b.children[0];this.closeElem=this.menuElem.getElementsByClassName("close")[0];f=function(b){b.stopPropagation();a.hideMenu()};this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0];b=this.menuElem.getElementsByClassName("close")[0];this.closeAffordance.addEventListener("touchstart",f);b.addEventListener("touchstart",f);(b=this.menuElem.getElementsByClassName("undo")[0])&&
b.addEventListener("touchstart",function(b){b.stopPropagation();a.emitKeydown("undo")});(b=this.menuElem.getElementsByClassName("restart")[0])&&b.addEventListener("touchstart",function(b){b.stopPropagation();a.emitKeydown("restart")});this.menuElem.getElementsByClassName("quit")[0].addEventListener("touchstart",function(b){b.stopPropagation();a.emitKeydown("quit")});document.getElementsByTagName("body")[0].appendChild(this.menuElem)};a.buildMenuString=function(a){var b,f;f=a.metadata.noundo;a=a.metadata.norestart;
b=3;f&&(b-=1);a&&(b-=1);b=['<div class="mobile-menu item-count-'+b+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"];f||b.push('  <div class="undo button">Undo</div>');a||b.push('  <div class="restart button">Restart</div>');b=b.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"]);return b.join("\n")};a.buildFocusIndicator=function(){this.focusIndicator=document.createElement("DIV");
this.focusIndicator.setAttribute("class","tapFocusIndicator");this.focusIndicator.setAttribute("style","visibility: hidden;");this.focusElement.parentNode.appendChild(this.focusIndicator)};a.setTabAnimationRatio=function(a){a=Math.round(1E3*a)/1E3;0.999<=a?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;");this.tabElem.setAttribute("style","opacity: "+(1-a)+"; width: "+(66*a+18*(1-a))+"px;")};a.setMenuAnimationRatio=function(a){var b;
a=Math.round(1E3*a)/1E3;0.001>=a?this.closeAffordance.setAttribute("style","display: none;"):this.closeAffordance.setAttribute("style","display: block;");b=-18*a+-66*(1-a);a="opacity: "+a+";";this.closeElem.setAttribute("style","left: "+(b-4)+"px; "+a+" width: "+-b+"px;");this.menuElem.setAttribute("style",a)};a.disableAudio=function(){window.playSeed=function(){}};a.isAudioSupported=function(){var a=!0;webkitAudioContext&&(a=!1);return a};a.disableSelection=function(){var a;a=document.getElementsByTagName("body")[0];
a.setAttribute("class",a.getAttribute("class")+" disable-select")}})(window.Mobile.GestureHandler.prototype);window.Animator=function(){this.initialize.apply(this,arguments)};
(function(a){a.initialize=function(){this._animations={};this.tick=this.tick.bind(this)};a.animate=function(a,c){this._animations[a]=c;this.wakeup()};a.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())};a.tick=function(){var a,c,d,f;f=[];d=!0;for(a in this._animations){if(!this._animations.hasOwnProperty(a))return;(c=this._animations[a]())?f.push(a):d=!1}if(d){for(;0<f.length;f++)delete this._isAnimating[f[0]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}})(window.Animator.prototype);
window.Animator.getInstance=function(){window.Animator._instance||(window.Animator._instance=new window.Animator);return window.Animator._instance};function Animatable(a,b,c){function d(){var a;g+=b;1<=g&&(a=!0,g=1);c(g);return a}function f(){var a;g-=b;0>=g&&(a=!0,g=0);c(g);return a}var g;g=0;return{animateUp:function(){Animator.getInstance().animate(a,d)},animateDown:function(){Animator.getInstance().animate(a,f)}}}
(function(){var a=["ms","moz","webkit","o"],b,c;for(b=0;b<a.length&&!window.requestAnimationFrame;b++)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[b]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[a[b]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(c=0,window.requestAnimationFrame=function(a,b){var g,h,k;g=(new Date).getTime();h=Math.max(0,16-(g-c));k=window.setTimeout(function(){a(g+
h)},h);c=g+h;return k});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();
